

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  
    <meta name="description" content="记录Java秒杀系统的设计与实现">
  
  <meta name="author" content="醉心">
  <meta name="keywords" content="">
  
  <title>Java秒杀系统 - 醉心的博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>醉心</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Java秒杀系统">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-01-28 21:35" pubdate>
        2021年1月28日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      16.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      253
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Java秒杀系统</h1>
            
            <div class="markdown-body">
              <h1 id="1-项目框架搭建"><a href="#1-项目框架搭建" class="headerlink" title="1. 项目框架搭建"></a>1. 项目框架搭建</h1><h2 id="1-1-配置SpringBoot"><a href="#1-1-配置SpringBoot" class="headerlink" title="1.1 配置SpringBoot"></a>1.1 配置SpringBoot</h2><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>编写启动类（放在与其它包同名目录下）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><span class="hljs-comment">// same as @Configuration @EnableAutoConfiguration @ComponentScan</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(MainApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SampleController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    UserService userService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    RedisService redisService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/thymeleaf&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">thymeleaf</span><span class="hljs-params">(Model model)</span></span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;shuaiyun&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/db/get&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title">dbGet</span><span class="hljs-params">()</span></span>&#123;<br>        User user = userService.getById(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> Result.success(user);<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/redis/get&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title">redisGet</span><span class="hljs-params">()</span></span>&#123;<br>        redisService.get<br>        <span class="hljs-keyword">return</span> Result.success(user);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    UserDao userDao;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userDao.getById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDao</span> </span>&#123;<br><br>    <span class="hljs-meta">@Select(&quot;select * from user where id = #&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="1-2-配置Mybatis"><a href="#1-2-配置Mybatis" class="headerlink" title="1.2 配置Mybatis"></a>1.2 配置Mybatis</h2><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># mybatis</span><br><span class="hljs-meta">mybatis.type-aliases-package</span>=<span class="hljs-string">com.mooc.miaosha.domain</span><br><span class="hljs-meta">mybatis.configuration.map-underscore-to-camel-case</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">mybatis.configuration.default-fetch-size</span>=<span class="hljs-string">100</span><br><span class="hljs-meta">mybatis.configuration.default-statement-timeout</span>=<span class="hljs-string">3000</span><br><span class="hljs-meta">mybatis.mapperLocations</span> = <span class="hljs-string">classpath:com/mooc/miaosha/dao/*.xml</span><br><span class="hljs-comment"># druid</span><br><span class="hljs-meta">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/miaosha?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false</span><br><span class="hljs-comment">#spring.datasource.url=jdbc:mysql://192.168.120.7:3306/miaosha?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false</span><br><span class="hljs-meta">spring.datasource.druid.username</span>=<span class="hljs-string">root</span><br><span class="hljs-meta">spring.datasource.druid.password</span>=<span class="hljs-string">shuaiyun</span><br><span class="hljs-meta">spring.datasource.druid.driver-class-name</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-meta">spring.datasource.type</span>=<span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br><span class="hljs-meta">spring.datasource.druid.filters</span>=<span class="hljs-string">stat</span><br><span class="hljs-meta">spring.datasource.druid.max-active</span>=<span class="hljs-string">100</span><br><span class="hljs-meta">spring.datasource.druid.initial-size</span>=<span class="hljs-string">50</span><br><span class="hljs-meta">spring.datasource.druid.max-wait</span>=<span class="hljs-string">60000</span><br><span class="hljs-meta">spring.datasource.druid.min-idle</span>=<span class="hljs-string">1</span><br><span class="hljs-meta">spring.datasource.druid.time-between-eviction-runs-millis</span>=<span class="hljs-string">60000</span><br><span class="hljs-meta">spring.datasource.druid.min-evictable-idle-time-millis</span>=<span class="hljs-string">300000</span><br><span class="hljs-meta">spring.datasource.druid.validation-query</span>=<span class="hljs-string">select &#x27;x&#x27;</span><br><span class="hljs-meta">spring.datasource.druid.test-while-idle</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">spring.datasource.druid.test-on-borrow</span>=<span class="hljs-string">false</span><br><span class="hljs-meta">spring.datasource.druid.test-on-return</span>=<span class="hljs-string">false</span><br><span class="hljs-meta">spring.datasource.druid.pool-prepared-statements</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">spring.datasource.druid.max-open-prepared-statements</span>=<span class="hljs-string">20</span><br></code></pre></td></tr></table></figure>
<p>在dao中使用注解</p>
<h2 id="1-3-配置Redis"><a href="#1-3-配置Redis" class="headerlink" title="1.3 配置Redis"></a>1.3 配置Redis</h2><p>在centos上安装redis</p>
<p>先跳转到相应目录</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/usr/</span>leyou<span class="hljs-regexp">/redis/</span>bin<br></code></pre></td></tr></table></figure>
<p>以指定配置文件启动：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">redis</span></span>-server ../redis.conf<br></code></pre></td></tr></table></figure>
<p>若没有密码可设置密码</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">客户端登录：<br>redis-cli<br>客户端使用config get requirepass命令查看密码：<br>config get requirepass<br>客户端使用config set requirepass yourpassword命令设置密码：<br>config set requirepass <span class="hljs-number">123456</span><br>进入utils文件夹运行install_server.sh分别配置启动文件，日志文件，数据存放目录：<br><span class="hljs-regexp">/usr/</span>leyou<span class="hljs-regexp">/redis/</span>redis.conf<br><span class="hljs-regexp">/usr/</span>leyou<span class="hljs-regexp">/redis/</span>redis.log<br><span class="hljs-regexp">/usr/</span>leyou<span class="hljs-regexp">/redis/</span>data<br></code></pre></td></tr></table></figure>
<p>引入jedis和fastjson依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">##redis</span><br><span class="hljs-meta">redis.host</span>=<span class="hljs-string">192.168.120.7</span><br><span class="hljs-meta">redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-meta">redis.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-meta">redis.timeout</span>=<span class="hljs-string">100</span><br><span class="hljs-meta">redis.poolMaxTotal</span>=<span class="hljs-string">1000</span><br><span class="hljs-meta">redis.poolMaxIdle</span>=<span class="hljs-string">500</span><br><span class="hljs-meta">redis.poolMaxWait</span>=<span class="hljs-string">500</span><br></code></pre></td></tr></table></figure>
<p>教程的配置文件如上，但会报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">redis<span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.jedis</span><span class="hljs-selector-class">.exceptions</span><span class="hljs-selector-class">.JedisConnectionException</span>: Could not get <span class="hljs-selector-tag">a</span> resource from the pool<br>at redis<span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Pool</span>.getResource(Pool<span class="hljs-selector-class">.java</span>:<span class="hljs-number">22</span>)<br>at Workers<span class="hljs-selector-class">.Worker1</span>.met1(Worker1<span class="hljs-selector-class">.java</span>:<span class="hljs-number">124</span>)<br>at Workers<span class="hljs-selector-class">.Worker1</span>.work(Worker1<span class="hljs-selector-class">.java</span>:<span class="hljs-number">108</span>)<br>at org<span class="hljs-selector-class">.gearman</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.worker</span>.WorkerConnectionController$<span class="hljs-number">3</span>.run(Unknown Source)<br>at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.ThreadPoolExecutor</span>.runWorker(Unknown Source)<br>at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span>.ThreadPoolExecutor<span class="hljs-variable">$Worker</span>.run(Unknown Source)<br>at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span>.run(Unknown Source)  <br></code></pre></td></tr></table></figure>
<p>并且properties文件提示无法解析，修改为：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">spring.redis.host</span>=<span class="hljs-string">192.168.120.7</span><br><span class="hljs-meta">spring.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-meta">spring.redis.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-meta">spring.redis.timeout</span>=<span class="hljs-string">100</span><br><span class="hljs-meta">spring.redis.poolMaxTotal</span>=<span class="hljs-string">1000</span><br><span class="hljs-meta">spring.redis.poolMaxIdle</span>=<span class="hljs-string">500</span><br><span class="hljs-meta">spring.redis.poolMaxWait</span>=<span class="hljs-string">500</span><br></code></pre></td></tr></table></figure>
<p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;spring.redis&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisConfig</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String host;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> port;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> timeout;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> poolMaxTotal;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> poolMaxIdle;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> poolMaxWait;<br>    <span class="hljs-comment">//getter和setter</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写方法返回连接池对象并且注入到容器,使用@Bean注解并且返回JedisPool对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisPoolFactory</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    RedisConfig redisConfig;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> JedisPool <span class="hljs-title">jedisPoolFactory</span><span class="hljs-params">()</span></span>&#123;<br>        JedisPoolConfig poolConfig = <span class="hljs-keyword">new</span> JedisPoolConfig();<br>        poolConfig.setMaxTotal(redisConfig.getPoolMaxTotal());<br>        poolConfig.setMaxIdle(redisConfig.getPoolMaxIdle());<br>        poolConfig.setMaxWaitMillis(redisConfig.getPoolMaxWait() * <span class="hljs-number">1000</span>);<br>        JedisPool jp = <span class="hljs-keyword">new</span> JedisPool(poolConfig, redisConfig.getHost(), redisConfig.getPort(), redisConfig.getTimeout()*<span class="hljs-number">1000</span>, redisConfig.getPassword(),<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> jp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写redisService</p>
<p>向redis中存数据使用String，格式是key-value</p>
<p>因此存放时要将value转换为String类型，取出时将String转换为普通类，这一过程使用了fastjson进行转换，还要使用泛型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JedisPool jedisPool;<span class="hljs-comment">//容器中已经被注入</span><br><br>    <span class="hljs-comment">//获取redis数据</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">get</span><span class="hljs-params">(String key,Class&lt;T&gt; clazz)</span></span>&#123;<br>        Jedis jedis = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            jedis = jedisPool.getResource();<br>            <span class="hljs-comment">//生成真正的key</span><br>            <span class="hljs-comment">//String realkey = prefix.getPrefix() + key;</span><br>            <span class="hljs-comment">//String str = jedis.get(realkey);</span><br>            String str = jedis.get(key);<br>            T t = stringToBean(str,clazz);<br>            <span class="hljs-keyword">return</span> t;<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            returnToPool(jedis);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//向redis中添加数据</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">set</span><span class="hljs-params">(String key,T value)</span></span>&#123;<br>        Jedis jedis = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            jedis = jedisPool.getResource();<br>            String str = beanToString(value);<br>            <span class="hljs-keyword">if</span> (str == <span class="hljs-keyword">null</span> || str.length() &lt;= <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            //生成真正的key</span><br><span class="hljs-comment">            String realkey = prefix.getPrefix() + key;</span><br><span class="hljs-comment">            int seconds = prefix.expireSeconds();</span><br><span class="hljs-comment">            if (seconds &lt;= 0) &#123;</span><br><span class="hljs-comment">                jedis.set(realkey, str);</span><br><span class="hljs-comment">            &#125; else &#123;</span><br><span class="hljs-comment">            	//setex设置过期时间</span><br><span class="hljs-comment">                jedis.setex(realkey, seconds, str);</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">            return true;</span><br><span class="hljs-comment">            */</span><br>            jedis.set(key,str);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            returnToPool(jedis);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//将value转换为基本数据类型或json（对象转换为json）</span><br>    <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-function">String <span class="hljs-title">beanToString</span><span class="hljs-params">(T value)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(value == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">//?泛型通配符</span><br>        Class&lt;?&gt; clazz = value.getClass();<br>        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">int</span>.class || clazz == Integer.class)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>+value;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == String.class)&#123;<br>            <span class="hljs-keyword">return</span> (String)value;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">long</span>.class || clazz == Long.class)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>+value;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> JSON.toJSONString(value);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//将json转换为基础数据类型或普通类</span><br>    <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">stringToBean</span><span class="hljs-params">(String str,Class&lt;T&gt; clazz)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (str == <span class="hljs-keyword">null</span> || str.length() &lt;= <span class="hljs-number">0</span> || clazz == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">int</span>.class || clazz == Integer.class)&#123;<br>            <span class="hljs-keyword">return</span> (T)Integer.valueOf(str);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == String.class)&#123;<br>            <span class="hljs-keyword">return</span> (T) str;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">long</span>.class || clazz == Long.class)&#123;<br>            <span class="hljs-keyword">return</span> (T)Long.valueOf(str);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> JSON.toJavaObject(JSON.parseObject(str),clazz);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//归还redis连接池连接</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">returnToPool</span><span class="hljs-params">(Jedis jedis)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(jedis != <span class="hljs-keyword">null</span>)&#123;<br>            jedis.close();<br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>现在还有问题，随着项目中的模块越来越多，需要的缓存也越来越多，如商品id，订单id，用户id等，此时若是id出现重复，将给系统带来错误。解决方法是利用一个前缀来规定不同模块的缓存的key，这样不同模块之间就不会重复。</p>
<p>增加前缀使用设计模式<strong>模板方法模式</strong>编写，即</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ada">接口<span class="hljs-comment">------KeyPrefix</span><br>|<br>抽象类<span class="hljs-comment">-----BasePrefix</span><br>|<br>实现类 <span class="hljs-comment">-----UserKey</span><br></code></pre></td></tr></table></figure>
<p>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">KeyPrefix</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">expireSeconds</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPrefix</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>抽象类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasePrefix</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">KeyPrefix</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> expireSeconds;<br><br>    <span class="hljs-keyword">private</span> String prefix;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BasePrefix</span><span class="hljs-params">(String prefix)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>(<span class="hljs-number">0</span>,prefix);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BasePrefix</span><span class="hljs-params">(<span class="hljs-keyword">int</span> expireSeconds,String prefix)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.expireSeconds = expireSeconds;<br>        <span class="hljs-keyword">this</span>.prefix = prefix;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">expireSeconds</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-comment">//默认0代表永不过期</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPrefix</span><span class="hljs-params">()</span> </span>&#123;<br>        String className = getClass().getSimpleName();<br>        <span class="hljs-keyword">return</span> className + <span class="hljs-string">&quot;:&quot;</span> + prefix;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasePrefix</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">UserKey</span><span class="hljs-params">(String prefix)</span></span>&#123;<br>        <span class="hljs-keyword">super</span>(prefix);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">UserKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> expireSeconds,String prefix)</span></span>&#123;<br>        <span class="hljs-keyword">super</span>(expireSeconds, prefix);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserKey getById = <span class="hljs-keyword">new</span> UserKey(<span class="hljs-string">&quot;id&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserKey getByName = <span class="hljs-keyword">new</span> UserKey(<span class="hljs-string">&quot;name&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>修改原有的service类，在set或get之前加上前缀。</p>
<p>编写完成后的测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/redis/set&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Boolean&gt; <span class="hljs-title">redisSet</span><span class="hljs-params">()</span></span>&#123;<br>       User user = <span class="hljs-keyword">new</span> User();<br>       user.setId(<span class="hljs-number">1</span>);<br>       user.setName(<span class="hljs-string">&quot;1111&quot;</span>);<br>       redisService.set(UserKey.getById,<span class="hljs-string">&quot;&quot;</span> + <span class="hljs-number">1</span>,user);<br>       <span class="hljs-keyword">return</span> Result.success(<span class="hljs-keyword">true</span>);<br>   &#125;<br>   <br>   <span class="hljs-meta">@RequestMapping(&quot;/redis/get&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title">redisGet</span><span class="hljs-params">()</span></span>&#123;<br>       User user = redisService.get(UserKey.getById,<span class="hljs-string">&quot;1&quot;</span>,User.class);<br>       <span class="hljs-keyword">return</span> Result.success(user);<br>   &#125;<br></code></pre></td></tr></table></figure>
<h1 id="2-实现登录功能"><a href="#2-实现登录功能" class="headerlink" title="2. 实现登录功能"></a>2. 实现登录功能</h1><h2 id="2-1-数据库设计"><a href="#2-1-数据库设计" class="headerlink" title="2.1 数据库设计"></a>2.1 数据库设计</h2><p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `miaosha_user` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;用户ID，手机号码&#x27;</span>,<br>  `nickname` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;MD5(MD5(pass明文+固定salt) + salt)&#x27;</span>,<br>  `salt` <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `head` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;头像，云存储的ID&#x27;</span>,<br>  `register_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;注册时间&#x27;</span>,<br>  `last_login_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上蔟登录时间&#x27;</span>,<br>  `login_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;登录次数&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">18912341236</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci<br></code></pre></td></tr></table></figure>
<h2 id="2-2-密码两次MD5处理"><a href="#2-2-密码两次MD5处理" class="headerlink" title="2.2 密码两次MD5处理"></a>2.2 密码两次MD5处理</h2><p>编写MD5加密类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MD5Util</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">md5</span><span class="hljs-params">(String src)</span></span>&#123;<br>        <span class="hljs-comment">//DigestUtils工具类中的md5Hex方法能够进行md5加密</span><br>        <span class="hljs-keyword">return</span> DigestUtils.md5Hex(src);<br>    &#125;<br><br>    <span class="hljs-comment">//设置salt值</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String salt = <span class="hljs-string">&quot;1a2b3c4d&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">inputPassToFormPass</span><span class="hljs-params">(String inputPass)</span></span>&#123;<br>        <span class="hljs-comment">//第一次加密，将输入数据加密传输</span><br>        String str = <span class="hljs-string">&quot;&quot;</span> + salt.charAt(<span class="hljs-number">0</span>) + salt.charAt(<span class="hljs-number">2</span>) + inputPass + salt.charAt(<span class="hljs-number">5</span>) + salt.charAt(<span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">return</span> md5(str);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">formPassToDBPass</span><span class="hljs-params">(String formPass,String salt)</span></span>&#123;<br>        <span class="hljs-comment">//第二次加密，将传输得到数据进行加密存储</span><br>        String str = <span class="hljs-string">&quot;&quot;</span> + salt.charAt(<span class="hljs-number">0</span>) + salt.charAt(<span class="hljs-number">2</span>) + formPass + salt.charAt(<span class="hljs-number">5</span>) + salt.charAt(<span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">return</span> md5(str);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">inputPassToDbPass</span><span class="hljs-params">(String input,String saltDB)</span></span>&#123;<br>        String formPass = inputPassToFormPass(input);<br>        String dbPass = formPassToDBPass(formPass,saltDB);<br>        <span class="hljs-keyword">return</span> dbPass;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(inputPassToDbPass(<span class="hljs-string">&quot;123456&quot;</span>, <span class="hljs-string">&quot;1a2b3c4d&quot;</span> ));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>判断手机号格式是否正确</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidatorUtil</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Pattern mobile_pattern = Pattern.compile(<span class="hljs-string">&quot;1\\d&#123;10&#125;&quot;</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isMobile</span><span class="hljs-params">(String src)</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(src))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        Matcher m = mobile_pattern.matcher(src);<br>        <span class="hljs-keyword">return</span> m.matches();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(isMobile(<span class="hljs-string">&quot;18844223196&quot;</span>));<br>        System.out.println(isMobile(<span class="hljs-string">&quot;10086&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写CodeMsg，统一封装返回信息，用于封装错误信息，错误状态码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CodeMsg</span> </span>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> code;<br>	<span class="hljs-keyword">private</span> String msg;<br>	<br>	<span class="hljs-comment">//通用异常</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg SUCCESS = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;success&quot;</span>);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg SERVER_ERROR = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">500100</span>, <span class="hljs-string">&quot;服务端异常&quot;</span>);<br>	<span class="hljs-comment">//登录模块 5002XX</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg SESSION_ERROR = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">500210</span>, <span class="hljs-string">&quot;Session不存在或已失效&quot;</span>);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg PASSWORD_EMPTY = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">500211</span>, <span class="hljs-string">&quot;登陆密码不能为空&quot;</span>);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg MOBILE_EMPTY = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">500212</span>, <span class="hljs-string">&quot;手机号不能为空&quot;</span>);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg MOBILE_ERROR = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">500213</span>, <span class="hljs-string">&quot;手机号格式错误&quot;</span>);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg MOBILE_NOT_EXIST = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">500214</span>, <span class="hljs-string">&quot;手机号不存在&quot;</span>);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CodeMsg PASSWORD_ERROR = <span class="hljs-keyword">new</span> CodeMsg(<span class="hljs-number">500215</span>, <span class="hljs-string">&quot;密码错误&quot;</span>);<br>	<span class="hljs-comment">//商品模块 5003XX</span><br>	<br>	<span class="hljs-comment">//订单模块 5004XX</span><br>	<br>	<span class="hljs-comment">//秒杀模块 5005XX</span><br>	<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">CodeMsg</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, String msg)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.code = code;<br>		<span class="hljs-keyword">this</span>.msg = msg;<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getCode</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> code;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMsg</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> msg;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写登录界面的实体类（仅用于接收登录界面参数）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginVo</span> </span>&#123;<br><br>    <span class="hljs-comment">//用于进行登录校验的实体类</span><br>    <span class="hljs-keyword">private</span> String mobile;<br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-comment">//getter and setter</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;LoginVo&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;mobile=&#x27;&quot;</span> + mobile + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, password=&#x27;&quot;</span> + password + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写登录数据库对应实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiaoshaUser</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String nickname;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> String salt;<br>    <span class="hljs-keyword">private</span> String head;<br>    <span class="hljs-keyword">private</span> Date registerDate;<br>    <span class="hljs-keyword">private</span> Date lastLoginDate;<br>    <span class="hljs-keyword">private</span> Integer loginCount;<br><br>    <span class="hljs-comment">//getter and setter</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写MiaoshaUserDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MiaoshaUserDao</span> </span>&#123;<br><br>    <span class="hljs-meta">@Select(&quot;select * from miaosha_user where id = #&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaUser <span class="hljs-title">getById</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;id&quot;)</span>Long id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写MiaoshaUserService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiaoshaUserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MiaoshaUserDao miaoshaUserDao;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaUser <span class="hljs-title">getById</span><span class="hljs-params">(Long id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> miaoshaUserDao.getById(id);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> CodeMsg <span class="hljs-title">login</span><span class="hljs-params">(LoginVo loginVo)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(loginVo == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> CodeMsg.SERVER_ERROR;<br>        &#125;<br>        String mobile = loginVo.getMobile();<br>        String formPass = loginVo.getPassword();<br>        <span class="hljs-comment">//查询user</span><br>        MiaoshaUser user = getById(Long.parseLong(mobile));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> CodeMsg.MOBILE_NOT_EXIST;<br>        &#125;<br>        <span class="hljs-comment">//验证密码</span><br>        String dbPass = user.getPassword();<br>        String saltDB = user.getSalt();<br>        <span class="hljs-comment">//前端已经做过一次md5加密</span><br>        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);<br>        <span class="hljs-keyword">if</span> (!calcPass.equals(dbPass))&#123;<br>            <span class="hljs-keyword">return</span> CodeMsg.PASSWORD_ERROR;<br>        &#125;<br>        <span class="hljs-keyword">return</span> CodeMsg.SUCCESS;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写登录Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/login&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginController</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger log = LoggerFactory.getLogger(LoginController.class);<br><br>    <span class="hljs-meta">@Autowired</span><br>    MiaoshaUserService userService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/to_login&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toLogin</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/do_login&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;CodeMsg&gt; <span class="hljs-title">doLogin</span><span class="hljs-params">(LoginVo loginVo)</span></span>&#123;<br>        <span class="hljs-comment">//记录日志信息</span><br>        log.info(loginVo.toString());<br>        <span class="hljs-comment">//参数校验</span><br>        String passInput = loginVo.getPassword();<br>        String mobile = loginVo.getMobile();<br>        <span class="hljs-comment">//校验密码输入是否为空</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(passInput))&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.PASSWORD_EMPTY);<br>        &#125;<br>        <span class="hljs-comment">//校验手机号输入是否为空</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(mobile))&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.MOBILE_EMPTY);<br>        &#125;<br>        <span class="hljs-comment">//校验手机号格式</span><br>        <span class="hljs-keyword">if</span>(!ValidatorUtil.isMobile(mobile))&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.MOBILE_ERROR);<br>        &#125;<br>        <span class="hljs-comment">//登录并返回 返回信息</span><br>        CodeMsg cm = userService.login(loginVo);<br>        <span class="hljs-keyword">if</span> (cm.getCode() == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.success(CodeMsg.SUCCESS);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> Result.error(cm);<br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="2-3-JSR303参数检验-全局异常处理器"><a href="#2-3-JSR303参数检验-全局异常处理器" class="headerlink" title="2.3 JSR303参数检验+全局异常处理器"></a>2.3 JSR303参数检验+全局异常处理器</h2><h3 id="2-3-1-JSR303参数检验"><a href="#2-3-1-JSR303参数检验" class="headerlink" title="2.3.1 JSR303参数检验"></a>2.3.1 JSR303参数检验</h3><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>使用validation可通过注解对参数进行检验，参数传入时可进行检验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/do_login&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;CodeMsg&gt; <span class="hljs-title">doLogin</span><span class="hljs-params">(<span class="hljs-meta">@Valid</span> LoginVo loginVo)</span></span>&#123;<br>    <br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>LoginVo可改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginVo</span> </span>&#123;<br><br>    <span class="hljs-comment">//用于接收登录参数的实体类</span><br><br>    <span class="hljs-meta">@NotNull</span><br>    <span class="hljs-meta">@IsMobile</span><br>    <span class="hljs-keyword">private</span> String mobile;<br><br>    <span class="hljs-meta">@NotNull</span><br>    <span class="hljs-meta">@Length(min = 32)</span><br>    <span class="hljs-keyword">private</span> String password;<br></code></pre></td></tr></table></figure>
<p>其中@IsMobile需要自定义，可点开@NotNull参考</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@java</span>.lang.annotation.Target(&#123;java.lang.annotation.ElementType.METHOD, java.lang.annotation.ElementType.FIELD, java.lang.annotation.ElementType.ANNOTATION_TYPE, java.lang.annotation.ElementType.CONSTRUCTOR, java.lang.annotation.ElementType.PARAMETER, java.lang.annotation.ElementType.TYPE_USE&#125;)<br><span class="hljs-meta">@java</span>.lang.annotation.Retention(java.lang.annotation.RetentionPolicy.RUNTIME)<br><span class="hljs-meta">@java</span>.lang.annotation.Documented<br><span class="hljs-meta">@javax</span>.validation.Constraint(validatedBy = &#123;IsMobileValidator.class&#125;)<br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> IsMobile &#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">required</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">true</span></span>;<br><br>    java.lang.<span class="hljs-function">String <span class="hljs-title">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> &quot;手机号码格式有误&quot;</span>;<br><br>    java.lang.Class&lt;?&gt;[] groups() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    java.lang.Class&lt;? extends javax.validation.Payload&gt;[] payload() <span class="hljs-keyword">default</span> &#123;&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写IsMobileValidator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IsMobileValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ConstraintValidator</span>&lt;<span class="hljs-title">IsMobile</span>, <span class="hljs-title">String</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> required = <span class="hljs-keyword">false</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">(IsMobile constraintAnnotation)</span> </span>&#123;<br>        required = constraintAnnotation.required();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">(String value, ConstraintValidatorContext context)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (required)&#123;<br>            <span class="hljs-keyword">return</span> ValidatorUtil.isMobile(value);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (StringUtils.isEmpty(value))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> ValidatorUtil.isMobile(value);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>原来登录中的参数校验逻辑可以删除</p>
<h3 id="2-3-2-全局异常处理"><a href="#2-3-2-全局异常处理" class="headerlink" title="2.3.2 全局异常处理"></a>2.3.2 全局异常处理</h3><p>参数校验只替代了原有代码的校验功能，但没有返回相关的异常信息，当校验出现问题时抛出的异常信息应该得到处理。实现方式是实现一个全局的拦截器，这要用到注解@ControllerAdvice，可以处理所有的controller方法抛出的异常</p>
<p>在该类中，可以定义多个方法，不同的方法处理不同的异常，例如专门处理空指针的方法、专门处理数组越界的方法…，也可以在一个方法中处理所有的异常信息。</p>
<p>@ExceptionHandler 注解用来指明异常的处理类型，即如果这里指定为 NullpointerException，则数组越界异常就不会进到这个方法中来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ControllerAdvice</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GlobleExceptionHandler</span> </span>&#123;<br><br>    <span class="hljs-comment">//指定当前方法处理Exception类</span><br>    <span class="hljs-meta">@ExceptionHandler(value = Exception.class)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title">exceptionHandler</span><span class="hljs-params">(HttpServletRequest request,Exception e)</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BindException)&#123;<br>            <span class="hljs-comment">//如果当前异常属于绑定异常，将绑定异常的错误信息打印</span><br>            <span class="hljs-comment">//instanceof是Java中的二元运算符，左边是对象，右边是类；当对象是右边类或子类所创建对象时，返回true；否则，返回false。</span><br>            BindException ex = (BindException)e;<br>            List&lt;ObjectError&gt; errors = ex.getAllErrors();<br>            ObjectError error = errors.get(<span class="hljs-number">0</span>);<br><br>            String msg = error.getDefaultMessage();<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.BIND_ERROR.fillArgs(msg));<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//否则报服务器异常</span><br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.SERVER_ERROR);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>当前还存在一些问题，在MiaoshaUserService中login()方法对登录参数进行数据库校验的时候，返回的类是CodeMsg，我们通常不直接返回错误状态信息，而是返回与登录密切相关的语义即登录失败还是成功，原代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> CodeMsg <span class="hljs-title">login</span><span class="hljs-params">(LoginVo loginVo)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(loginVo == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> CodeMsg.SERVER_ERROR;<br>        &#125;<br>        String mobile = loginVo.getMobile();<br>        String formPass = loginVo.getPassword();<br>        <span class="hljs-comment">//查询user</span><br>        MiaoshaUser user = getById(Long.parseLong(mobile));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> CodeMsg.MOBILE_NOT_EXIST;<br>        &#125;<br>        <span class="hljs-comment">//验证密码</span><br>        String dbPass = user.getPassword();<br>        String saltDB = user.getSalt();<br>        <span class="hljs-comment">//前端已经做过一次md5加密</span><br>        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);<br>        <span class="hljs-keyword">if</span> (!calcPass.equals(dbPass))&#123;<br>            <span class="hljs-keyword">return</span> CodeMsg.PASSWORD_ERROR;<br>        &#125;<br>        <span class="hljs-keyword">return</span> CodeMsg.SUCCESS;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">login</span><span class="hljs-params">(LoginVo loginVo)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(loginVo == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlobleException(CodeMsg.SERVER_ERROR);<br>        &#125;<br>        String mobile = loginVo.getMobile();<br>        String formPass = loginVo.getPassword();<br>        <span class="hljs-comment">//查询user</span><br>        MiaoshaUser user = getById(Long.parseLong(mobile));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlobleException(CodeMsg.MOBILE_NOT_EXIST);<br>        &#125;<br>        <span class="hljs-comment">//验证密码</span><br>        String dbPass = user.getPassword();<br>        String saltDB = user.getSalt();<br>        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);<br>        <span class="hljs-keyword">if</span> (!calcPass.equals(dbPass))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlobleException(CodeMsg.PASSWORD_ERROR);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>此时抛出异常到controller，controller的异常会被全局异常处理捕获，全局异常处理逻辑修改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ExceptionHandler(value = Exception.class)</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title">exceptionHandler</span><span class="hljs-params">(HttpServletRequest request,Exception e)</span></span>&#123;<br>       <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> GlobleException)&#123;<br>           <span class="hljs-comment">//增加处理抛出异常逻辑，即登录的参数与数据库数据对比</span><br>           GlobleException ex = (GlobleException)e;<br>           <span class="hljs-keyword">return</span> Result.error(ex.getCm());<br>       &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BindException)&#123;<br>           <span class="hljs-comment">//对参数格式校验的错误异常处理</span><br>           BindException ex = (BindException)e;<br>           List&lt;ObjectError&gt; errors = ex.getAllErrors();<br>           ObjectError error = errors.get(<span class="hljs-number">0</span>);<br><br>           String msg = error.getDefaultMessage();<br>           <span class="hljs-keyword">return</span> Result.error(CodeMsg.BIND_ERROR.fillArgs(msg));<br>       &#125;<span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">return</span> Result.error(CodeMsg.SERVER_ERROR);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>
<p>此时登录测试逻辑修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//原代码</span><br>CodeMsg cm = userService.login(loginVo);<br><span class="hljs-keyword">if</span> (cm.getCode() == <span class="hljs-number">0</span>)&#123;<br>	<span class="hljs-keyword">return</span> Result.success(CodeMsg.SUCCESS);<br>&#125;<span class="hljs-keyword">else</span> &#123;<br>	<span class="hljs-keyword">return</span> Result.error(cm);<br>&#125;<br>修改为：<br>userService.login(loginVo);<br><span class="hljs-keyword">return</span> Result.success(<span class="hljs-keyword">true</span>);<br></code></pre></td></tr></table></figure>
<h2 id="2-4-分布式Session"><a href="#2-4-分布式Session" class="headerlink" title="2.4 分布式Session"></a>2.4 分布式Session</h2><p>分布式Session一致性解决方案不止一种：</p>
<ul>
<li>session复制：从服务器角度，应用服务器开启web容器的session复制功能，在集群中的几台服务器之间同步session对象，使得每台服务器上都保存所有的session信息，这样任何一台宕机都不会导致session的数据丢失，服务器使用session时，直接从本地获取。这种方式在应用集群达到数千台的时候，就会出现瓶颈，每台都需要备份session，出现内存不够用的情况。</li>
<li>session绑定：利用hash算法，比如nginx的ip_hash,使得同一个Ip的请求分发到同一台服务器上。这种方式不符合对系统的高可用要求，因为一旦某台服务器宕机，那么该机器上的session也就不复存在了，用户请求切换到其他机器后么有session，无法完成业务处理。</li>
<li>利用cookie记录session：session记录在客户端，每次请求服务器的时候，将session放在请求中发送给服务器，服务器处理完请求后再将修改后的session响应给客户端，<strong>这里的客户端就是cookie。</strong></li>
<li>session服务器：session服务器可以解决上面的所有的问题<strong>，</strong>利用独立部署的session服务器（集群）统一管理session，服务器每次读写session时，都访问session服务器。</li>
</ul>
<p>我们使用cookie记录session。</p>
<p>修改登录逻辑，登录时存入cookie</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">login</span><span class="hljs-params">(HttpServletResponse response, LoginVo loginVo)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(loginVo == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlobleException(CodeMsg.SERVER_ERROR);<br>        &#125;<br>        String mobile = loginVo.getMobile();<br>        String formPass = loginVo.getPassword();<br>        <span class="hljs-comment">//查询user</span><br>        MiaoshaUser user = getById(Long.parseLong(mobile));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlobleException(CodeMsg.MOBILE_NOT_EXIST);<br>        &#125;<br>        <span class="hljs-comment">//验证密码</span><br>        String dbPass = user.getPassword();<br>        String saltDB = user.getSalt();<br>        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);<br>        <span class="hljs-keyword">if</span> (!calcPass.equals(dbPass))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlobleException(CodeMsg.PASSWORD_ERROR);<br>        &#125;<br>        addCookie();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addCookie</span><span class="hljs-params">(MiaoshaUser user,HttpServletResponse response)</span></span>&#123;<br>        <span class="hljs-comment">//生成cookie</span><br>        String token = UUIDUtil.uuid();<br>        redisService.set(MiaoshaUserKey.token,token,user);<br>        Cookie cookie = <span class="hljs-keyword">new</span> Cookie(COOKIE_NAME_TOKEN, token);<br>        cookie.setMaxAge(MiaoshaUserKey.token.expireSeconds());<br>        <span class="hljs-comment">//设置多应用共享</span><br>        cookie.setPath(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//使用response把生成的cookie值传回浏览器</span><br>        response.addCookie(cookie);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>其中UUIDUtil:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UUIDUtil</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">uuid</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> UUID.randomUUID().toString().replace(<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>用户登录后会进行跳转to_list（如果不登录直接进入该页面也应该持有状态），编写相关GoodsController类,作用是读取当前浏览器中的cookie值与redis中的值比较</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/goods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsController</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger log = LoggerFactory.getLogger(GoodsController.class);<br><br>    <span class="hljs-meta">@Autowired</span><br>    MiaoshaUserService userService;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/to_list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toLogin</span><span class="hljs-params">(Model model,</span></span><br><span class="hljs-function"><span class="hljs-params">                          <span class="hljs-meta">@CookieValue(value = MiaoshaUserService.COOKIE_NAME_TOKEN,required = false)</span>String cookieToken,</span></span><br><span class="hljs-function"><span class="hljs-params">                          <span class="hljs-meta">@RequestParam(value = MiaoshaUserService.COOKIE_NAME_TOKEN,required = false)</span>String paramToken)</span></span>&#123;<br>        <span class="hljs-comment">//从cookie或请求参数中取出cookie值</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(cookieToken))&#123;<br>            <span class="hljs-comment">//判断若取出的cookie值都为空返回login</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>        &#125;<br>        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;<br>        <span class="hljs-comment">//根据token取值</span><br>        MiaoshaUser user = userService.getByToken(token);<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;goods_list&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>在MiaoshaUserService中编写getByToken方法（根据token取出session值）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaUser <span class="hljs-title">getByToken</span><span class="hljs-params">(String token)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> redisService.get(MiaoshaUserKey.token,token,MiaoshaUser.class);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>其中MiaoshaUserKey：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiaoshaUserKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasePrefix</span></span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TOKEN_EXPIRE = <span class="hljs-number">3600</span> * <span class="hljs-number">24</span> * <span class="hljs-number">2</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">MiaoshaUserKey</span><span class="hljs-params">(String prefix)</span></span>&#123;<br>        <span class="hljs-keyword">super</span>(prefix);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">MiaoshaUserKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> expireSeconds,String prefix)</span></span>&#123;<br>        <span class="hljs-keyword">super</span>(expireSeconds, prefix);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MiaoshaUserKey token = <span class="hljs-keyword">new</span> MiaoshaUserKey(TOKEN_EXPIRE,<span class="hljs-string">&quot;tk&quot;</span>);<br><span class="hljs-comment">//    public static MiaoshaUserKey getByName = new MiaoshaUserKey(&quot;name&quot;);</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>现在仍然有一些问题，因为cookie的有效期是在登录时设置的，但有效期应该在最后一次访问时得到更新，即我们最后一次访问时如果cookie验证通过应该视为一次登录并使有效期得到延长。</p>
<p>因此我们在上述进行getByToken方法中查询后更新一次cookie</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaUser <span class="hljs-title">getByToken</span><span class="hljs-params">(HttpServletResponse response,String token)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        MiaoshaUser user = redisService.get(MiaoshaUserKey.token,token,MiaoshaUser.class);<br>        <span class="hljs-comment">//延长有效期</span><br>        <span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span>)&#123;<br>            addCookie(user,response);<br>        &#125;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>还可以继续优化，因为我们现在访问商品界面需要验证token，访问订单页面也需要验证token，这造成了代码的重复，因此我们定义拦截器统一验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebMvcConfigurerAdapter</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    UserArgumentResolver userArgumentResolver;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addArgumentResolvers</span><span class="hljs-params">(List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers)</span> </span>&#123;<br>        argumentResolvers.add(userArgumentResolver);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写UserArgumentResolver,这会根据当前请求中的cookie与redis中的token对比查询一个user对象并添加到request中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerMethodArgumentResolver</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MiaoshaUserService userService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> </span>&#123;<br>        Class&lt;?&gt; clazz = parameter.getParameterType();<br>        <span class="hljs-keyword">return</span> clazz == MiaoshaUser.class;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);<br>        HttpServletResponse response = webRequest.getNativeResponse(HttpServletResponse.class);<br><br><br>        String paramToken = request.getParameter(MiaoshaUserService.COOKIE_NAME_TOKEN);<br>        String cookieToken = getCookieValue(request,MiaoshaUserService.COOKIE_NAME_TOKEN);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(paramToken))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;<br>        <span class="hljs-keyword">return</span> userService.getByToken(response,token);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getCookieValue</span><span class="hljs-params">(HttpServletRequest request, String cookieName)</span> </span>&#123;<br>        Cookie[] cookies = request.getCookies();<br>        <span class="hljs-keyword">for</span> (Cookie cookie: cookies) &#123;<br>            <span class="hljs-keyword">if</span> (cookie.getName().equals(cookieName))&#123;<br>                <span class="hljs-keyword">return</span> cookie.getValue();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>改变GoodsController逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/to_list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">list</span><span class="hljs-params">(Model model,MiaoshaUser user)</span></span>&#123;<br>        <span class="hljs-comment">//拦截器已经给请求中添加了user，所以可以接收到</span><br>        <br><span class="hljs-comment">//        if (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(cookieToken))&#123;</span><br><span class="hljs-comment">//            return &quot;login&quot;;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;</span><br><span class="hljs-comment">//        MiaoshaUser user = userService.getByToken(response,token);</span><br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;goods_list&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>在编写拦截器中发现bug，其原因是登录时无法正确的设置cookie，拦截器无法debug，但可以通过sout输出相关信息，发现bug不在拦截器中，而发生在addCookie()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addCookie</span><span class="hljs-params">(String token,MiaoshaUser user,HttpServletResponse response)</span></span>&#123;<br>        redisService.set(MiaoshaUserKey.token,token,user);<br>        Cookie cookie = <span class="hljs-keyword">new</span> Cookie(COOKIE_NAME_TOKEN, token);<br>        <span class="hljs-comment">//原来expireSeconds默认设置为0，设置为0将立即删除cookie</span><br>        cookie.setMaxAge(<span class="hljs-number">3600</span> * <span class="hljs-number">12</span>);<br><span class="hljs-comment">//        cookie.setMaxAge(MiaoshaUserKey.token.expireSeconds());</span><br>        <span class="hljs-comment">//设置多应用共享</span><br>        cookie.setPath(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//使用response把生成的cookie值传回浏览器</span><br>        response.addCookie(cookie);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>原文档中说expireSeconds是永不过期，这是错误的，在redis中expireSeconds为0将立即删除数据，即存活时间为0，redis中不设置过期时间就是永不过期，但我们修改了逻辑使expireSeconds为0永不过期：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">int</span> seconds = prefix.expireSeconds();<br><span class="hljs-keyword">if</span> (seconds &lt;= <span class="hljs-number">0</span>) &#123;<br>	jedis.set(realkey, str);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>	jedis.setex(realkey, seconds, str);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>此时我们向浏览器设置cookie也使用的cookie.setMaxAge(MiaoshaUserKey.token.expireSeconds());，这不是redis逻辑，而是向浏览器的·response中返回逻辑，此时setMaxAge设置为0将立即删除cookie，即代码出现了redis存入数据，但浏览器中没有的情况。</p>
<h1 id="3-实现秒杀功能"><a href="#3-实现秒杀功能" class="headerlink" title="3. 实现秒杀功能"></a>3. 实现秒杀功能</h1><h2 id="3-1-数据库设计"><a href="#3-1-数据库设计" class="headerlink" title="3.1 数据库设计"></a>3.1 数据库设计</h2><h3 id="3-1-1-商品表"><a href="#3-1-1-商品表" class="headerlink" title="3.1.1 商品表"></a>3.1.1 商品表</h3><p>商品表goods</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `goods` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;商品ID&#x27;</span>,<br>  `goods_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品名称&#x27;</span>,<br>  `goods_title` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品标题&#x27;</span>,<br>  `goods_img` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品的图片&#x27;</span>,<br>  `goods_detail` longtext COMMENT <span class="hljs-string">&#x27;商品的详情介绍&#x27;</span>,<br>  `goods_price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.00&#x27;</span> COMMENT <span class="hljs-string">&#x27;商品单价&#x27;</span>,<br>  `goods_stock` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;商品库存，-1表示没有限制&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci<br></code></pre></td></tr></table></figure>
<h3 id="3-1-2-订单表"><a href="#3-1-2-订单表" class="headerlink" title="3.1.2 订单表"></a>3.1.2 订单表</h3><p>订单表order_info</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `order_info` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  `goods_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品ID&#x27;</span>,<br>  `delivery_addr_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收获地址ID&#x27;</span>,<br>  `goods_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;冗余过来的商品名称&#x27;</span>,<br>  `goods_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;商品数量&#x27;</span>,<br>  `goods_price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.00&#x27;</span> COMMENT <span class="hljs-string">&#x27;商品单价&#x27;</span>,<br>  `order_channel` tinyint <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;1pc，2android，3ios&#x27;</span>,<br>  `status` tinyint <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;订单状态，0新建未支付，1已支付，2已发货，3已收货，4已退款，5已完成&#x27;</span>,<br>  `create_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单的创建时间&#x27;</span>,<br>  `pay_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;支付时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1565</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci<br></code></pre></td></tr></table></figure>
<h3 id="3-1-3-秒杀商品表"><a href="#3-1-3-秒杀商品表" class="headerlink" title="3.1.3 秒杀商品表"></a>3.1.3 秒杀商品表</h3><p>秒杀商品表miaosha_goods，这里不和商品表goods集成的原因是不同的活动秒杀数据不同，如果和goods在一起需要不断的维护goods表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `miaosha_goods` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;秒杀的商品表&#x27;</span>,<br>  `goods_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品Id&#x27;</span>,<br>  `miaosha_price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.00&#x27;</span> COMMENT <span class="hljs-string">&#x27;秒杀价&#x27;</span>,<br>  `stock_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;库存数量&#x27;</span>,<br>  `start_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;秒杀开始时间&#x27;</span>,<br>  `end_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;秒杀结束时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci<br></code></pre></td></tr></table></figure>
<h3 id="3-1-4-秒杀订单表"><a href="#3-1-4-秒杀订单表" class="headerlink" title="3.1.4 秒杀订单表"></a>3.1.4 秒杀订单表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `miaosha_order` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  `order_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单ID&#x27;</span>,<br>  `goods_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品ID&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `u_uid_gid` (`user_id`,`goods_id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1551</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci<br></code></pre></td></tr></table></figure>
<h2 id="3-2-商品列表页"><a href="#3-2-商品列表页" class="headerlink" title="3.2 商品列表页"></a>3.2 商品列表页</h2><p>编写Goods实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Goods</span> </span>&#123;<br>    <span class="hljs-comment">//商品表</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String goodsName;<br>    <span class="hljs-keyword">private</span> String goodsTitle;<br>    <span class="hljs-keyword">private</span> String goodsImg;<br>    <span class="hljs-keyword">private</span> String goodsDetail;<br>    <span class="hljs-keyword">private</span> String goodsPrice;<br>    <span class="hljs-keyword">private</span> String goodsStock;<br><br>    <span class="hljs-comment">//getter and setter</span><br>   &#125;<br></code></pre></td></tr></table></figure>
<p>编写MiaoshaGoods实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiaoshaGoods</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> Long goodsId;<br>    <span class="hljs-keyword">private</span> Integer stockCount;<br>    <span class="hljs-keyword">private</span> Double miaoshaPrice;<br>    <span class="hljs-keyword">private</span> Date startDate;<br>    <span class="hljs-keyword">private</span> Date endDate;<br>    <br>    <span class="hljs-comment">//getter and setter</span><br>  &#125;<br></code></pre></td></tr></table></figure>
<p>在GoodsController中的to_list添加查询商品列表的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-meta">@RequestMapping(&quot;/to_list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">list</span><span class="hljs-params">(Model model,MiaoshaUser user)</span></span>&#123;<br><span class="hljs-comment">//        if (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(cookieToken))&#123;</span><br><span class="hljs-comment">//            return &quot;login&quot;;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;</span><br><span class="hljs-comment">//        MiaoshaUser user = userService.getByToken(response,token);</span><br><br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-comment">//查询商品列表</span><br>        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();<br>        model.addAttribute(<span class="hljs-string">&quot;goodsList&quot;</span>,goodsList);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;goods_list&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>编写GoodsService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    GoodsDao goodsDao;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;GoodsVo&gt; <span class="hljs-title">listGoodsVo</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> goodsDao.listGoodsVo();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>编写GoodsDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">GoodsDao</span> </span>&#123;<br><br>    <span class="hljs-meta">@Select(&quot;select g.*,mg.stock_count,mg.start_date,mg.end_date,mg.miaosha_price from miaosha_goods mg left join goods g on mg.goods_id = g.id&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;GoodsVo&gt; <span class="hljs-title">listGoodsVo</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="3-3-商品详情页"><a href="#3-3-商品详情页" class="headerlink" title="3.3 商品详情页"></a>3.3 商品详情页</h2><p>商品详情页所展示的信息仍然是GoodsVo，在GoodsController中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/to_detail/&#123;goodsId&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">detail</span><span class="hljs-params">(Model model, MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                     <span class="hljs-meta">@PathVariable(&quot;goodsId&quot;)</span>Long goodsId)</span></span>&#123;<br>    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>    <span class="hljs-comment">//查询商品详情</span><br>    GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);<br>    model.addAttribute(<span class="hljs-string">&quot;goods&quot;</span>,goods);<br><br>    <span class="hljs-keyword">long</span> startAt = goods.getStartDate().getTime();<br>    <span class="hljs-keyword">long</span> endAt = goods.getEndDate().getTime();<br>    <span class="hljs-keyword">long</span> now = System.currentTimeMillis();<br><br>    <span class="hljs-keyword">int</span> miaoshaStatus = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> remainSeconds = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (now &lt; startAt)&#123;<br>        <span class="hljs-comment">//秒杀未开始，倒计时</span><br>        miaoshaStatus = <span class="hljs-number">0</span>;<br>        remainSeconds = (<span class="hljs-keyword">int</span>)(startAt - now) / <span class="hljs-number">1000</span>;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(now &gt; endAt)&#123;<br>        <span class="hljs-comment">//秒杀已经结束</span><br>        miaoshaStatus = <span class="hljs-number">2</span>;<br>        remainSeconds = -<span class="hljs-number">1</span>;<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//秒杀正在进行</span><br>        miaoshaStatus = <span class="hljs-number">1</span>;<br>        remainSeconds = <span class="hljs-number">0</span>;<br>    &#125;<br>    model.addAttribute(<span class="hljs-string">&quot;miaoshaStatus&quot;</span>, miaoshaStatus);<br>    model.addAttribute(<span class="hljs-string">&quot;remainSeconds&quot;</span>, remainSeconds);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;goods_detail&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>GoodsService添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> GoodsVo <span class="hljs-title">getGoodsVoByGoodsId</span><span class="hljs-params">(Long goodsId)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> goodsDao.getGoodsVoByGoodsId(goodsId);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>GoodsDao中添加方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;select g.*,mg.stock_count,mg.start_date,mg.end_date,mg.miaosha_price from miaosha_goods mg left join goods g on mg.goods_id = g.id where g.id = #&#123;goodsId&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span>  GoodsVo <span class="hljs-title">getGoodsVoByGoodsId</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;goodsId&quot;)</span> Long goodsId)</span></span>;<br></code></pre></td></tr></table></figure>
<p>秒杀功能实现：</p>
<p>点击商品详情页的；立即秒杀按钮会跳转到“/miaosha/do_miaosha”,编写MiaoshaController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/miaosha&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiaoshaController</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger log = LoggerFactory.getLogger(MiaoshaController.class);<br><br>    <span class="hljs-meta">@Autowired</span><br>    GoodsService goodsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    OrderService orderService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MiaoshaService miaoshaService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/do_miaosha&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">list</span><span class="hljs-params">(Model model, MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                       <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span></span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>        &#125;<br>        <span class="hljs-comment">//判断库存</span><br>        GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);<br>        <span class="hljs-keyword">int</span> stock = goods.getStockCount();<br>        <span class="hljs-keyword">if</span> (stock &lt;= <span class="hljs-number">0</span>)&#123;<br>            model.addAttribute(<span class="hljs-string">&quot;errmsg&quot;</span>, CodeMsg.MIAO_SHA_OVER.getMsg());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;miaosha_fail&quot;</span>;<br>        &#125;<br>        <span class="hljs-comment">//判断是否已经秒杀到了</span><br>        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(user.getId(),goodsId);<br>        <span class="hljs-keyword">if</span> (order != <span class="hljs-keyword">null</span>)&#123;<br>            model.addAttribute(<span class="hljs-string">&quot;errmsg&quot;</span>,CodeMsg.REPEATE_MIAOSHA.getMsg());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;miaosha_fail&quot;</span>;<br>        &#125;<br>        <span class="hljs-comment">//减库存 下订单 写入秒杀订单</span><br>        OrderInfo orderInfo = miaoshaService.miaosha(user,goods);<br>        model.addAttribute(<span class="hljs-string">&quot;orderInfo&quot;</span>,orderInfo);<br>        model.addAttribute(<span class="hljs-string">&quot;goods&quot;</span>,goods);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order_detail&quot;</span>;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里面涉及到三个service，分别是 GoodsService，OrderService，MiaoshaService</p>
<ol>
<li><p>GoodsService中已经有getGoodsVoByGoodsId()方法</p>
</li>
<li><p>OrderService中添加getMiaoshaOrderByUserIdAndGoodsId()方法</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaOrder <span class="hljs-title">getMiaoshaOrderByUserIdAndGoodsId</span><span class="hljs-params">(<span class="hljs-keyword">long</span> userId, <span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> orderDao.getMiaoshaOrderByUserIdAndGoodsId(userId, goodsId);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在OrderService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;select * from miaosha_order where user_id = #&#123;userId&#125; and goods_id = #&#123;goodsId&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaOrder <span class="hljs-title">getMiaoshaOrderByUserIdAndGoodsId</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;userId&quot;)</span><span class="hljs-keyword">long</span> userId, <span class="hljs-meta">@Param(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span></span>;<br></code></pre></td></tr></table></figure>
<ol>
<li>上面步骤说明满足秒杀条件，MiaoshaService中编写miaosha()方法，该方法应该声明为事务,值得注意的是Service方法中一般引入自己同名相应的Dao，如果引用别的Dao方法应该直接引入对应的Service方法，比如这里引入的GoodsService而不是GoodsDao</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiaoshaService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    GoodsService goodsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    OrderService orderService;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> OrderInfo <span class="hljs-title">miaosha</span><span class="hljs-params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;<br>        <span class="hljs-comment">//减库存</span><br>        goodsService.reduceStock(goods);<br>        <span class="hljs-comment">//生成订单</span><br>        <span class="hljs-keyword">return</span> orderService.createOrder(user,goods);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>miaosha()里面有两个方法，在goodsService方法中添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduceStock</span><span class="hljs-params">(GoodsVo goods)</span> </span>&#123;<br>    MiaoshaGoods g = <span class="hljs-keyword">new</span> MiaoshaGoods();<br>    g.setGoodsId(goods.getId());<br>    goodsDao.reduceStock(g);<br>&#125;<br><br> MiaoshaGoods:<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiaoshaGoods</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> Long goodsId;<br>    <span class="hljs-keyword">private</span> Integer stockCount;<br>    <span class="hljs-keyword">private</span> Double miaoshaPrice;<br>    <span class="hljs-keyword">private</span> Date startDate;<br>    <span class="hljs-keyword">private</span> Date endDate;<br>    <br>    <span class="hljs-comment">//getter and setter</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>goodsDao中的reduceStock()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Update(&quot;update miaosha_goods set stock_count = stock_count - 1 where goods_id = #&#123;goodsId&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">reduceStock</span><span class="hljs-params">(MiaoshaGoods g)</span></span>;<br></code></pre></td></tr></table></figure>
<p>orderService中添加createOrder：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> OrderInfo <span class="hljs-title">createOrder</span><span class="hljs-params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;<br>       OrderInfo orderInfo = <span class="hljs-keyword">new</span> OrderInfo();<br>       orderInfo.setCreateDate(<span class="hljs-keyword">new</span> Date());<br>       orderInfo.setDeliveryAddrId(<span class="hljs-number">0L</span>);<br>       orderInfo.setGoodsCount(<span class="hljs-number">1</span>);<br>       orderInfo.setGoodsId(goods.getId());<br>       orderInfo.setGoodsName(goods.getGoodsName());<br>       orderInfo.setGoodsPrice(goods.getMiaoshaPrice());<br>       orderInfo.setOrderChannel(<span class="hljs-number">1</span>);<br>       orderInfo.setStatus(<span class="hljs-number">0</span>);<br>       orderInfo.setUserId(user.getId());<br>       <span class="hljs-keyword">long</span> orderId = orderDao.insert(orderInfo);<br>       MiaoshaOrder miaoshaOrder = <span class="hljs-keyword">new</span> MiaoshaOrder();<br>       miaoshaOrder.setGoodsId(goods.getId());<br>       miaoshaOrder.setOrderId(orderId);<br>       miaoshaOrder.setUserId(user.getId());<br><br>       orderDao.insertMiaoshaOrder(miaoshaOrder);<br>       <span class="hljs-keyword">return</span>  orderInfo;<br>   &#125;<br></code></pre></td></tr></table></figure>
<p>orderDao中的insertMiaoshaOrder()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Insert(&quot;insert into miaosha_order (user_id, goods_id, order_id)values(#&#123;userId&#125;, #&#123;goodsId&#125;, #&#123;orderId&#125;)&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertMiaoshaOrder</span><span class="hljs-params">(MiaoshaOrder miaoshaOrder)</span></span>;<br></code></pre></td></tr></table></figure>
<p>这里为什么只修改秒杀商品表库存而不修改商品表库存呢？</p>
<h2 id="3-4-订单详情页"><a href="#3-4-订单详情页" class="headerlink" title="3.4 订单详情页"></a>3.4 订单详情页</h2><p>编写相应的thymeleaf模板</p>
<h1 id="4-JMeter压测"><a href="#4-JMeter压测" class="headerlink" title="4. JMeter压测"></a>4. JMeter压测</h1><h2 id="4-1-JMeter入门"><a href="#4-1-JMeter入门" class="headerlink" title="4.1 JMeter入门"></a>4.1 JMeter入门</h2><p>启动JMeter后添加线程组，设置线程属性：</p>
<ul>
<li>线程数：1000(太少吞吐量达不到性能瓶颈)</li>
<li>Ramp-Up时间：0（线程同时启动，设置为10则是线程组在10秒内启动）</li>
<li>循环次数：1（线程组测试多少次）</li>
</ul>
<p>在线程组下设置：</p>
<ul>
<li>HTTP请求默认值<ul>
<li>协议：http</li>
<li>服务器名称或IP：localhost</li>
<li>端口号：8080</li>
</ul>
</li>
<li>HTTP请求<ul>
<li>名称：商品列表</li>
<li>请求方式：GET</li>
<li>路径：goods/to_list</li>
</ul>
</li>
<li>聚合报告</li>
</ul>
<p>聚合报告显示吞吐量468/s</p>
<p>测试时若mysql在linux上使用top命令观察各进程情况，在windows上使用任务管理器，发现mysql占用资源最多，应该为当前的性能瓶颈。</p>
<h2 id="4-2-自定义变量模拟多用户"><a href="#4-2-自定义变量模拟多用户" class="headerlink" title="4.2 自定义变量模拟多用户"></a>4.2 自定义变量模拟多用户</h2><p>在线程组下添加一个HTTP请求：</p>
<p>HTTP请求</p>
<ul>
<li>名称：获取用户信息</li>
<li>请求方式：GET</li>
<li>路径：/user/info</li>
<li>参数：<ul>
<li>名称：token，值：a2a8a05fa0eb4b2f8f028e704de2f577</li>
</ul>
</li>
</ul>
<p>禁用原来的商品列表请求，现在的获取用户信息吞吐量667.1/s，因为现在只需要查redis不需要查mysql</p>
<p>现在只使用了一个token，也就是单用户，下面创建多用户，添加配置元件CSVDataSetConfig：</p>
<ul>
<li>文件名：F:/QQPCmgr/Desktop/config.txt</li>
<li>变量名称：userId,userToken</li>
<li>编写config.txt：<ul>
<li>userid1,a2a8a05fa0eb4b2f8f028e704de2f577</li>
</ul>
</li>
</ul>
<h2 id="4-3-JMeter命令行使用"><a href="#4-3-JMeter命令行使用" class="headerlink" title="4.3 JMeter命令行使用"></a>4.3 JMeter命令行使用</h2><ol>
<li><p>在windows上录好jmx</p>
<p>把windows上的jmx保存上传到linux</p>
</li>
<li><p>命令行：sh jmeter.sh -n -t XXX.jmx -l result.jtl</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apache-jmeter-5.4/bin/jmeter.sh -n -t goods_list.jmx -l result.jtl<br></code></pre></td></tr></table></figure>
<ol>
<li>使用top命令观察压测情况</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">top</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">06</span><span class="hljs-selector-pseudo">:40</span><span class="hljs-selector-pseudo">:42</span> <span class="hljs-selector-tag">up</span>  <span class="hljs-selector-tag">3</span><span class="hljs-selector-pseudo">:31</span>,  <span class="hljs-selector-tag">2</span> <span class="hljs-selector-tag">users</span>,  <span class="hljs-selector-tag">load</span> <span class="hljs-selector-tag">average</span>: <span class="hljs-selector-tag">11</span><span class="hljs-selector-class">.09</span>, <span class="hljs-selector-tag">4</span><span class="hljs-selector-class">.46</span>, <span class="hljs-selector-tag">2</span><span class="hljs-selector-class">.57</span><br>占用最多的进程是两个<span class="hljs-selector-tag">java</span>(项目和jemeter)和<span class="hljs-selector-tag">mysql</span><br></code></pre></td></tr></table></figure>
<ol>
<li>把result.jtl导入到jmeter</li>
</ol>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">qps</span>为<span class="hljs-number">897</span>.<span class="hljs-number">9</span>/s<br></code></pre></td></tr></table></figure>
<h2 id="4-4-Redis压测工具redis-benchmark"><a href="#4-4-Redis压测工具redis-benchmark" class="headerlink" title="4.4 Redis压测工具redis-benchmark"></a>4.4 Redis压测工具redis-benchmark</h2><p>redis做压测可以使用自带的redis-benchmark工具</p>
<p>在linux使用终端命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">100个并发，100000个请求</span><br>redis-benchmark -h 127.0.0.1 -p 6379 -c 100 -n 100000<br></code></pre></td></tr></table></figure>
<p>得到结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">====== GET ======<br>  100000 requests completed in 1.79 seconds<br>  100 parallel clients<br>  3 bytes payload<br>  keep alive: 1<br></code></pre></td></tr></table></figure>
<p>使用终端命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">存取大小为100字节的数据包</span><br>redis-benchmark -h 127.0.0.1 -p 6379 -q -d 100<br></code></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">PING_INLINE: 54141.85 requests per second<br>PING_BULK: 68212.83 requests per second<br>SET: 78247.26 requests per second<br>GET: 79302.14 requests per second<br>INCR: 69348.12 requests per second<br>LPUSH: 78926.60 requests per second<br>RPUSH: 78369.91 requests per second<br>LPOP: 79239.30 requests per second<br>RPOP: 80128.20 requests per second<br>SADD: 79744.82 requests per second<br>HSET: 78554.59 requests per second<br>SPOP: 78740.16 requests per second<br>LPUSH (needed to benchmark LRANGE): 78369.91 requests per second<br>LRANGE_100 (first 100 elements): 78308.54 requests per second<br>LRANGE_300 (first 300 elements): 78186.08 requests per second<br>LRANGE_500 (first 450 elements): 79365.08 requests per second<br>LRANGE_600 (first 600 elements): 78492.93 reque<br></code></pre></td></tr></table></figure>
<p>使用终端命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">测试单个语句性能</span><br>redis-benchmark -n 100000 -q script load &quot;redis.call(&#x27;set&#x27;,&#x27;foo&#x27;,&#x27;bar&#x27;)&quot;<br></code></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">script load redis.call(&#x27;set&#x27;,&#x27;foo&#x27;,&#x27;bar&#x27;): 66093.85 requests per second<br></code></pre></td></tr></table></figure>
<h2 id="4-5-SpringBoot打war包"><a href="#4-5-SpringBoot打war包" class="headerlink" title="4.5 SpringBoot打war包"></a>4.5 SpringBoot打war包</h2><ol>
<li>添加spring-boot-starter-tomcat的provided依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ol>
<li>添加maven-war-plugin插件</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-war-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                   <span class="hljs-tag">&lt;<span class="hljs-name">failOnMissingWebXml</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">failOnMissingWebXml</span>&gt;</span><br>               <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>           <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ol>
<li>修改启动类MainApplication</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpringBootServletInitializer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(MainApplication.class,args);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> SpringApplicationBuilder <span class="hljs-title">configure</span><span class="hljs-params">(SpringApplicationBuilder builder)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> builder.sources(MainApplication.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>在终端 E:\ideawork\miaosha_4打包命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">E:\ideawork\miaosha_4&gt;mvn clean package<br></code></pre></td></tr></table></figure>
<ol>
<li>打包后将miaosha_4.war移动到tomcat的websapp下面并启动tomcat</li>
</ol>
<h1 id="5-页面优化技术"><a href="#5-页面优化技术" class="headerlink" title="5. 页面优化技术"></a>5. 页面优化技术</h1><h2 id="5-1-页面缓存-URL缓存-对象缓存"><a href="#5-1-页面缓存-URL缓存-对象缓存" class="headerlink" title="5.1 页面缓存+URL缓存+对象缓存"></a>5.1 页面缓存+URL缓存+对象缓存</h2><h3 id="5-1-1页面缓存"><a href="#5-1-1页面缓存" class="headerlink" title="5.1.1页面缓存"></a>5.1.1页面缓存</h3><p>页面缓存，这里使用的是浏览器缓存技术（第二次访问有效）</p>
<p>首先修改访问原来的list逻辑，增加了注解@ResponseBody，先尝试在redis取缓存，没有的话就生成缓存并存到redis中，以前是直接返回goods_list交给thymeleaf渲染解析，这里先使用thymeleafViewResolver解析为成品代码返回，再将成品代码存到redis中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">	<span class="hljs-meta">@RequestMapping(value = &quot;/to_list&quot;,produces = &quot;text/html&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">list</span><span class="hljs-params">(HttpServletRequest request,HttpServletResponse response, Model model, MiaoshaUser user)</span></span>&#123;<br><br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-comment">//查询商品列表</span><br>        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();<br>        model.addAttribute(<span class="hljs-string">&quot;goodsList&quot;</span>,goodsList);<br><span class="hljs-comment">//        return &quot;goods_list&quot;;</span><br>        <span class="hljs-comment">//取缓存</span><br>        String html = redisService.get(GoodsKey.getGoodsList,<span class="hljs-string">&quot;&quot;</span>,String.class);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(html))&#123;<br>            <span class="hljs-keyword">return</span> html;<br>        &#125;<br>        IWebContext ctx =<span class="hljs-keyword">new</span> WebContext(request,response,<br>                request.getServletContext(),request.getLocale(),model.asMap());<br>        <span class="hljs-comment">//没有缓存手动渲染</span><br>        html = thymeleafViewResolver.getTemplateEngine().process(<span class="hljs-string">&quot;goods_list&quot;</span>, ctx);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(html))&#123;<br>            redisService.set(GoodsKey.getGoodsList,<span class="hljs-string">&quot;&quot;</span>,html);<br>        &#125;<br>        <span class="hljs-keyword">return</span> html;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>编写GoodsKey，设置过期时间为60s，设置过大的数字会降低数据时效性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasePrefix</span></span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">GoodsKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> expireSeconds,String prefix)</span></span>&#123;<br>        <span class="hljs-keyword">super</span>(prefix);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GoodsKey getGoodsList = <span class="hljs-keyword">new</span> GoodsKey(<span class="hljs-number">60</span>,<span class="hljs-string">&quot;gl&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="5-1-2-URL缓存"><a href="#5-1-2-URL缓存" class="headerlink" title="5.1.2 URL缓存"></a>5.1.2 URL缓存</h3><p>URL缓存用于修改goods_detail，URL缓存和页面缓存基本一致，区别在于不同的详情页（URL）会显示不同缓存页面+渲染，实质一样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/to_detail/&#123;goodsId&#125;&quot;,produces = &quot;text/html&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">detail</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Model model,MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                        <span class="hljs-meta">@PathVariable(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span></span>&#123;<br>       model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br><br>       <span class="hljs-comment">//取缓存</span><br>       String html = redisService.get(GoodsKey.getGoodsDetail, <span class="hljs-string">&quot;&quot;</span>+goodsId, String.class);<br>       <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(html)) &#123;<br>           <span class="hljs-keyword">return</span> html;<br>       &#125;<br>       <br>       <span class="hljs-comment">//没有缓存手动渲染</span><br>       <span class="hljs-comment">//查询商品详情</span><br>       GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);<br>       model.addAttribute(<span class="hljs-string">&quot;goods&quot;</span>,goods);<br><br>       <span class="hljs-keyword">long</span> startAt = goods.getStartDate().getTime();<br>       <span class="hljs-keyword">long</span> endAt = goods.getEndDate().getTime();<br>       <span class="hljs-keyword">long</span> now = System.currentTimeMillis();<br><br>       <span class="hljs-keyword">int</span> miaoshaStatus = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">int</span> remainSeconds = <span class="hljs-number">0</span>;<br><br>       <span class="hljs-keyword">if</span> (now &lt; startAt)&#123;<br>           <span class="hljs-comment">//秒杀未开始，倒计时</span><br>           miaoshaStatus = <span class="hljs-number">0</span>;<br>           remainSeconds = (<span class="hljs-keyword">int</span>)(startAt - now) / <span class="hljs-number">1000</span>;<br>       &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(now &gt; endAt)&#123;<br>           <span class="hljs-comment">//秒杀已经结束</span><br>           miaoshaStatus = <span class="hljs-number">2</span>;<br>           remainSeconds = -<span class="hljs-number">1</span>;<br>       &#125;<span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-comment">//秒杀正在进行</span><br>           miaoshaStatus = <span class="hljs-number">1</span>;<br>           remainSeconds = <span class="hljs-number">0</span>;<br>       &#125;<br>       model.addAttribute(<span class="hljs-string">&quot;miaoshaStatus&quot;</span>, miaoshaStatus);<br>       model.addAttribute(<span class="hljs-string">&quot;remainSeconds&quot;</span>, remainSeconds);<br><br>       IWebContext ctx =<span class="hljs-keyword">new</span> WebContext(request,response,<br>               request.getServletContext(),request.getLocale(),model.asMap());<br>       html = thymeleafViewResolver.getTemplateEngine().process(<span class="hljs-string">&quot;goods_detail&quot;</span>, ctx);<br>       <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(html)) &#123;<br>           redisService.set(GoodsKey.getGoodsDetail, <span class="hljs-string">&quot;&quot;</span>+goodsId, html);<br>       &#125;<br>       <span class="hljs-keyword">return</span> html;<br>       <br>   &#125;<br></code></pre></td></tr></table></figure>
<h3 id="5-1-3-对象缓存"><a href="#5-1-3-对象缓存" class="headerlink" title="5.1.3 对象缓存"></a>5.1.3 对象缓存</h3><p>对象缓存是相比页面缓存是更细粒度的缓存，对象缓存就是当用到用户数据的时候，可以从缓存中取出。比如：更新用户密码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//原来的逻辑是直接到mysql数据库中取用户数据，现在修改为先查redis再查mysql</span><br><span class="hljs-comment">//同时添加了updatePassword方法，注意当有update方法是应该保证redis和mysql数据的一致性</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaUser <span class="hljs-title">getById</span><span class="hljs-params">(Long id)</span></span>&#123;<br>        <span class="hljs-comment">//取缓存</span><br>        MiaoshaUser user = redisService.get(MiaoshaUserKey.getById, <span class="hljs-string">&quot;&quot;</span> + id, MiaoshaUser.class);<br>        <span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> user;<br>        &#125;<br>        <span class="hljs-comment">//缓存没有取数据库</span><br>        user = miaoshaUserDao.getById(id);<br>        <span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span>)&#123;<br>            redisService.set(MiaoshaUserKey.getById,<span class="hljs-string">&quot;&quot;</span>+id,user);<br>        &#125;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">updatePassword</span><span class="hljs-params">(String token,<span class="hljs-keyword">long</span> id,String formPass)</span></span>&#123;<br>        <span class="hljs-comment">//取user</span><br>        MiaoshaUser user = getById(id);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlobleException(CodeMsg.MOBILE_NOT_EXIST);<br>        &#125;<br>        <span class="hljs-comment">//更新数据库</span><br>        MiaoshaUser toBeUpdate = <span class="hljs-keyword">new</span> MiaoshaUser();<br>        toBeUpdate.setId(id);<br>        toBeUpdate.setPassword(MD5Util.formPassToDBPass(formPass,user.getSalt()));<br>        miaoshaUserDao.update(toBeUpdate);<br>        <span class="hljs-comment">//处理缓存时应该更新两处，1.查询用户时的getById 2.cookie验证中的用户数据</span><br>        <span class="hljs-comment">//1.查询用户的缓存直接删除即可，因为查询用户时查不到会去mysql中查询</span><br>        <span class="hljs-comment">//2.cookie中的用户数据需要得到更新</span><br>        redisService.delete(MiaoshaUserKey.getById,<span class="hljs-string">&quot;&quot;</span>+id);<br>        user.setPassword(toBeUpdate.getPassword());<br>        redisService.set(MiaoshaUserKey.token,token,user);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>miaoshaUserDao.update()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Update(&quot;update miaosha_user set password = #&#123;password&#125; where id = #&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(MiaoshaUser toBeUpdate)</span></span>;<br></code></pre></td></tr></table></figure>
<p>redisService.delete()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//删除</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">delete</span><span class="hljs-params">(KeyPrefix prefix,String key)</span> </span>&#123;<br>    Jedis jedis = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        jedis = jedisPool.getResource();<br>        <span class="hljs-comment">//生成真正的key</span><br>        String realkey = prefix.getPrefix() + key;<br>        <span class="hljs-keyword">long</span> ret = jedis.del(realkey);<br>        <span class="hljs-keyword">return</span> ret &gt; <span class="hljs-number">0</span>;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        returnToPool(jedis);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>做完以上操作以后再次启动项目验证QPS</p>
<p>还有一处可以更新的地方是OrderService中判断当前用户是否已经有订单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> MiaoshaOrder <span class="hljs-title">getMiaoshaOrderByUserIdAndGoodsId</span><span class="hljs-params">(<span class="hljs-keyword">long</span> userId, <span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>    <span class="hljs-comment">//  return orderDao.getMiaoshaOrderByUserIdAndGoodsId(userId, goodsId);</span><br>        <span class="hljs-keyword">return</span> redisService.get(OrderKey.getMiaoshaOrderByuidGid,<span class="hljs-string">&quot;&quot;</span>+userId+<span class="hljs-string">&quot;_&quot;</span>+goodsId,MiaoshaOrder.class);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这样生成订单的时候也要向redis插入数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> OrderInfo <span class="hljs-title">createOrder</span><span class="hljs-params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;<br>        OrderInfo orderInfo = <span class="hljs-keyword">new</span> OrderInfo();<br>        orderInfo.setCreateDate(<span class="hljs-keyword">new</span> Date());<br>        orderInfo.setDeliveryAddrId(<span class="hljs-number">0L</span>);<br>        orderInfo.setGoodsCount(<span class="hljs-number">1</span>);<br>        orderInfo.setGoodsId(goods.getId());<br>        orderInfo.setGoodsName(goods.getGoodsName());<br>        orderInfo.setGoodsPrice(goods.getMiaoshaPrice());<br>        orderInfo.setOrderChannel(<span class="hljs-number">1</span>);<br>        orderInfo.setStatus(<span class="hljs-number">0</span>);<br>        orderInfo.setUserId(user.getId());<br>        <span class="hljs-keyword">long</span> orderId = orderDao.insert(orderInfo);<br>        MiaoshaOrder miaoshaOrder = <span class="hljs-keyword">new</span> MiaoshaOrder();<br>        miaoshaOrder.setGoodsId(goods.getId());<br>        miaoshaOrder.setOrderId(orderId);<br>        miaoshaOrder.setUserId(user.getId());<br><br>        orderDao.insertMiaoshaOrder(miaoshaOrder);<br><br>        redisService.set(OrderKey.getMiaoshaOrderByuidGid,<span class="hljs-string">&quot;&quot;</span>+user.getId()+<span class="hljs-string">&quot;_&quot;</span>+goods.getId(),miaoshaOrder);<br>        <span class="hljs-keyword">return</span> orderInfo;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h2 id="5-2-页面静态化，前后端分离"><a href="#5-2-页面静态化，前后端分离" class="headerlink" title="5.2 页面静态化，前后端分离"></a>5.2 页面静态化，前后端分离</h2><h3 id="5-2-1-商品详情页"><a href="#5-2-1-商品详情页" class="headerlink" title="5.2.1 商品详情页"></a>5.2.1 商品详情页</h3><p>当前访问商品详情页是通过redis缓存页面静态代码完成的，现在进一步改进的方式是把每一个页面直接生成静态的html保存在服务器，而不必进行数据库缓存。</p>
<p>首先修改后端detail代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value=&quot;/detail/&#123;goodsId&#125;&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;GoodsDetailVo&gt; <span class="hljs-title">detail</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Model model,MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-meta">@PathVariable(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>       GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);<br>       <span class="hljs-keyword">long</span> startAt = goods.getStartDate().getTime();<br>       <span class="hljs-keyword">long</span> endAt = goods.getEndDate().getTime();<br>       <span class="hljs-keyword">long</span> now = System.currentTimeMillis();<br>       <span class="hljs-keyword">int</span> miaoshaStatus = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">int</span> remainSeconds = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">if</span>(now &lt; startAt ) &#123;<span class="hljs-comment">//秒杀还没开始，倒计时</span><br>           miaoshaStatus = <span class="hljs-number">0</span>;<br>           remainSeconds = (<span class="hljs-keyword">int</span>)((startAt - now )/<span class="hljs-number">1000</span>);<br>       &#125;<span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span>(now &gt; endAt)&#123;<span class="hljs-comment">//秒杀已经结束</span><br>           miaoshaStatus = <span class="hljs-number">2</span>;<br>           remainSeconds = -<span class="hljs-number">1</span>;<br>       &#125;<span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//秒杀进行中</span><br>           miaoshaStatus = <span class="hljs-number">1</span>;<br>           remainSeconds = <span class="hljs-number">0</span>;<br>       &#125;<br>       GoodsDetailVo vo = <span class="hljs-keyword">new</span> GoodsDetailVo();<br>       vo.setGoods(goods);<br>       vo.setUser(user);<br>       vo.setRemainSeconds(remainSeconds);<br>       vo.setMiaoshaStatus(miaoshaStatus);<br>       <span class="hljs-keyword">return</span> Result.success(vo);<br>   &#125;<br></code></pre></td></tr></table></figure>
<p>GoodsDetailVo中存放页面详情相关的数据，现在我们不需要返回页面，只需要返回需要静态页面渲染详情页需要的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsDetailVo</span> </span>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> miaoshaStatus = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> remainSeconds = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">private</span> GoodsVo goods ;<br>	<span class="hljs-keyword">private</span> MiaoshaUser user;<br>	<br>	<span class="hljs-comment">//getter and setter</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>以前goods_list中的请求是先发送到后端逻辑处理：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;&#x27;/goods/to_detail/&#x27;+$&#123;goods.id&#125;&quot;</span>&gt;</span>详情<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br></code></pre></td></tr></table></figure>
<p>修改为直接访问html页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;&#x27;/goods_detail.htm?goodsId=&#x27;+$&#123;goods.id&#125;&quot;</span>&gt;</span>详情<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>该页面不再借助thymeleaf模板渲染，goods_detail.htm：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;panel panel-default&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;panel-heading&quot;</span>&gt;</span>秒杀商品详情<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;panel-body&quot;</span>&gt;</span><br>  	<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userTip&quot;</span>&gt;</span> 您还没有登录，请登陆后再操作<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  	<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>没有收货地址的提示。。。<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodslist&quot;</span>&gt;</span><br>  	<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;3&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodsName&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span> <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>商品图片<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;3&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span>  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodsImg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;200&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;200&quot;</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>秒杀开始时间<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;startTime&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> &gt;</span>	<br>        	<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;remainSeconds&quot;</span> /&gt;</span><br>        	<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;miaoshaTip&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--  </span><br><span class="hljs-comment">        	&lt;form id=&quot;miaoshaForm&quot; method=&quot;post&quot; action=&quot;/miaosha/do_miaosha&quot;&gt;</span><br><span class="hljs-comment">        		&lt;button class=&quot;btn btn-primary btn-block&quot; type=&quot;submit&quot; id=&quot;buyButton&quot;&gt;立即秒杀&lt;/button&gt;</span><br><span class="hljs-comment">        		&lt;input type=&quot;hidden&quot; name=&quot;goodsId&quot;  id=&quot;goodsId&quot; /&gt;</span><br><span class="hljs-comment">        	&lt;/form&gt;--&gt;</span><br>        	<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary btn-block&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;buyButton&quot;</span><span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;doMiaosha()&quot;</span>&gt;</span>立即秒杀<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        	<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;goodsId&quot;</span>  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodsId&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>商品原价<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;3&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodsPrice&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>秒杀价<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;3&quot;</span>  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;miaoshaPrice&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>库存数量<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;3&quot;</span>  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;stockCount&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doMiaosha</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">	$.ajax(&#123;</span><br><span class="javascript">		url:<span class="hljs-string">&quot;/miaosha/do_miaosha&quot;</span>,</span><br><span class="javascript">		type:<span class="hljs-string">&quot;POST&quot;</span>,</span><br>		data:&#123;<br><span class="javascript">			goodsId:$(<span class="hljs-string">&quot;#goodsId&quot;</span>).val(),</span><br>		&#125;,<br><span class="javascript">		success:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;</span><br><span class="javascript">			<span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>)&#123;</span><br><span class="javascript">				<span class="hljs-built_in">window</span>.location.href=<span class="hljs-string">&quot;/order_detail.htm?orderId=&quot;</span>+data.data.id;</span><br><span class="javascript">			&#125;<span class="hljs-keyword">else</span>&#123;</span><br>				layer.msg(data.msg);<br>			&#125;<br>		&#125;,<br><span class="javascript">		error:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">			layer.msg(<span class="hljs-string">&quot;客户端请求有误&quot;</span>);</span><br>		&#125;<br>	&#125;);<br>	<br>&#125;<br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">detail</span>)</span>&#123;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> miaoshaStatus = detail.miaoshaStatus;</span><br><span class="javascript">	<span class="hljs-keyword">var</span>  remainSeconds = detail.remainSeconds;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> goods = detail.goods;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> user = detail.user;</span><br><span class="javascript">	<span class="hljs-keyword">if</span>(user)&#123;</span><br><span class="javascript">		$(<span class="hljs-string">&quot;#userTip&quot;</span>).hide();</span><br>	&#125;<br><span class="javascript">	$(<span class="hljs-string">&quot;#goodsName&quot;</span>).text(goods.goodsName);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#goodsImg&quot;</span>).attr(<span class="hljs-string">&quot;src&quot;</span>, goods.goodsImg);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#startTime&quot;</span>).text(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(goods.startDate).format(<span class="hljs-string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#remainSeconds&quot;</span>).val(remainSeconds);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#goodsId&quot;</span>).val(goods.id);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#goodsPrice&quot;</span>).text(goods.goodsPrice);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#miaoshaPrice&quot;</span>).text(goods.miaoshaPrice);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#stockCount&quot;</span>).text(goods.stockCount);</span><br>	countDown();<br>&#125;<br><br><span class="javascript">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">	<span class="hljs-comment">//countDown();</span></span><br>	getDetail();<br>&#125;);<br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDetail</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> goodsId = g_getQueryString(<span class="hljs-string">&quot;goodsId&quot;</span>);</span><br><span class="javascript">	$.ajax(&#123;</span><br><span class="javascript">		url:<span class="hljs-string">&quot;/goods/detail/&quot;</span>+goodsId,</span><br><span class="javascript">		type:<span class="hljs-string">&quot;GET&quot;</span>,</span><br><span class="javascript">		success:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;</span><br><span class="javascript">			<span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>)&#123;</span><br>				render(data.data);<br><span class="javascript">			&#125;<span class="hljs-keyword">else</span>&#123;</span><br>				layer.msg(data.msg);<br>			&#125;<br>		&#125;,<br><span class="javascript">		error:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">			layer.msg(<span class="hljs-string">&quot;客户端请求有误&quot;</span>);</span><br>		&#125;<br>	&#125;);<br>&#125;<br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countDown</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> remainSeconds = $(<span class="hljs-string">&quot;#remainSeconds&quot;</span>).val();</span><br><span class="javascript">	<span class="hljs-keyword">var</span> timeout;</span><br><span class="javascript">	<span class="hljs-keyword">if</span>(remainSeconds &gt; <span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//秒杀还没开始，倒计时</span></span><br><span class="javascript">		$(<span class="hljs-string">&quot;#buyButton&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-literal">true</span>);</span><br><span class="javascript">	   $(<span class="hljs-string">&quot;#miaoshaTip&quot;</span>).html(<span class="hljs-string">&quot;秒杀倒计时：&quot;</span>+remainSeconds+<span class="hljs-string">&quot;秒&quot;</span>);</span><br><span class="javascript">		timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">			$(<span class="hljs-string">&quot;#countDown&quot;</span>).text(remainSeconds - <span class="hljs-number">1</span>);</span><br><span class="javascript">			$(<span class="hljs-string">&quot;#remainSeconds&quot;</span>).val(remainSeconds - <span class="hljs-number">1</span>);</span><br>			countDown();<br>		&#125;,1000);<br><span class="javascript">	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(remainSeconds == <span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//秒杀进行中</span></span><br><span class="javascript">		$(<span class="hljs-string">&quot;#buyButton&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-literal">false</span>);</span><br><span class="javascript">		<span class="hljs-keyword">if</span>(timeout)&#123;</span><br><span class="javascript">			<span class="hljs-built_in">clearTimeout</span>(timeout);</span><br>		&#125;<br><span class="javascript">		$(<span class="hljs-string">&quot;#miaoshaTip&quot;</span>).html(<span class="hljs-string">&quot;秒杀进行中&quot;</span>);</span><br><span class="javascript">	&#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">//秒杀已经结束</span></span><br><span class="javascript">		$(<span class="hljs-string">&quot;#buyButton&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-literal">true</span>);</span><br><span class="javascript">		$(<span class="hljs-string">&quot;#miaoshaTip&quot;</span>).html(<span class="hljs-string">&quot;秒杀已经结束&quot;</span>);</span><br>	&#125;<br>&#125;<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>其中使用了获得url路径中参数的方法g_getQueryString()，该方法在commons.js中定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 获取url参数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">g_getQueryString</span>(<span class="hljs-params">name</span>) </span>&#123;<br>	<span class="hljs-keyword">var</span> reg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">&quot;(^|&amp;)&quot;</span> + name + <span class="hljs-string">&quot;=([^&amp;]*)(&amp;|$)&quot;</span>);<br>	<span class="hljs-keyword">var</span> r = <span class="hljs-built_in">window</span>.location.search.substr(<span class="hljs-number">1</span>).match(reg);<br>	<span class="hljs-keyword">if</span>(r != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">unescape</span>(r[<span class="hljs-number">2</span>]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;;<br><span class="hljs-comment">//设定时间格式化函数，使用new Date().format(&quot;yyyyMMddhhmmss&quot;);</span><br><span class="hljs-built_in">Date</span>.prototype.format = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">format</span>) </span>&#123;<br>	<span class="hljs-keyword">var</span> args = &#123;<br>		<span class="hljs-string">&quot;M+&quot;</span>: <span class="hljs-built_in">this</span>.getMonth() + <span class="hljs-number">1</span>,<br>		<span class="hljs-string">&quot;d+&quot;</span>: <span class="hljs-built_in">this</span>.getDate(),<br>		<span class="hljs-string">&quot;h+&quot;</span>: <span class="hljs-built_in">this</span>.getHours(),<br>		<span class="hljs-string">&quot;m+&quot;</span>: <span class="hljs-built_in">this</span>.getMinutes(),<br>		<span class="hljs-string">&quot;s+&quot;</span>: <span class="hljs-built_in">this</span>.getSeconds(),<br>	&#125;;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/(y+)/</span>.test(format))<br>		format = format.replace(<span class="hljs-built_in">RegExp</span>.$1, (<span class="hljs-built_in">this</span>.getFullYear() + <span class="hljs-string">&quot;&quot;</span>).substr(<span class="hljs-number">4</span> - <span class="hljs-built_in">RegExp</span>.$1.length));<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> args) &#123;<br>		<span class="hljs-keyword">var</span> n = args[i];<br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">&quot;(&quot;</span> + i + <span class="hljs-string">&quot;)&quot;</span>).test(format))<br>			format = format.replace(<span class="hljs-built_in">RegExp</span>.$1, <span class="hljs-built_in">RegExp</span>.$1.length == <span class="hljs-number">1</span> ? n : (<span class="hljs-string">&quot;00&quot;</span> + n).substr((<span class="hljs-string">&quot;&quot;</span> + n).length));<br>	&#125;<br>	<span class="hljs-keyword">return</span> format;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>这里出现了一个问题，更新common.js文件后浏览器缓存仍然使用的原来的common.js文件，网上的解决办法是清除缓存或者在引入js文件时加入版本号，尝试都不行，最后手动更新了项目生成的target文件中的common.js文件。</p>
<h3 id="5-2-2-订单详情页"><a href="#5-2-2-订单详情页" class="headerlink" title="5.2.2 订单详情页"></a>5.2.2 订单详情页</h3><p>订单详情页的html:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;panel panel-default&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;panel-heading&quot;</span>&gt;</span>秒杀订单详情<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodslist&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;3&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodsName&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span> <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>商品图片<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span>  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;goodsImg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;200&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;200&quot;</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>订单价格<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;2&quot;</span>  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderPrice&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>     		<span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>下单时间<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        	<span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;createDate&quot;</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>     	<span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>订单状态<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderStatus&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><br>        	<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary btn-block&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;payButton&quot;</span>&gt;</span>立即支付<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>     		<span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>收货人<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        	<span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span>XXX  18812341234<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>     		<span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>收货地址<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>        	<span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span>北京市昌平区回龙观龙博一区<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">detail</span>)</span>&#123;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> goods = detail.goods;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> order = detail.order;</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#goodsName&quot;</span>).text(goods.goodsName);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#goodsImg&quot;</span>).attr(<span class="hljs-string">&quot;src&quot;</span>, goods.goodsImg);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#orderPrice&quot;</span>).text(order.goodsPrice);</span><br><span class="javascript">	$(<span class="hljs-string">&quot;#createDate&quot;</span>).text(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(order.createDate).format(<span class="hljs-string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span><br><span class="javascript">	<span class="hljs-keyword">var</span> status = <span class="hljs-string">&quot;&quot;</span>;</span><br><span class="javascript">	<span class="hljs-keyword">if</span>(order.status == <span class="hljs-number">0</span>)&#123;</span><br><span class="javascript">		status = <span class="hljs-string">&quot;未支付&quot;</span></span><br><span class="javascript">	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(order.status == <span class="hljs-number">1</span>)&#123;</span><br><span class="javascript">		status = <span class="hljs-string">&quot;待发货&quot;</span>;</span><br>	&#125;<br><span class="javascript">	$(<span class="hljs-string">&quot;#orderStatus&quot;</span>).text(status);</span><br>	<br>&#125;<br><br><span class="javascript">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br>	getOrderDetail();<br>&#125;)<br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOrderDetail</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">	<span class="hljs-keyword">var</span> orderId = g_getQueryString(<span class="hljs-string">&quot;orderId&quot;</span>);</span><br><span class="javascript">	$.ajax(&#123;</span><br><span class="javascript">		url:<span class="hljs-string">&quot;/order/detail&quot;</span>,</span><br><span class="javascript">		type:<span class="hljs-string">&quot;GET&quot;</span>,</span><br>		data:&#123;<br>			orderId:orderId<br>		&#125;,<br><span class="javascript">		success:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;</span><br><span class="javascript">			<span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>)&#123;</span><br>				render(data.data);<br><span class="javascript">			&#125;<span class="hljs-keyword">else</span>&#123;</span><br>				layer.msg(data.msg);<br>			&#125;<br>		&#125;,<br><span class="javascript">		error:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">			layer.msg(<span class="hljs-string">&quot;客户端请求有误&quot;</span>);</span><br>		&#125;<br>	&#125;);<br>&#125;<br><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>我们已经做了静态化，在开发者窗口发现get请求返回状态码的304，说明当前请求获得内容与上次相同，可以直接读取浏览器中的缓存，但这样还是与后端发生了交互，springboot中关于静态资源处理的配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#static</span><br><span class="hljs-meta">spring.resources.add-mappings</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">spring.resources.cache.period</span>= <span class="hljs-string">3600</span><br><span class="hljs-meta">spring.resources.chain.cache</span>=<span class="hljs-string">true </span><br><span class="hljs-meta">spring.resources.chain.enabled</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">spring.resources.chain.gzipped</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">spring.resources.chain.html-application-cache</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">spring.resources.static-locations</span>=<span class="hljs-string">classpath:/static/</span><br></code></pre></td></tr></table></figure>
<p>这样get请求直接返回状态码200,不会发生交互。</p>
<p>解决超卖问题：</p>
<p>现在秒杀系统中存在超卖的问题。</p>
<ol>
<li>reduceStock</li>
</ol>
<p>GoodsService减库存reduceStock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduceStock</span><span class="hljs-params">(GoodsVo goods)</span> </span>&#123;<br>    MiaoshaGoods g = <span class="hljs-keyword">new</span> MiaoshaGoods();<br>    g.setGoodsId(goods.getId());<br>    goodsDao.reduceStock(g);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>GoodsDao减库存reduceStock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Update(&quot;update miaosha_goods set stock_count = stock_count-1 where goods_id = #&#123;goodsId&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">reduceStock</span><span class="hljs-params">(MiaoshaGoods g)</span></span>;<br></code></pre></td></tr></table></figure>
<p>虽然在MiaoshaController减去库存之前判断了库存&gt;0，这里如果两个用户都走到了reduceStock，我们发现库存会从1减到-1，处理方法是在sql中加上判断防止数据为负数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Update(&quot;update miaosha_goods set stock_count = stock_count-1 where goods_id = #&#123;goodsId&#125; and stock_count &gt; 0&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">reduceStock</span><span class="hljs-params">(MiaoshaGoods g)</span></span>;<br></code></pre></td></tr></table></figure>
<p>第二个用户秒杀失败减库存失败但是仍然执行了下订单操作，会不会显示成功，因为执行reduceStock虽然库存为0，但语句本身不执行不代表异常，不会抛出异常，所以需要对减库存失败进一步判断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> OrderInfo <span class="hljs-title">miaosha</span><span class="hljs-params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;<br>       <span class="hljs-comment">//减库存</span><br>       <span class="hljs-keyword">boolean</span> success = goodsService.reduceStock(goods);<br>       <span class="hljs-comment">//生成订单</span><br>       <span class="hljs-keyword">if</span> (success)&#123;<br>           <span class="hljs-keyword">return</span> orderService.createOrder(user,goods);<br>       &#125;<span class="hljs-keyword">else</span> &#123;<br>           setGoodsOver(goods.getId());<br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>秒杀一个用户只能买一个商品，但是如果同一用户发出了两个请求，两个请求同时到达减库存，会导致同一用户重复购买，解决办法是在miaosha_order表上建立唯一索引u_uid_gid，字段为user_id，goods_id，也就是说不允许出现具有索引值相同的行，也就避免同一用户-商品的重复出现。</li>
</ol>
<h2 id="5-3-静态资源优化"><a href="#5-3-静态资源优化" class="headerlink" title="5.3 静态资源优化"></a>5.3 静态资源优化</h2><ol>
<li>JS/CSS压缩，减少流量，比如使用jquery.min.js</li>
<li>多个JS/CSS组合，减少连接数</li>
<li>CDN就近访问</li>
</ol>
<h1 id="6-接口优化"><a href="#6-接口优化" class="headerlink" title="6. 接口优化"></a>6. 接口优化</h1><h2 id="6-1-Redis预减库存减少数据库访问"><a href="#6-1-Redis预减库存减少数据库访问" class="headerlink" title="6.1 Redis预减库存减少数据库访问"></a>6.1 Redis预减库存减少数据库访问</h2><p>由于Mysql数据库抗并发能力是瓶颈，进一步优化的方案是减少数据库访问：</p>
<ol>
<li>系统初始化，把商品库存数量加载到Redis</li>
</ol>
<p>使MiaoshaController实现InitializingBean接口，该接口需要实现afterPropertiesSet()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 系统初始化</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();<br>        <span class="hljs-keyword">if</span> (goodsList == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (GoodsVo goods : goodsList) &#123;<br>            redisService.set(GoodsKey.getMiaoshaGoodsStock,<span class="hljs-string">&quot;&quot;</span>+goods.getId(),goods.getStockCount());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>收到请求，Redis预减库存，库存不足，直接返回，否则进入3（不符合条件的请求止步于redis，不会再访问mysql）</li>
<li>请求入队，立即返回排队中</li>
</ol>
<p>改写原来的miaosha()逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/do_miaosha&quot;,method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Integer&gt; <span class="hljs-title">miaosha</span><span class="hljs-params">(Model model, MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                       <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span></span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);<br>        &#125;<br>        <span class="hljs-comment">//预减库存（先从redis减去库存）</span><br>        <span class="hljs-keyword">long</span> stock = redisService.decr(GoodsKey.getMiaoshaGoodsStock,<span class="hljs-string">&quot;&quot;</span>+goodsId);<br>        <span class="hljs-keyword">if</span> (stock &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);<br>        &#125;<br>        <span class="hljs-comment">//判断是否已经秒杀到了</span><br>        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(user.getId(),goodsId);<br>        <span class="hljs-keyword">if</span> (order != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.REPEATE_MIAOSHA);<br>        &#125;<br>        <span class="hljs-comment">//入队</span><br>        MiaoshaMessage mm = <span class="hljs-keyword">new</span> MiaoshaMessage();<br>        mm.setGoodsId(goodsId);<br>        mm.setUser(user);<br>        mqSender.sendMiaoshaMessage(mm);<br>        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-number">0</span>);<span class="hljs-comment">//排队中</span><br><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>编写发送信息MQ.sender.sendMiaoshaMessage()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MQSender</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger log = LoggerFactory.getLogger(MQSender.class);<br><br>    <span class="hljs-meta">@Autowired</span><br>    AmqpTemplate amqpTemplate ;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMiaoshaMessage</span><span class="hljs-params">(MiaoshaMessage mm)</span> </span>&#123;<br>        String msg = RedisService.beanToString(mm);<br>        log.info(<span class="hljs-string">&quot;send message:&quot;</span>+msg);<br>        amqpTemplate.convertAndSend(MQConfig.MIAOSHA_QUEUE, msg);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>请求出队，生成订单，减少库存</li>
</ol>
<p>编写消息监听MQReceiver:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MQReceiver</span> </span>&#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger log = LoggerFactory.getLogger(MQReceiver.class);<br><br>    <span class="hljs-meta">@Autowired</span><br>    RedisService redisService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    GoodsService goodsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    OrderService orderService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MiaoshaService miaoshaService;<br><br>    <span class="hljs-meta">@RabbitListener(queues=MQConfig.MIAOSHA_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receive</span><span class="hljs-params">(String message)</span> </span>&#123;<br>        log.info(<span class="hljs-string">&quot;receive message:&quot;</span>+message);<br>        MiaoshaMessage mm  = RedisService.stringToBean(message, MiaoshaMessage.class);<br>        MiaoshaUser user = mm.getUser();<br>        <span class="hljs-keyword">long</span> goodsId = mm.getGoodsId();<br><br>        <span class="hljs-comment">//判断库存</span><br>        GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);<br>        <span class="hljs-keyword">int</span> stock = goods.getStockCount();<br>        <span class="hljs-keyword">if</span>(stock &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//判断是否已经秒杀到了</span><br>        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(user.getId(), goodsId);<br>        <span class="hljs-keyword">if</span>(order != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//减库存 下订单 写入秒杀订单</span><br>        miaoshaService.miaosha(user, goods);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>
<ol>
<li>客户端轮询，是否秒杀成功</li>
</ol>
<p>在MiaoshaController编写miaoshaResult用于客户端轮询返回秒杀结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * orderId:成功</span><br><span class="hljs-comment">     * -1：秒杀失败</span><br><span class="hljs-comment">     * 0：排队中</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@RequestMapping(value = &quot;/result&quot;,method = RequestMethod.GET)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Long&gt; <span class="hljs-title">miaoshaResult</span><span class="hljs-params">(Model model, MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);<br>        &#125;<br>        <span class="hljs-keyword">long</span> result = miaoshaService.getMiaoshaResult(user.getId(),goodsId);<br>        <span class="hljs-keyword">return</span> Result.success(result);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>MiaoshaService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//返回秒杀结果</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getMiaoshaResult</span><span class="hljs-params">(Long userId, <span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(userId, goodsId);<br>        <span class="hljs-comment">//秒杀成功</span><br>        <span class="hljs-keyword">if</span> (order != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> order.getOrderId();<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">boolean</span> isOver = getGoodsOver(goodsId);<br>            <span class="hljs-keyword">if</span> (isOver)&#123;<br>                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//存入库存状态信息</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setGoodsOver</span><span class="hljs-params">(Long goodsId)</span> </span>&#123;<br>        redisService.set(MiaoshaKey.isGoodsOver,<span class="hljs-string">&quot;&quot;</span>+goodsId,<span class="hljs-keyword">true</span>)<br><br><span class="hljs-comment">//返回库存状态信息</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">getGoodsOver</span><span class="hljs-params">(<span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> redisService.exists(MiaoshaKey.isGoodsOver,<span class="hljs-string">&quot;&quot;</span>+goodsId);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h2 id="6-2-内存标记减少Redis访问"><a href="#6-2-内存标记减少Redis访问" class="headerlink" title="6.2 内存标记减少Redis访问"></a>6.2 内存标记减少Redis访问</h2><p>在MiaoshaController中预减库存需要访问redis。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//预减库存</span><br><span class="hljs-keyword">long</span> stock = redisService.decr(GoodsKey.getMiaoshaGoodsStock,<span class="hljs-string">&quot;&quot;</span>+goodsId);<br></code></pre></td></tr></table></figure>
<p>每个请求都要访问redis，虽然redis相比mysql快很多，但仍然有可以优化的空间。</p>
<p>建立</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Map&lt;Long,Boolean&gt; localOverMap = <span class="hljs-keyword">new</span> HashMap&lt;Long,Boolean&gt;();<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 系统初始化</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();<br>        <span class="hljs-keyword">if</span> (goodsList == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (GoodsVo goods : goodsList) &#123;<br>            redisService.set(GoodsKey.getMiaoshaGoodsStock,<span class="hljs-string">&quot;&quot;</span>+goods.getId(),goods.getStockCount());<br>            <span class="hljs-comment">//初始化库存时标记置为false</span><br>            localOverMap.put(goods.getId(),<span class="hljs-keyword">false</span>);<br>        &#125;<br>    &#125;<br><br><br><br> <span class="hljs-meta">@RequestMapping(value = &quot;/do_miaosha&quot;,method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Integer&gt; <span class="hljs-title">miaosha</span><span class="hljs-params">(Model model, MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                       <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span></span>&#123;<br>        <span class="hljs-comment">//...</span><br><br>        <span class="hljs-comment">//内存标记，减少redis访问</span><br>        <span class="hljs-keyword">boolean</span> over = localOverMap.get(goodsId);<br>        <span class="hljs-keyword">if</span> (over)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);<br>        &#125;<br><br>        <span class="hljs-comment">//预减库存</span><br>        <span class="hljs-keyword">long</span> stock = redisService.decr(GoodsKey.getMiaoshaGoodsStock,<span class="hljs-string">&quot;&quot;</span>+goodsId);<br>        <span class="hljs-keyword">if</span> (stock &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//库存&lt;0标记置为true</span><br>            localOverMap.put(goodsId,<span class="hljs-keyword">true</span>);<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);<br>        &#125;<br>		<span class="hljs-comment">//...</span><br><br>    &#125;<br></code></pre></td></tr></table></figure>
<h2 id="6-3-Nginx水平扩展"><a href="#6-3-Nginx水平扩展" class="headerlink" title="6.3 Nginx水平扩展"></a>6.3 Nginx水平扩展</h2><p>​    nginx水平扩展是利用nginx的反向代理，一个域名配置多个解析ip，每次DNS解析请求来访问dns-server，会轮询返回这些ip。当nginx成为瓶颈的时候，只要增加服务器数量，新增nginx服务的部署，增加一个外网ip，就能扩展反向代理层的性能，做到理论上的无限高并发。</p>
<h1 id="7-安全优化"><a href="#7-安全优化" class="headerlink" title="7. 安全优化"></a>7. 安全优化</h1><h2 id="7-1-隐藏秒杀地址"><a href="#7-1-隐藏秒杀地址" class="headerlink" title="7.1 隐藏秒杀地址"></a>7.1 隐藏秒杀地址</h2><p>​        在秒杀开始之前，秒杀接口地址不要写到客户端，而是在秒杀开始之后，将秒杀地址动态地在客户端和服务器间进行交互完成拼接。这样一来，秒杀开始之前，秒杀地址对客户端不可见。</p>
<p><strong>实现思路：</strong></p>
<ul>
<li>秒杀开始之前，先去请求接口获取秒杀地址；</li>
<li>接口改造，带上<code>@pathVariable</code>参数；（MD5（UUID））</li>
<li>添加生成地址的接口；</li>
<li>秒杀收到请求，先验证<code>@pathVariable</code>参数。</li>
</ul>
<p><strong>注意：但是获取秒杀地址这个接口也有可能被恶意刷，可以使用验证码防刷。</strong></p>
<p>用户在提交获取秒杀地址的请求之前，需要将goodsId和verifyCode一同提交到服务端，服务器通过<code>@RequestParam</code>参数获取goodsId和verifyCode，然后检验验证码是否正确，如果正确，则返回秒杀地址给客户端，客户端得到秒杀地址后，拼接秒杀地址然后异步地向这个地址发出请求获取秒杀结果，这样就完成了秒杀接口地址的隐藏。</p>
<p>需要注意的是，这里需要将goodsId和verifyCode一同提交到服务端做校验，如果只提交goodsId，那么客户端仍然可以使用明文的方式获取随机生成的接口秒杀地址，但是，引入了verifyCode后，客户端需要将验证码也一起发送到服务端做验证，验证成功才返回随机生成的秒杀地址，不成功则返回非法请求，通过这样一种<strong>双重验证</strong>的方式，就可以方式用户使用不合理的手段参与秒杀，引入验证码有效地防止了这一点，因为验证码的输入需要用户真正参与进来。</p>
<ol>
<li><p>goods_detail.htm 商品详情页</p>
<p>​        修改“立即秒杀”按钮事件（秒杀时间到，才会显示立即秒杀按钮），先获取秒杀地址，再发起秒杀，后面还会加入校验图形验证码。</p>
<p>原来点击立即秒杀会执行miaosha()方法，现在修改为getMiaoshaPath():</p>
</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary btn-block&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;buyButton&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;getMiaoshaPath()&quot;</span>&gt;</span>立即秒杀<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMiaoshaPath</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> goodsId = $(<span class="hljs-string">&quot;#goodsId&quot;</span>).val();<br>        g_showLoading();<br>        $.ajax(&#123;<br>            url: <span class="hljs-string">&quot;/miaosha/path&quot;</span>,<br>            type: <span class="hljs-string">&quot;GET&quot;</span>,<br>            data: &#123;<br>                goodsId: $(<span class="hljs-string">&quot;#goodsId&quot;</span>).val(),<br>                verifyCode: $(<span class="hljs-string">&quot;#verifyCode&quot;</span>).val()<br>            &#125;,<br>            success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;<br>                <span class="hljs-keyword">if</span> (data.code == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">var</span> path = data.data;<br>                    <span class="hljs-comment">//获取路径成功执行doMiaosha()</span><br>                    doMiaosha(path);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    layer.msg(data.msg);<br>                &#125;<br>            &#125;,<br>            error: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>                layer.msg(<span class="hljs-string">&quot;客户端请求有误&quot;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>获取到秒杀地址后，才往下执行真正的秒杀操作，并把path 拼接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doMiaosha</span>(<span class="hljs-params">path</span>) </span>&#123;<br>        $.ajax(&#123;<br>            url: <span class="hljs-string">&quot;/miaosha/&quot;</span>+path+<span class="hljs-string">&quot;/do_miaosha&quot;</span>,<br>            type: <span class="hljs-string">&quot;POST&quot;</span>,<br>            data: &#123;<br>                goodsId: $(<span class="hljs-string">&quot;#goodsId&quot;</span>).val(),<br>            &#125;,<br>            success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;<br>                <span class="hljs-keyword">if</span> (data.code == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// window.location.href=&quot;/order_detail.htm?orderId=&quot;+data.data.id;</span><br>                    getMiaoshaResult($(<span class="hljs-string">&quot;#goodsId&quot;</span>).val());<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    layer.msg(data.msg);<br>                &#125;<br>            &#125;,<br>            error: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>                layer.msg(<span class="hljs-string">&quot;客户端请求有误&quot;</span>);<br>            &#125;<br>        &#125;);<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>在后端新增获取秒杀接口地址</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取秒杀接口地址</span><br><span class="hljs-comment">   * */</span><br>   <span class="hljs-meta">@RequestMapping()</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title">getMiaoshaPath</span><span class="hljs-params">(HttpServletRequest request,MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="hljs-keyword">int</span> verifyCode</span></span><br><span class="hljs-function"><span class="hljs-params">           )</span></span>&#123;<br>       <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>           <span class="hljs-keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);<br>       &#125;<br>       <span class="hljs-keyword">boolean</span> check = miaoshaService.checkVerifyCode(user,goodsId,verifyCode);<br>       <span class="hljs-keyword">if</span> (!check)&#123;<br>           <span class="hljs-keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);<br>       &#125;<br>       String path = miaoshaService.createMiaoshaPath(user,goodsId);<br>       <span class="hljs-keyword">return</span> Result.success(path);<br>   &#125;<br></code></pre></td></tr></table></figure>
<p>createMiaoshaPath():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createMiaoshaPath</span><span class="hljs-params">(MiaoshaUser user, <span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span> || goodsId &lt;= <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//通过uuid生成并MD5加密，123456为固定盐值</span><br>        String str = MD5Util.md5(UUIDUtil.uuid()+<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">//key根据用户id和商品id 生成，所以每个用户获取到的秒杀地址不一样</span><br>        redisService.set(MiaoshaKey.getMiaoshaPath,<span class="hljs-string">&quot;&quot;</span>+user.getId()+<span class="hljs-string">&quot;_&quot;</span>+goodsId,str);<br>        <span class="hljs-keyword">return</span> str;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>得到秒杀地址进行请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/&#123;path&#125;/do_miaosha&quot;,method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Integer&gt; <span class="hljs-title">miaosha</span><span class="hljs-params">(Model model, MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">                       <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId,</span></span><br><span class="hljs-function"><span class="hljs-params">                       <span class="hljs-meta">@PathVariable(&quot;path&quot;)</span>String path)</span></span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);<br>        &#125;<br>        <span class="hljs-comment">//验证path</span><br>        <span class="hljs-keyword">boolean</span> check = miaoshaService.checkPath(user,goodsId,path);<br>        <span class="hljs-keyword">if</span> (!check)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);<br>        &#125;<br>        <span class="hljs-comment">//...</span><br> &#125;<br></code></pre></td></tr></table></figure>
<p>checkPath():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkPath</span><span class="hljs-params">(MiaoshaUser user, <span class="hljs-keyword">long</span> goodsId, String path)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span> || path == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        String pathOld = redisService.get(MiaoshaKey.getMiaoshaPath,<span class="hljs-string">&quot;&quot;</span>+user.getId()+<span class="hljs-string">&quot;_&quot;</span>+goodsId,String.class);<br>        <span class="hljs-keyword">return</span> path.equals(pathOld);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h2 id="7-2-数学公式验证码"><a href="#7-2-数学公式验证码" class="headerlink" title="7.2 数学公式验证码"></a>7.2 数学公式验证码</h2><p><strong>验证码的作用：</strong></p>
<ul>
<li>防止利用机器人等手段防止非目标用户参与秒杀；</li>
<li>减少单位时间内的请求数量。对于一个秒杀商品，在开始秒杀后肯定会有许多用户参与秒杀，那么在开始秒杀的时候，用户请求数量是巨大，从而对服务器产生较大的压力，而通过验证码的方式就可以有效地将集中式的请求分散，从而达到<strong>削减请求峰值</strong>的目的。</li>
</ul>
<p><strong>实现思路：</strong></p>
<p>在服务端计算出验证码的表达式的值，存储在服务端，客户端输入验证码的表达式值，传入服务端进行验证。</p>
<ul>
<li>点击秒杀之前，向让用户输入验证码，分散用户的请求；</li>
<li>添加生成验证码的接口；</li>
<li>在获取秒杀路径的时候，验证验证码；</li>
<li>ScriptEngine的使用（用于计算验证码上的表达式）。</li>
</ul>
<p>当秒杀未开始时，商品详情页异步地向服务端发出获取商品详细信息的请求，同时，获取验证码。服务端收到获取验证码的请求后，生成验证码返回给客户端，同时，将验证码的结果存储再redis中，以便客户端发起秒杀请求时做验证码的校验。</p>
<p>比如：1秒钟进来10万个请求，与10秒钟进来10万个请求，差别很大。</p>
<ol>
<li>goods_detail.htm 商品详情</li>
</ol>
<p>添加图形验证码和输入框元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;row&quot;</span>&gt;<br>    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;form-inline&quot;</span>&gt;<br>        &lt;img id=<span class="hljs-string">&quot;verifyCodeImg&quot;</span> width=<span class="hljs-string">&quot;80&quot;</span> height=<span class="hljs-string">&quot;32&quot;</span> style=<span class="hljs-string">&quot;display: none&quot;</span> onclick=<span class="hljs-string">&quot;refreshVerifyCode()&quot;</span>/&gt;<br>        &lt;input id=<span class="hljs-string">&quot;verifyCode&quot;</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;form-control&quot;</span> style=<span class="hljs-string">&quot;display: none&quot;</span>/&gt;<br>        &lt;button <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;btn btn-primary btn-block&quot;</span> type=<span class="hljs-string">&quot;button&quot;</span> id=<span class="hljs-string">&quot;buyButton&quot;</span><br>        onclick=<span class="hljs-string">&quot;getMiaoshaPath()&quot;</span>&gt;立即秒杀<br>        &lt;/button&gt;<br>    &lt;/div&gt;<br>&lt;/div&gt;<br><br><span class="hljs-comment">//点击图片会刷新验证码，为防止浏览器缓存，需要在url添加一个时间戳</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshVerifyCode</span>(<span class="hljs-params"></span>) </span>&#123;<br>    $(<span class="hljs-string">&quot;#verifyCodeImg&quot;</span>).attr(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;/miaosha/verifyCode?	goodsId=&quot;</span>+$(<span class="hljs-string">&quot;#goodsId&quot;</span>).val()+<span class="hljs-string">&quot;&amp;timestamp=&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime());<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li><p>获取验证码js</p>
<p>获取商品详情的ajax ，渲染页面时，有个倒计时判断，在秒杀进行中增加显示验证码，在秒杀结束时隐藏验证码。</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countDown</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> remainSeconds = $(<span class="hljs-string">&quot;#remainSeconds&quot;</span>).val();<br>        <span class="hljs-keyword">var</span> timeout;<br>        <span class="hljs-keyword">if</span> (remainSeconds &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//秒杀还没开始，倒计时</span><br>            $(<span class="hljs-string">&quot;#buyButton&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-literal">true</span>);<br>            $(<span class="hljs-string">&quot;#miaoshaTip&quot;</span>).html(<span class="hljs-string">&quot;秒杀倒计时：&quot;</span> + remainSeconds + <span class="hljs-string">&quot;秒&quot;</span>);<br>            timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>                $(<span class="hljs-string">&quot;#countDown&quot;</span>).text(remainSeconds - <span class="hljs-number">1</span>);<br>                $(<span class="hljs-string">&quot;#remainSeconds&quot;</span>).val(remainSeconds - <span class="hljs-number">1</span>);<br>                countDown();<br>            &#125;, <span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (remainSeconds == <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//秒杀进行中</span><br>            $(<span class="hljs-string">&quot;#buyButton&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">if</span> (timeout) &#123;<br>                <span class="hljs-built_in">clearTimeout</span>(timeout);<br>            &#125;<br>            $(<span class="hljs-string">&quot;#miaoshaTip&quot;</span>).html(<span class="hljs-string">&quot;秒杀进行中&quot;</span>);<br>            <span class="hljs-comment">//显示图片</span><br>            $(<span class="hljs-string">&quot;#verifyCodeImg&quot;</span>).attr(<span class="hljs-string">&quot;src&quot;</span>, <span class="hljs-string">&quot;/miaosha/verifyCode?goodsId=&quot;</span>+$(<span class="hljs-string">&quot;#goodsId&quot;</span>).val());<br>            $(<span class="hljs-string">&quot;#verifyCodeImg&quot;</span>).show();<br>            <span class="hljs-comment">//显示验证码图片和输入框</span><br>            $(<span class="hljs-string">&quot;#verifyCode&quot;</span>).show();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//秒杀已经结束</span><br>            $(<span class="hljs-string">&quot;#buyButton&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-literal">true</span>);<br>            $(<span class="hljs-string">&quot;#miaoshaTip&quot;</span>).html(<span class="hljs-string">&quot;秒杀已经结束&quot;</span>);<br>             <span class="hljs-comment">//隐藏验证码图片和输入框</span><br>            $(<span class="hljs-string">&quot;#verifyCodeImg&quot;</span>).hide();<br>            $(<span class="hljs-string">&quot;#verifyCode&quot;</span>).hide();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>新增获取图形验证码接口</li>
</ol>
<p>使用 jdk 自带的一个 BufferedImage，使用OutputStream 输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取图形验证码</span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-meta">@RequestMapping(value = &quot;/verifyCode&quot;,method = RequestMethod.GET)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title">getMiaoshaVerifyCode</span><span class="hljs-params">(HttpServletResponse response, MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">             <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId)</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            BufferedImage image = miaoshaService.createVerifyCode(user,goodsId);<br>            <span class="hljs-comment">//通过response返回</span><br>            OutputStream out = response.getOutputStream();<br>            ImageIO.write(image,<span class="hljs-string">&quot;JPEG&quot;</span>,out);<br>            out.flush();<br>            out.close();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.MIAOSHA_FAIL);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>创建图形验证码逻辑</li>
</ol>
<p>先构建一个图（长、宽、格式），再分别设置颜色、背景等；</p>
<p>再生成一个加减乘除的表达式，并设置到图形中，最后计算表达式的值并设置到redis缓存中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//生成验证码</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> BufferedImage <span class="hljs-title">createVerifyCode</span><span class="hljs-params">(MiaoshaUser user, <span class="hljs-keyword">long</span> goodsId)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(user == <span class="hljs-keyword">null</span> || goodsId &lt;=<span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">int</span> width = <span class="hljs-number">80</span>;<br>        <span class="hljs-keyword">int</span> height = <span class="hljs-number">32</span>;<br>        <span class="hljs-comment">//create the image</span><br>        BufferedImage image = <span class="hljs-keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);<br>        Graphics g = image.getGraphics();<br>        <span class="hljs-comment">// set the background color</span><br>        g.setColor(<span class="hljs-keyword">new</span> Color(<span class="hljs-number">0xDCDCDC</span>));<br>        g.fillRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br>        <span class="hljs-comment">// draw the border</span><br>        g.setColor(Color.black);<br>        g.drawRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width - <span class="hljs-number">1</span>, height - <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// create a random instance to generate the codes</span><br>        Random rdm = <span class="hljs-keyword">new</span> Random();<br>        <span class="hljs-comment">// make some confusion</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) &#123;<br>            <span class="hljs-keyword">int</span> x = rdm.nextInt(width);<br>            <span class="hljs-keyword">int</span> y = rdm.nextInt(height);<br>            g.drawOval(x, y, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-comment">// generate a random code</span><br>        String verifyCode = generateVerifyCode(rdm);<br>        g.setColor(<span class="hljs-keyword">new</span> Color(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0</span>));<br>        g.setFont(<span class="hljs-keyword">new</span> Font(<span class="hljs-string">&quot;Candara&quot;</span>, Font.BOLD, <span class="hljs-number">24</span>));<br>        g.drawString(verifyCode, <span class="hljs-number">8</span>, <span class="hljs-number">24</span>);<br>        g.dispose();<br>        <span class="hljs-comment">//把验证码存到redis中</span><br>        <span class="hljs-keyword">int</span> rnd = calc(verifyCode);<br>        redisService.set(MiaoshaKey.getMiaoshaVerifyCode, user.getId()+<span class="hljs-string">&quot;,&quot;</span>+goodsId, rnd);<br>        <span class="hljs-comment">//输出图片</span><br>        <span class="hljs-keyword">return</span> image;<br>    &#125;<br><br>	<span class="hljs-comment">//js计算验证码</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">calc</span><span class="hljs-params">(String exp)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ScriptEngineManager manager = <span class="hljs-keyword">new</span> ScriptEngineManager();<br>            ScriptEngine engine = manager.getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>);<br>            <span class="hljs-keyword">return</span> (Integer)engine.eval(exp);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span>[] ops = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[] &#123;<span class="hljs-string">&#x27;+&#x27;</span>, <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>&#125;;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加减乘的公式</span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">generateVerifyCode</span><span class="hljs-params">(Random rdm)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> num1 = rdm.nextInt(<span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">int</span> num2 = rdm.nextInt(<span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">int</span> num3 = rdm.nextInt(<span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">char</span> op1 = ops[rdm.nextInt(<span class="hljs-number">3</span>)];<br>        <span class="hljs-keyword">char</span> op2 = ops[rdm.nextInt(<span class="hljs-number">3</span>)];<br>        String exp = <span class="hljs-string">&quot;&quot;</span>+ num1 + op1 + num2 + op2 + num3;<br>        <span class="hljs-keyword">return</span> exp;<br>    &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li><p>校验</p>
<p>a. 获取秒杀地址ajax,增加用户输入的计算好的验证码参数，因为用户点击“立即秒杀”，需要先去获取秒杀地址，才会往下执行真正的秒杀操作。顺序：验证码 —&gt; 秒杀地址  —&gt; 秒杀  （在获取秒杀地址接口中，校验验证码）</p>
<p>b.     获取秒杀地址，校验验证码的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 获取秒杀接口地址</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@RequestMapping(value = &quot;/path&quot;,method = RequestMethod.GET)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title">getMiaoshaPath</span><span class="hljs-params">(HttpServletRequest request,MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">             <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId,</span></span><br><span class="hljs-function"><span class="hljs-params">             <span class="hljs-meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="hljs-keyword">int</span> verifyCode</span></span><br><span class="hljs-function"><span class="hljs-params">            )</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);<br>        &#125;<br>        <span class="hljs-comment">//检验校验码</span><br>        <span class="hljs-keyword">boolean</span> check = miaoshaService.checkVerifyCode(user,goodsId,verifyCode);<br>        <span class="hljs-keyword">if</span> (!check)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);<br>        &#125;<br>        String path = miaoshaService.createMiaoshaPath(user,goodsId);<br>        <span class="hljs-keyword">return</span> Result.success(path);<br>    &#125;<br><br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 校验方法</span><br><span class="hljs-comment">    * */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkVerifyCode</span><span class="hljs-params">(MiaoshaUser user, <span class="hljs-keyword">long</span> goodsId, <span class="hljs-keyword">int</span> verifyCode)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(user == <span class="hljs-keyword">null</span> || goodsId &lt;=<span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        Integer codeOld = redisService.get(MiaoshaKey.getMiaoshaVerifyCode, user.getId()+<span class="hljs-string">&quot;,&quot;</span>+goodsId, Integer.class);<br>        <span class="hljs-keyword">if</span>(codeOld == <span class="hljs-keyword">null</span> || codeOld - verifyCode != <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        redisService.delete(MiaoshaKey.getMiaoshaVerifyCode, user.getId()+<span class="hljs-string">&quot;,&quot;</span>+goodsId);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="7-3-接口限流防刷"><a href="#7-3-接口限流防刷" class="headerlink" title="7.3 接口限流防刷"></a>7.3 接口限流防刷</h2><p><strong>接口限流作用</strong></p>
<ul>
<li>对用户的访问进行一定的限制，就可以减轻服务器压力。例如通过访问次数的限制就是一种限流防刷的手段。即限制用户下一定的时间间隔内对接口的访问次数。</li>
</ul>
<p><strong>实现思路</strong></p>
<ul>
<li><p>如果使用计时器来做这个功能，实现起来比较复杂。可以充分利用<strong>redis</strong>中的key-value过期机制来完成。</p>
</li>
<li><p>在redis中存储一个用于记录访问次数的变量，在过期时间内被继续访问，则次数变量加1，如果在过期时间内访问次数超出限制，则返回“频繁提交提示用户”。过期时间到了之后，将该变量删除。</p>
</li>
<li><p>因为可能需要对很多接口对限流防刷操作，如果对每一个接口都实现一遍限流防刷，则会导致代码过度冗余，因此，可以定义一个方法拦截器<code>@AccessInterceptor</code>拦截用户对接口的请求，统一对拦截限流逻辑处理，这样可以有效地减少代码的冗余。针对需要拦截请求的接口，添加注解<code>@AccessLimit</code>即可。</p>
</li>
</ul>
<p>在获取秒杀地址接口中增加限制，位于校验验证码之前每次访问加1，超过5次返回“操作台频繁”</p>
<p>设置到redis,key : 当前获取秒杀地址请求的url + 用户id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 获取秒杀接口地址</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@RequestMapping(value = &quot;/path&quot;,method = RequestMethod.GET)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title">getMiaoshaPath</span><span class="hljs-params">(HttpServletRequest request,MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">             <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId,</span></span><br><span class="hljs-function"><span class="hljs-params">             <span class="hljs-meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="hljs-keyword">int</span> verifyCode</span></span><br><span class="hljs-function"><span class="hljs-params">            )</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);<br>        &#125;<br>        <span class="hljs-comment">//查询访问次数</span><br>        String uri = request.getRequestURI();<br>        String key = uri + <span class="hljs-string">&quot;_&quot;</span> +user.getId();<br>        Interget count = redisService.get(AccressKey.access,key,Integer.class);<br>        <span class="hljs-keyword">if</span>(count == <span class="hljs-keyword">null</span>)&#123;<br>        	redisService.set(AccressKey.access,key,<span class="hljs-number">1</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(count &lt; <span class="hljs-number">5</span>)&#123;<br>        	redisService.incrAccressKey.access,key);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>        	Result.error(CodeMsg.ACCESS_LIMIT_REACHED);<br>        &#125;<br>        <br>        <br>        <span class="hljs-keyword">boolean</span> check = miaoshaService.checkVerifyCode(user,goodsId,verifyCode);<br>        <span class="hljs-keyword">if</span> (!check)&#123;<br>            <span class="hljs-keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);<br>        &#125;<br>        String path = miaoshaService.createMiaoshaPath(user,goodsId);<br>        <span class="hljs-keyword">return</span> Result.success(path);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>​        如果秒杀接口、获取秒杀结果接口等也要限制，每个方法都要写这样的逻辑，所以需要写一个通用的方法，比如注解+拦截器。</p>
<ol>
<li>直接在controller方法上加注解即可：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 获取秒杀接口地址</span><br><span class="hljs-comment">    * */</span><br><span class="hljs-comment">//</span><br>    <span class="hljs-meta">@AccessLimit(seconds = 5,maxCount = 5,needLogin = true)</span><br>    <span class="hljs-meta">@RequestMapping(value = &quot;/path&quot;,method = RequestMethod.GET)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title">getMiaoshaPath</span><span class="hljs-params">(HttpServletRequest request,MiaoshaUser user,</span></span><br><span class="hljs-function"><span class="hljs-params">             <span class="hljs-meta">@RequestParam(&quot;goodsId&quot;)</span><span class="hljs-keyword">long</span> goodsId,</span></span><br><span class="hljs-function"><span class="hljs-params">             <span class="hljs-meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="hljs-keyword">int</span> verifyCode</span></span><br><span class="hljs-function"><span class="hljs-params">            )</span></span>&#123;<br>        <span class="hljs-comment">//...</span><br>    &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>新建AccessLimit 限流注解</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AccessLimit &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">seconds</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">maxCount</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">needLogin</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">true</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>新增拦截器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessInterceptor</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title">HandlerInterceptorAdapter</span></span>&#123;<br>	<br>	<span class="hljs-meta">@Autowired</span><br>	MiaoshaUserService userService;<br>	<br>	<span class="hljs-meta">@Autowired</span><br>	RedisService redisService;<br>	<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="hljs-function">			<span class="hljs-keyword">throws</span> Exception </span>&#123;<br>		<span class="hljs-keyword">if</span>(handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>			MiaoshaUser user = getUser(request, response);<br>			UserContext.setUser(user);<br>			HandlerMethod hm = (HandlerMethod)handler;<br>			AccessLimit accessLimit = hm.getMethodAnnotation(AccessLimit.class);<br>			<span class="hljs-keyword">if</span>(accessLimit == <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>			&#125;<br>			<span class="hljs-keyword">int</span> seconds = accessLimit.seconds();<br>			<span class="hljs-keyword">int</span> maxCount = accessLimit.maxCount();<br>			<span class="hljs-keyword">boolean</span> needLogin = accessLimit.needLogin();<br>			String key = request.getRequestURI();<br>			<span class="hljs-keyword">if</span>(needLogin) &#123;<br>				<span class="hljs-keyword">if</span>(user == <span class="hljs-keyword">null</span>) &#123;<br>					render(response, CodeMsg.SESSION_ERROR);<br>					<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>				&#125;<br>				key += <span class="hljs-string">&quot;_&quot;</span> + user.getId();<br>			&#125;<span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-comment">//do nothing</span><br>			&#125;<br>			AccessKey ak = AccessKey.withExpire(seconds);<br>			Integer count = redisService.get(ak, key, Integer.class);<br>	    	<span class="hljs-keyword">if</span>(count  == <span class="hljs-keyword">null</span>) &#123;<br>	    		 redisService.set(ak, key, <span class="hljs-number">1</span>);<br>	    	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(count &lt; maxCount) &#123;<br>	    		 redisService.incr(ak, key);<br>	    	&#125;<span class="hljs-keyword">else</span> &#123;<br>	    		render(response, CodeMsg.ACCESS_LIMIT_REACHED);<br>	    		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>	    	&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>	&#125;<br>	<br>    <span class="hljs-comment">//限流提醒</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">render</span><span class="hljs-params">(HttpServletResponse response, CodeMsg cm)</span><span class="hljs-keyword">throws</span> Exception </span>&#123;<br>		response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>		OutputStream out = response.getOutputStream();<br>		String str  = JSON.toJSONString(Result.error(cm));<br>		out.write(str.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>		out.flush();<br>		out.close();<br>	&#125;<br><br>    <span class="hljs-comment">//getUser()和getCookieValue()从之前的拦截器拷贝得来</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> MiaoshaUser <span class="hljs-title">getUser</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;<br>		String paramToken = request.getParameter(MiaoshaUserService.COOKIE_NAME_TOKEN);<br>		String cookieToken = getCookieValue(request, MiaoshaUserService.COOKIE_NAME_TOKEN);<br>		<span class="hljs-keyword">if</span>(StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(paramToken)) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>		&#125;<br>		String token = StringUtils.isEmpty(paramToken)?cookieToken:paramToken;<br>		<span class="hljs-keyword">return</span> userService.getByToken(response, token);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getCookieValue</span><span class="hljs-params">(HttpServletRequest request, String cookiName)</span> </span>&#123;<br>		Cookie[]  cookies = request.getCookies();<br>		<span class="hljs-keyword">if</span>(cookies == <span class="hljs-keyword">null</span> || cookies.length &lt;= <span class="hljs-number">0</span>)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(Cookie cookie : cookies) &#123;<br>			<span class="hljs-keyword">if</span>(cookie.getName().equals(cookiName)) &#123;<br>				<span class="hljs-keyword">return</span> cookie.getValue();<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>
<p>拦截器中使用了之前的拦截器UserArgumentResolver中的getUser()和getCookieValue()方法。但是这样就会有重复的代码，所以再次优化：</p>
<p>上面获取到MiaoshaUser对象之后，再设置到一个ThreadLocal 本地变量中（多线程）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserContext</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;MiaoshaUser&gt; userHolder = <span class="hljs-keyword">new</span> ThreadLocal&lt;MiaoshaUser&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUser</span><span class="hljs-params">(MiaoshaUser user)</span></span>&#123;<br>        userHolder.set(user);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MiaoshaUser <span class="hljs-title">getUser</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userHolder.get();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>之前的UserArgumentResolver 则直接调用UserContext.getUser即可</p>
<ol>
<li>注册拦截器</li>
</ol>
<p>在WebConfig中注册拦截器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;<br>	registry.addInterceptor(accessInterceptor);<br>&#125;<br></code></pre></td></tr></table></figure>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a>
                    
                      <a class="hover-with-bg" href="/tags/%E7%A7%92%E6%9D%80/">秒杀</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/02/02/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">二叉树遍历方法总结</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js" ></script>

  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
