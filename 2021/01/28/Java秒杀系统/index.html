<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Java秒杀系统 | FreeThinking's Blog</title><meta name="keywords" content="项目,秒杀"><meta name="author" content="醉心"><meta name="copyright" content="醉心"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="记录Java秒杀系统的设计与实现">
<meta property="og:type" content="article">
<meta property="og:title" content="Java秒杀系统">
<meta property="og:url" content="http://lishuaiyun.cn/2021/01/28/Java%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="FreeThinking&#39;s Blog">
<meta property="og:description" content="记录Java秒杀系统的设计与实现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-01-28T13:35:25.000Z">
<meta property="article:modified_time" content="2022-03-26T13:14:28.473Z">
<meta property="article:author" content="醉心">
<meta property="article:tag" content="项目">
<meta property="article:tag" content="秒杀">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://lishuaiyun.cn/2021/01/28/Java%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6c47dd0d742bb2bae474dc52a61f87e0";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java秒杀系统',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-26 21:14:28'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="FreeThinking's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">FreeThinking's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Java秒杀系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-01-28T13:35:25.000Z" title="发表于 2021-01-28 21:35:25">2021-01-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-26T13:14:28.473Z" title="更新于 2022-03-26 21:14:28">2022-03-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>77分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Java秒杀系统"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-项目框架搭建"><a href="#1-项目框架搭建" class="headerlink" title="1. 项目框架搭建"></a>1. 项目框架搭建</h1><h2 id="1-1-配置SpringBoot"><a href="#1-1-配置SpringBoot" class="headerlink" title="1.1 配置SpringBoot"></a>1.1 配置SpringBoot</h2><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>编写启动类（放在与其它包同名目录下）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span><span class="comment">// same as @Configuration @EnableAutoConfiguration @ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisService redisService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/thymeleaf&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">thymeleaf</span><span class="params">(Model model)</span></span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;shuaiyun&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/db/get&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;User&gt; <span class="title">dbGet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = userService.getById(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.success(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/redis/get&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;User&gt; <span class="title">redisGet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        redisService.get</span><br><span class="line">        <span class="keyword">return</span> Result.success(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-配置Mybatis"><a href="#1-2-配置Mybatis" class="headerlink" title="1.2 配置Mybatis"></a>1.2 配置Mybatis</h2><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mybatis</span></span><br><span class="line"><span class="meta">mybatis.type-aliases-package</span>=<span class="string">com.mooc.miaosha.domain</span></span><br><span class="line"><span class="meta">mybatis.configuration.map-underscore-to-camel-case</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">mybatis.configuration.default-fetch-size</span>=<span class="string">100</span></span><br><span class="line"><span class="meta">mybatis.configuration.default-statement-timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="meta">mybatis.mapperLocations</span> = <span class="string">classpath:com/mooc/miaosha/dao/*.xml</span></span><br><span class="line"><span class="comment"># druid</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/miaosha?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line"><span class="comment">#spring.datasource.url=jdbc:mysql://192.168.120.7:3306/miaosha?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line"><span class="meta">spring.datasource.druid.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.druid.password</span>=<span class="string">shuaiyun</span></span><br><span class="line"><span class="meta">spring.datasource.druid.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.datasource.druid.filters</span>=<span class="string">stat</span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-active</span>=<span class="string">100</span></span><br><span class="line"><span class="meta">spring.datasource.druid.initial-size</span>=<span class="string">50</span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-wait</span>=<span class="string">60000</span></span><br><span class="line"><span class="meta">spring.datasource.druid.min-idle</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">spring.datasource.druid.time-between-eviction-runs-millis</span>=<span class="string">60000</span></span><br><span class="line"><span class="meta">spring.datasource.druid.min-evictable-idle-time-millis</span>=<span class="string">300000</span></span><br><span class="line"><span class="meta">spring.datasource.druid.validation-query</span>=<span class="string">select &#x27;x&#x27;</span></span><br><span class="line"><span class="meta">spring.datasource.druid.test-while-idle</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.datasource.druid.test-on-borrow</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.datasource.druid.test-on-return</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.datasource.druid.pool-prepared-statements</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-open-prepared-statements</span>=<span class="string">20</span></span><br></pre></td></tr></table></figure>
<p>在dao中使用注解</p>
<h2 id="1-3-配置Redis"><a href="#1-3-配置Redis" class="headerlink" title="1.3 配置Redis"></a>1.3 配置Redis</h2><p>在centos上安装redis</p>
<p>先跳转到相应目录</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/usr/</span>leyou<span class="regexp">/redis/</span>bin</span><br></pre></td></tr></table></figure>
<p>以指定配置文件启动：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">redis</span></span>-server ../redis.conf</span><br></pre></td></tr></table></figure>
<p>若没有密码可设置密码</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">客户端登录：</span><br><span class="line">redis-cli</span><br><span class="line">客户端使用config get requirepass命令查看密码：</span><br><span class="line">config get requirepass</span><br><span class="line">客户端使用config set requirepass yourpassword命令设置密码：</span><br><span class="line">config set requirepass <span class="number">123456</span></span><br><span class="line">进入utils文件夹运行install_server.sh分别配置启动文件，日志文件，数据存放目录：</span><br><span class="line"><span class="regexp">/usr/</span>leyou<span class="regexp">/redis/</span>redis.conf</span><br><span class="line"><span class="regexp">/usr/</span>leyou<span class="regexp">/redis/</span>redis.log</span><br><span class="line"><span class="regexp">/usr/</span>leyou<span class="regexp">/redis/</span>data</span><br></pre></td></tr></table></figure>
<p>引入jedis和fastjson依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##redis</span></span><br><span class="line"><span class="meta">redis.host</span>=<span class="string">192.168.120.7</span></span><br><span class="line"><span class="meta">redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="meta">redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="meta">redis.timeout</span>=<span class="string">100</span></span><br><span class="line"><span class="meta">redis.poolMaxTotal</span>=<span class="string">1000</span></span><br><span class="line"><span class="meta">redis.poolMaxIdle</span>=<span class="string">500</span></span><br><span class="line"><span class="meta">redis.poolMaxWait</span>=<span class="string">500</span></span><br></pre></td></tr></table></figure>
<p>教程的配置文件如上，但会报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.exceptions</span><span class="selector-class">.JedisConnectionException</span>: Could not get <span class="selector-tag">a</span> resource from the pool</span><br><span class="line">at redis<span class="selector-class">.clients</span><span class="selector-class">.util</span><span class="selector-class">.Pool</span>.getResource(Pool<span class="selector-class">.java</span>:<span class="number">22</span>)</span><br><span class="line">at Workers<span class="selector-class">.Worker1</span>.met1(Worker1<span class="selector-class">.java</span>:<span class="number">124</span>)</span><br><span class="line">at Workers<span class="selector-class">.Worker1</span>.work(Worker1<span class="selector-class">.java</span>:<span class="number">108</span>)</span><br><span class="line">at org<span class="selector-class">.gearman</span><span class="selector-class">.impl</span><span class="selector-class">.worker</span>.WorkerConnectionController$<span class="number">3</span>.run(Unknown Source)</span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span>.runWorker(Unknown Source)</span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$Worker</span>.run(Unknown Source)</span><br><span class="line">at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span>.run(Unknown Source)  </span><br></pre></td></tr></table></figure>
<p>并且properties文件提示无法解析，修改为：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">192.168.120.7</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">100</span></span><br><span class="line"><span class="meta">spring.redis.poolMaxTotal</span>=<span class="string">1000</span></span><br><span class="line"><span class="meta">spring.redis.poolMaxIdle</span>=<span class="string">500</span></span><br><span class="line"><span class="meta">spring.redis.poolMaxWait</span>=<span class="string">500</span></span><br></pre></td></tr></table></figure>
<p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.redis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> timeout;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> poolMaxTotal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> poolMaxIdle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> poolMaxWait;</span><br><span class="line">    <span class="comment">//getter和setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写方法返回连接池对象并且注入到容器,使用@Bean注解并且返回JedisPool对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisPoolFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisConfig redisConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisPool <span class="title">jedisPoolFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        poolConfig.setMaxTotal(redisConfig.getPoolMaxTotal());</span><br><span class="line">        poolConfig.setMaxIdle(redisConfig.getPoolMaxIdle());</span><br><span class="line">        poolConfig.setMaxWaitMillis(redisConfig.getPoolMaxWait() * <span class="number">1000</span>);</span><br><span class="line">        JedisPool jp = <span class="keyword">new</span> JedisPool(poolConfig, redisConfig.getHost(), redisConfig.getPort(), redisConfig.getTimeout()*<span class="number">1000</span>, redisConfig.getPassword(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> jp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写redisService</p>
<p>向redis中存数据使用String，格式是key-value</p>
<p>因此存放时要将value转换为String类型，取出时将String转换为普通类，这一过程使用了fastjson进行转换，还要使用泛型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JedisPool jedisPool;<span class="comment">//容器中已经被注入</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取redis数据</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(String key,Class&lt;T&gt; clazz)</span></span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            <span class="comment">//生成真正的key</span></span><br><span class="line">            <span class="comment">//String realkey = prefix.getPrefix() + key;</span></span><br><span class="line">            <span class="comment">//String str = jedis.get(realkey);</span></span><br><span class="line">            String str = jedis.get(key);</span><br><span class="line">            T t = stringToBean(str,clazz);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            returnToPool(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向redis中添加数据</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key,T value)</span></span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            String str = beanToString(value);</span><br><span class="line">            <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.length() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            //生成真正的key</span></span><br><span class="line"><span class="comment">            String realkey = prefix.getPrefix() + key;</span></span><br><span class="line"><span class="comment">            int seconds = prefix.expireSeconds();</span></span><br><span class="line"><span class="comment">            if (seconds &lt;= 0) &#123;</span></span><br><span class="line"><span class="comment">                jedis.set(realkey, str);</span></span><br><span class="line"><span class="comment">            &#125; else &#123;</span></span><br><span class="line"><span class="comment">            	//setex设置过期时间</span></span><br><span class="line"><span class="comment">                jedis.setex(realkey, seconds, str);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            return true;</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            jedis.set(key,str);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            returnToPool(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将value转换为基本数据类型或json（对象转换为json）</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">String <span class="title">beanToString</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(value == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//?泛型通配符</span></span><br><span class="line">        Class&lt;?&gt; clazz = value.getClass();</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">int</span>.class || clazz == Integer.class)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>+value;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (clazz == String.class)&#123;</span><br><span class="line">            <span class="keyword">return</span> (String)value;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (clazz == <span class="keyword">long</span>.class || clazz == Long.class)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>+value;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JSON.toJSONString(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将json转换为基础数据类型或普通类</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">stringToBean</span><span class="params">(String str,Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.length() &lt;= <span class="number">0</span> || clazz == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">int</span>.class || clazz == Integer.class)&#123;</span><br><span class="line">            <span class="keyword">return</span> (T)Integer.valueOf(str);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (clazz == String.class)&#123;</span><br><span class="line">            <span class="keyword">return</span> (T) str;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (clazz == <span class="keyword">long</span>.class || clazz == Long.class)&#123;</span><br><span class="line">            <span class="keyword">return</span> (T)Long.valueOf(str);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JSON.toJavaObject(JSON.parseObject(str),clazz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//归还redis连接池连接</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">returnToPool</span><span class="params">(Jedis jedis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)&#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在还有问题，随着项目中的模块越来越多，需要的缓存也越来越多，如商品id，订单id，用户id等，此时若是id出现重复，将给系统带来错误。解决方法是利用一个前缀来规定不同模块的缓存的key，这样不同模块之间就不会重复。</p>
<p>增加前缀使用设计模式<strong>模板方法模式</strong>编写，即</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">接口<span class="comment">------KeyPrefix</span></span><br><span class="line">|</span><br><span class="line">抽象类<span class="comment">-----BasePrefix</span></span><br><span class="line">|</span><br><span class="line">实现类 <span class="comment">-----UserKey</span></span><br></pre></td></tr></table></figure>
<p>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyPrefix</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">expireSeconds</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抽象类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePrefix</span> <span class="keyword">implements</span> <span class="title">KeyPrefix</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireSeconds;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prefix;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasePrefix</span><span class="params">(String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="number">0</span>,prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasePrefix</span><span class="params">(<span class="keyword">int</span> expireSeconds,String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expireSeconds = expireSeconds;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">expireSeconds</span><span class="params">()</span> </span>&#123;<span class="comment">//默认0代表永不过期</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String className = getClass().getSimpleName();</span><br><span class="line">        <span class="keyword">return</span> className + <span class="string">&quot;:&quot;</span> + prefix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserKey</span> <span class="keyword">extends</span> <span class="title">BasePrefix</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UserKey</span><span class="params">(String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UserKey</span><span class="params">(<span class="keyword">int</span> expireSeconds,String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(expireSeconds, prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserKey getById = <span class="keyword">new</span> UserKey(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserKey getByName = <span class="keyword">new</span> UserKey(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改原有的service类，在set或get之前加上前缀。</p>
<p>编写完成后的测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/redis/set&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title">redisSet</span><span class="params">()</span></span>&#123;</span><br><span class="line">       User user = <span class="keyword">new</span> User();</span><br><span class="line">       user.setId(<span class="number">1</span>);</span><br><span class="line">       user.setName(<span class="string">&quot;1111&quot;</span>);</span><br><span class="line">       redisService.set(UserKey.getById,<span class="string">&quot;&quot;</span> + <span class="number">1</span>,user);</span><br><span class="line">       <span class="keyword">return</span> Result.success(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@RequestMapping(&quot;/redis/get&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Result&lt;User&gt; <span class="title">redisGet</span><span class="params">()</span></span>&#123;</span><br><span class="line">       User user = redisService.get(UserKey.getById,<span class="string">&quot;1&quot;</span>,User.class);</span><br><span class="line">       <span class="keyword">return</span> Result.success(user);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-实现登录功能"><a href="#2-实现登录功能" class="headerlink" title="2. 实现登录功能"></a>2. 实现登录功能</h1><h2 id="2-1-数据库设计"><a href="#2-1-数据库设计" class="headerlink" title="2.1 数据库设计"></a>2.1 数据库设计</h2><p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `miaosha_user` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户ID，手机号码&#x27;</span>,</span><br><span class="line">  `nickname` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;MD5(MD5(pass明文+固定salt) + salt)&#x27;</span>,</span><br><span class="line">  `salt` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `head` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像，云存储的ID&#x27;</span>,</span><br><span class="line">  `register_date` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册时间&#x27;</span>,</span><br><span class="line">  `last_login_date` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;上蔟登录时间&#x27;</span>,</span><br><span class="line">  `login_count` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;登录次数&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">18912341236</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure>
<h2 id="2-2-密码两次MD5处理"><a href="#2-2-密码两次MD5处理" class="headerlink" title="2.2 密码两次MD5处理"></a>2.2 密码两次MD5处理</h2><p>编写MD5加密类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MD5Util</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">md5</span><span class="params">(String src)</span></span>&#123;</span><br><span class="line">        <span class="comment">//DigestUtils工具类中的md5Hex方法能够进行md5加密</span></span><br><span class="line">        <span class="keyword">return</span> DigestUtils.md5Hex(src);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置salt值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String salt = <span class="string">&quot;1a2b3c4d&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">inputPassToFormPass</span><span class="params">(String inputPass)</span></span>&#123;</span><br><span class="line">        <span class="comment">//第一次加密，将输入数据加密传输</span></span><br><span class="line">        String str = <span class="string">&quot;&quot;</span> + salt.charAt(<span class="number">0</span>) + salt.charAt(<span class="number">2</span>) + inputPass + salt.charAt(<span class="number">5</span>) + salt.charAt(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">return</span> md5(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">formPassToDBPass</span><span class="params">(String formPass,String salt)</span></span>&#123;</span><br><span class="line">        <span class="comment">//第二次加密，将传输得到数据进行加密存储</span></span><br><span class="line">        String str = <span class="string">&quot;&quot;</span> + salt.charAt(<span class="number">0</span>) + salt.charAt(<span class="number">2</span>) + formPass + salt.charAt(<span class="number">5</span>) + salt.charAt(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">return</span> md5(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">inputPassToDbPass</span><span class="params">(String input,String saltDB)</span></span>&#123;</span><br><span class="line">        String formPass = inputPassToFormPass(input);</span><br><span class="line">        String dbPass = formPassToDBPass(formPass,saltDB);</span><br><span class="line">        <span class="keyword">return</span> dbPass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(inputPassToDbPass(<span class="string">&quot;123456&quot;</span>, <span class="string">&quot;1a2b3c4d&quot;</span> ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断手机号格式是否正确</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern mobile_pattern = Pattern.compile(<span class="string">&quot;1\\d&#123;10&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMobile</span><span class="params">(String src)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(src))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Matcher m = mobile_pattern.matcher(src);</span><br><span class="line">        <span class="keyword">return</span> m.matches();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(isMobile(<span class="string">&quot;18844223196&quot;</span>));</span><br><span class="line">        System.out.println(isMobile(<span class="string">&quot;10086&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写CodeMsg，统一封装返回信息，用于封装错误信息，错误状态码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeMsg</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">	<span class="keyword">private</span> String msg;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//通用异常</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg SUCCESS = <span class="keyword">new</span> CodeMsg(<span class="number">0</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg SERVER_ERROR = <span class="keyword">new</span> CodeMsg(<span class="number">500100</span>, <span class="string">&quot;服务端异常&quot;</span>);</span><br><span class="line">	<span class="comment">//登录模块 5002XX</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg SESSION_ERROR = <span class="keyword">new</span> CodeMsg(<span class="number">500210</span>, <span class="string">&quot;Session不存在或已失效&quot;</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg PASSWORD_EMPTY = <span class="keyword">new</span> CodeMsg(<span class="number">500211</span>, <span class="string">&quot;登陆密码不能为空&quot;</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg MOBILE_EMPTY = <span class="keyword">new</span> CodeMsg(<span class="number">500212</span>, <span class="string">&quot;手机号不能为空&quot;</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg MOBILE_ERROR = <span class="keyword">new</span> CodeMsg(<span class="number">500213</span>, <span class="string">&quot;手机号格式错误&quot;</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg MOBILE_NOT_EXIST = <span class="keyword">new</span> CodeMsg(<span class="number">500214</span>, <span class="string">&quot;手机号不存在&quot;</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CodeMsg PASSWORD_ERROR = <span class="keyword">new</span> CodeMsg(<span class="number">500215</span>, <span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">	<span class="comment">//商品模块 5003XX</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//订单模块 5004XX</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//秒杀模块 5005XX</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">CodeMsg</span><span class="params">(<span class="keyword">int</span> code, String msg)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.code = code;</span><br><span class="line">		<span class="keyword">this</span>.msg = msg;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> msg;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写登录界面的实体类（仅用于接收登录界面参数）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginVo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于进行登录校验的实体类</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getter and setter</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;LoginVo&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;mobile=&#x27;&quot;</span> + mobile + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, password=&#x27;&quot;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写登录数据库对应实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiaoshaUser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">    <span class="keyword">private</span> String head;</span><br><span class="line">    <span class="keyword">private</span> Date registerDate;</span><br><span class="line">    <span class="keyword">private</span> Date lastLoginDate;</span><br><span class="line">    <span class="keyword">private</span> Integer loginCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写MiaoshaUserDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MiaoshaUserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from miaosha_user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MiaoshaUser <span class="title">getById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span>Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写MiaoshaUserService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiaoshaUserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MiaoshaUserDao miaoshaUserDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MiaoshaUser <span class="title">getById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> miaoshaUserDao.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CodeMsg <span class="title">login</span><span class="params">(LoginVo loginVo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(loginVo == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> CodeMsg.SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        String mobile = loginVo.getMobile();</span><br><span class="line">        String formPass = loginVo.getPassword();</span><br><span class="line">        <span class="comment">//查询user</span></span><br><span class="line">        MiaoshaUser user = getById(Long.parseLong(mobile));</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> CodeMsg.MOBILE_NOT_EXIST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证密码</span></span><br><span class="line">        String dbPass = user.getPassword();</span><br><span class="line">        String saltDB = user.getSalt();</span><br><span class="line">        <span class="comment">//前端已经做过一次md5加密</span></span><br><span class="line">        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);</span><br><span class="line">        <span class="keyword">if</span> (!calcPass.equals(dbPass))&#123;</span><br><span class="line">            <span class="keyword">return</span> CodeMsg.PASSWORD_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CodeMsg.SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写登录Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(LoginController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MiaoshaUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/to_login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toLogin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/do_login&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;CodeMsg&gt; <span class="title">doLogin</span><span class="params">(LoginVo loginVo)</span></span>&#123;</span><br><span class="line">        <span class="comment">//记录日志信息</span></span><br><span class="line">        log.info(loginVo.toString());</span><br><span class="line">        <span class="comment">//参数校验</span></span><br><span class="line">        String passInput = loginVo.getPassword();</span><br><span class="line">        String mobile = loginVo.getMobile();</span><br><span class="line">        <span class="comment">//校验密码输入是否为空</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(passInput))&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.PASSWORD_EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//校验手机号输入是否为空</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(mobile))&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.MOBILE_EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//校验手机号格式</span></span><br><span class="line">        <span class="keyword">if</span>(!ValidatorUtil.isMobile(mobile))&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.MOBILE_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//登录并返回 返回信息</span></span><br><span class="line">        CodeMsg cm = userService.login(loginVo);</span><br><span class="line">        <span class="keyword">if</span> (cm.getCode() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.success(CodeMsg.SUCCESS);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(cm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-JSR303参数检验-全局异常处理器"><a href="#2-3-JSR303参数检验-全局异常处理器" class="headerlink" title="2.3 JSR303参数检验+全局异常处理器"></a>2.3 JSR303参数检验+全局异常处理器</h2><h3 id="2-3-1-JSR303参数检验"><a href="#2-3-1-JSR303参数检验" class="headerlink" title="2.3.1 JSR303参数检验"></a>2.3.1 JSR303参数检验</h3><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用validation可通过注解对参数进行检验，参数传入时可进行检验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/do_login&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;CodeMsg&gt; <span class="title">doLogin</span><span class="params">(<span class="meta">@Valid</span> LoginVo loginVo)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LoginVo可改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginVo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于接收登录参数的实体类</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@IsMobile</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Length(min = 32)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br></pre></td></tr></table></figure>
<p>其中@IsMobile需要自定义，可点开@NotNull参考</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@java</span>.lang.annotation.Target(&#123;java.lang.annotation.ElementType.METHOD, java.lang.annotation.ElementType.FIELD, java.lang.annotation.ElementType.ANNOTATION_TYPE, java.lang.annotation.ElementType.CONSTRUCTOR, java.lang.annotation.ElementType.PARAMETER, java.lang.annotation.ElementType.TYPE_USE&#125;)</span><br><span class="line"><span class="meta">@java</span>.lang.annotation.Retention(java.lang.annotation.RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@java</span>.lang.annotation.Documented</span><br><span class="line"><span class="meta">@javax</span>.validation.Constraint(validatedBy = &#123;IsMobileValidator.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> IsMobile &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"></span><br><span class="line">    java.lang.<span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;手机号码格式有误&quot;</span>;</span><br><span class="line"></span><br><span class="line">    java.lang.Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    java.lang.Class&lt;? extends javax.validation.Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写IsMobileValidator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IsMobileValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">IsMobile</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> required = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(IsMobile constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        required = constraintAnnotation.required();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (required)&#123;</span><br><span class="line">            <span class="keyword">return</span> ValidatorUtil.isMobile(value);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(value))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ValidatorUtil.isMobile(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原来登录中的参数校验逻辑可以删除</p>
<h3 id="2-3-2-全局异常处理"><a href="#2-3-2-全局异常处理" class="headerlink" title="2.3.2 全局异常处理"></a>2.3.2 全局异常处理</h3><p>参数校验只替代了原有代码的校验功能，但没有返回相关的异常信息，当校验出现问题时抛出的异常信息应该得到处理。实现方式是实现一个全局的拦截器，这要用到注解@ControllerAdvice，可以处理所有的controller方法抛出的异常</p>
<p>在该类中，可以定义多个方法，不同的方法处理不同的异常，例如专门处理空指针的方法、专门处理数组越界的方法…，也可以在一个方法中处理所有的异常信息。</p>
<p>@ExceptionHandler 注解用来指明异常的处理类型，即如果这里指定为 NullpointerException，则数组越界异常就不会进到这个方法中来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobleExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定当前方法处理Exception类</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">exceptionHandler</span><span class="params">(HttpServletRequest request,Exception e)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BindException)&#123;</span><br><span class="line">            <span class="comment">//如果当前异常属于绑定异常，将绑定异常的错误信息打印</span></span><br><span class="line">            <span class="comment">//instanceof是Java中的二元运算符，左边是对象，右边是类；当对象是右边类或子类所创建对象时，返回true；否则，返回false。</span></span><br><span class="line">            BindException ex = (BindException)e;</span><br><span class="line">            List&lt;ObjectError&gt; errors = ex.getAllErrors();</span><br><span class="line">            ObjectError error = errors.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            String msg = error.getDefaultMessage();</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.BIND_ERROR.fillArgs(msg));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则报服务器异常</span></span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当前还存在一些问题，在MiaoshaUserService中login()方法对登录参数进行数据库校验的时候，返回的类是CodeMsg，我们通常不直接返回错误状态信息，而是返回与登录密切相关的语义即登录失败还是成功，原代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> CodeMsg <span class="title">login</span><span class="params">(LoginVo loginVo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(loginVo == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> CodeMsg.SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        String mobile = loginVo.getMobile();</span><br><span class="line">        String formPass = loginVo.getPassword();</span><br><span class="line">        <span class="comment">//查询user</span></span><br><span class="line">        MiaoshaUser user = getById(Long.parseLong(mobile));</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> CodeMsg.MOBILE_NOT_EXIST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证密码</span></span><br><span class="line">        String dbPass = user.getPassword();</span><br><span class="line">        String saltDB = user.getSalt();</span><br><span class="line">        <span class="comment">//前端已经做过一次md5加密</span></span><br><span class="line">        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);</span><br><span class="line">        <span class="keyword">if</span> (!calcPass.equals(dbPass))&#123;</span><br><span class="line">            <span class="keyword">return</span> CodeMsg.PASSWORD_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CodeMsg.SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">login</span><span class="params">(LoginVo loginVo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(loginVo == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GlobleException(CodeMsg.SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        String mobile = loginVo.getMobile();</span><br><span class="line">        String formPass = loginVo.getPassword();</span><br><span class="line">        <span class="comment">//查询user</span></span><br><span class="line">        MiaoshaUser user = getById(Long.parseLong(mobile));</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GlobleException(CodeMsg.MOBILE_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证密码</span></span><br><span class="line">        String dbPass = user.getPassword();</span><br><span class="line">        String saltDB = user.getSalt();</span><br><span class="line">        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);</span><br><span class="line">        <span class="keyword">if</span> (!calcPass.equals(dbPass))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GlobleException(CodeMsg.PASSWORD_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此时抛出异常到controller，controller的异常会被全局异常处理捕获，全局异常处理逻辑修改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">exceptionHandler</span><span class="params">(HttpServletRequest request,Exception e)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (e <span class="keyword">instanceof</span> GlobleException)&#123;</span><br><span class="line">           <span class="comment">//增加处理抛出异常逻辑，即登录的参数与数据库数据对比</span></span><br><span class="line">           GlobleException ex = (GlobleException)e;</span><br><span class="line">           <span class="keyword">return</span> Result.error(ex.getCm());</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BindException)&#123;</span><br><span class="line">           <span class="comment">//对参数格式校验的错误异常处理</span></span><br><span class="line">           BindException ex = (BindException)e;</span><br><span class="line">           List&lt;ObjectError&gt; errors = ex.getAllErrors();</span><br><span class="line">           ObjectError error = errors.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">           String msg = error.getDefaultMessage();</span><br><span class="line">           <span class="keyword">return</span> Result.error(CodeMsg.BIND_ERROR.fillArgs(msg));</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> Result.error(CodeMsg.SERVER_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>此时登录测试逻辑修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原代码</span></span><br><span class="line">CodeMsg cm = userService.login(loginVo);</span><br><span class="line"><span class="keyword">if</span> (cm.getCode() == <span class="number">0</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> Result.success(CodeMsg.SUCCESS);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.error(cm);</span><br><span class="line">&#125;</span><br><span class="line">修改为：</span><br><span class="line">userService.login(loginVo);</span><br><span class="line"><span class="keyword">return</span> Result.success(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<h2 id="2-4-分布式Session"><a href="#2-4-分布式Session" class="headerlink" title="2.4 分布式Session"></a>2.4 分布式Session</h2><p>分布式Session一致性解决方案不止一种：</p>
<ul>
<li>session复制：从服务器角度，应用服务器开启web容器的session复制功能，在集群中的几台服务器之间同步session对象，使得每台服务器上都保存所有的session信息，这样任何一台宕机都不会导致session的数据丢失，服务器使用session时，直接从本地获取。这种方式在应用集群达到数千台的时候，就会出现瓶颈，每台都需要备份session，出现内存不够用的情况。</li>
<li>session绑定：利用hash算法，比如nginx的ip_hash,使得同一个Ip的请求分发到同一台服务器上。这种方式不符合对系统的高可用要求，因为一旦某台服务器宕机，那么该机器上的session也就不复存在了，用户请求切换到其他机器后么有session，无法完成业务处理。</li>
<li>利用cookie记录session：session记录在客户端，每次请求服务器的时候，将session放在请求中发送给服务器，服务器处理完请求后再将修改后的session响应给客户端，<strong>这里的客户端就是cookie。</strong></li>
<li>session服务器：session服务器可以解决上面的所有的问题<strong>，</strong>利用独立部署的session服务器（集群）统一管理session，服务器每次读写session时，都访问session服务器。</li>
</ul>
<p>我们使用cookie记录session。</p>
<p>修改登录逻辑，登录时存入cookie</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">(HttpServletResponse response, LoginVo loginVo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(loginVo == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GlobleException(CodeMsg.SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        String mobile = loginVo.getMobile();</span><br><span class="line">        String formPass = loginVo.getPassword();</span><br><span class="line">        <span class="comment">//查询user</span></span><br><span class="line">        MiaoshaUser user = getById(Long.parseLong(mobile));</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GlobleException(CodeMsg.MOBILE_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证密码</span></span><br><span class="line">        String dbPass = user.getPassword();</span><br><span class="line">        String saltDB = user.getSalt();</span><br><span class="line">        String calcPass = MD5Util.formPassToDBPass(formPass,saltDB);</span><br><span class="line">        <span class="keyword">if</span> (!calcPass.equals(dbPass))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GlobleException(CodeMsg.PASSWORD_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        addCookie();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCookie</span><span class="params">(MiaoshaUser user,HttpServletResponse response)</span></span>&#123;</span><br><span class="line">        <span class="comment">//生成cookie</span></span><br><span class="line">        String token = UUIDUtil.uuid();</span><br><span class="line">        redisService.set(MiaoshaUserKey.token,token,user);</span><br><span class="line">        Cookie cookie = <span class="keyword">new</span> Cookie(COOKIE_NAME_TOKEN, token);</span><br><span class="line">        cookie.setMaxAge(MiaoshaUserKey.token.expireSeconds());</span><br><span class="line">        <span class="comment">//设置多应用共享</span></span><br><span class="line">        cookie.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//使用response把生成的cookie值传回浏览器</span></span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中UUIDUtil:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UUIDUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uuid</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户登录后会进行跳转to_list（如果不登录直接进入该页面也应该持有状态），编写相关GoodsController类,作用是读取当前浏览器中的cookie值与redis中的值比较</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(GoodsController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MiaoshaUserService userService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/to_list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toLogin</span><span class="params">(Model model,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="meta">@CookieValue(value = MiaoshaUserService.COOKIE_NAME_TOKEN,required = false)</span>String cookieToken,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="meta">@RequestParam(value = MiaoshaUserService.COOKIE_NAME_TOKEN,required = false)</span>String paramToken)</span></span>&#123;</span><br><span class="line">        <span class="comment">//从cookie或请求参数中取出cookie值</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(cookieToken))&#123;</span><br><span class="line">            <span class="comment">//判断若取出的cookie值都为空返回login</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;</span><br><span class="line">        <span class="comment">//根据token取值</span></span><br><span class="line">        MiaoshaUser user = userService.getByToken(token);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;goods_list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在MiaoshaUserService中编写getByToken方法（根据token取出session值）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MiaoshaUser <span class="title">getByToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisService.get(MiaoshaUserKey.token,token,MiaoshaUser.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中MiaoshaUserKey：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiaoshaUserKey</span> <span class="keyword">extends</span> <span class="title">BasePrefix</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TOKEN_EXPIRE = <span class="number">3600</span> * <span class="number">24</span> * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MiaoshaUserKey</span><span class="params">(String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MiaoshaUserKey</span><span class="params">(<span class="keyword">int</span> expireSeconds,String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(expireSeconds, prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MiaoshaUserKey token = <span class="keyword">new</span> MiaoshaUserKey(TOKEN_EXPIRE,<span class="string">&quot;tk&quot;</span>);</span><br><span class="line"><span class="comment">//    public static MiaoshaUserKey getByName = new MiaoshaUserKey(&quot;name&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在仍然有一些问题，因为cookie的有效期是在登录时设置的，但有效期应该在最后一次访问时得到更新，即我们最后一次访问时如果cookie验证通过应该视为一次登录并使有效期得到延长。</p>
<p>因此我们在上述进行getByToken方法中查询后更新一次cookie</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MiaoshaUser <span class="title">getByToken</span><span class="params">(HttpServletResponse response,String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        MiaoshaUser user = redisService.get(MiaoshaUserKey.token,token,MiaoshaUser.class);</span><br><span class="line">        <span class="comment">//延长有效期</span></span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>)&#123;</span><br><span class="line">            addCookie(user,response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>还可以继续优化，因为我们现在访问商品界面需要验证token，访问订单页面也需要验证token，这造成了代码的重复，因此我们定义拦截器统一验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserArgumentResolver userArgumentResolver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers)</span> </span>&#123;</span><br><span class="line">        argumentResolvers.add(userArgumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写UserArgumentResolver,这会根据当前请求中的cookie与redis中的token对比查询一个user对象并添加到request中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MiaoshaUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = parameter.getParameterType();</span><br><span class="line">        <span class="keyword">return</span> clazz == MiaoshaUser.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">        HttpServletResponse response = webRequest.getNativeResponse(HttpServletResponse.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String paramToken = request.getParameter(MiaoshaUserService.COOKIE_NAME_TOKEN);</span><br><span class="line">        String cookieToken = getCookieValue(request,MiaoshaUserService.COOKIE_NAME_TOKEN);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(paramToken))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;</span><br><span class="line">        <span class="keyword">return</span> userService.getByToken(response,token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getCookieValue</span><span class="params">(HttpServletRequest request, String cookieName)</span> </span>&#123;</span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">for</span> (Cookie cookie: cookies) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cookie.getName().equals(cookieName))&#123;</span><br><span class="line">                <span class="keyword">return</span> cookie.getValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>改变GoodsController逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/to_list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model,MiaoshaUser user)</span></span>&#123;</span><br><span class="line">        <span class="comment">//拦截器已经给请求中添加了user，所以可以接收到</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">//        if (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(cookieToken))&#123;</span></span><br><span class="line"><span class="comment">//            return &quot;login&quot;;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;</span></span><br><span class="line"><span class="comment">//        MiaoshaUser user = userService.getByToken(response,token);</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;goods_list&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在编写拦截器中发现bug，其原因是登录时无法正确的设置cookie，拦截器无法debug，但可以通过sout输出相关信息，发现bug不在拦截器中，而发生在addCookie()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCookie</span><span class="params">(String token,MiaoshaUser user,HttpServletResponse response)</span></span>&#123;</span><br><span class="line">        redisService.set(MiaoshaUserKey.token,token,user);</span><br><span class="line">        Cookie cookie = <span class="keyword">new</span> Cookie(COOKIE_NAME_TOKEN, token);</span><br><span class="line">        <span class="comment">//原来expireSeconds默认设置为0，设置为0将立即删除cookie</span></span><br><span class="line">        cookie.setMaxAge(<span class="number">3600</span> * <span class="number">12</span>);</span><br><span class="line"><span class="comment">//        cookie.setMaxAge(MiaoshaUserKey.token.expireSeconds());</span></span><br><span class="line">        <span class="comment">//设置多应用共享</span></span><br><span class="line">        cookie.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//使用response把生成的cookie值传回浏览器</span></span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>原文档中说expireSeconds是永不过期，这是错误的，在redis中expireSeconds为0将立即删除数据，即存活时间为0，redis中不设置过期时间就是永不过期，但我们修改了逻辑使expireSeconds为0永不过期：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> seconds = prefix.expireSeconds();</span><br><span class="line"><span class="keyword">if</span> (seconds &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">	jedis.set(realkey, str);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	jedis.setex(realkey, seconds, str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们向浏览器设置cookie也使用的cookie.setMaxAge(MiaoshaUserKey.token.expireSeconds());，这不是redis逻辑，而是向浏览器的·response中返回逻辑，此时setMaxAge设置为0将立即删除cookie，即代码出现了redis存入数据，但浏览器中没有的情况。</p>
<h1 id="3-实现秒杀功能"><a href="#3-实现秒杀功能" class="headerlink" title="3. 实现秒杀功能"></a>3. 实现秒杀功能</h1><h2 id="3-1-数据库设计"><a href="#3-1-数据库设计" class="headerlink" title="3.1 数据库设计"></a>3.1 数据库设计</h2><h3 id="3-1-1-商品表"><a href="#3-1-1-商品表" class="headerlink" title="3.1.1 商品表"></a>3.1.1 商品表</h3><p>商品表goods</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `goods` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">  `goods_name` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">  `goods_title` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品标题&#x27;</span>,</span><br><span class="line">  `goods_img` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品的图片&#x27;</span>,</span><br><span class="line">  `goods_detail` longtext COMMENT <span class="string">&#x27;商品的详情介绍&#x27;</span>,</span><br><span class="line">  `goods_price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span> COMMENT <span class="string">&#x27;商品单价&#x27;</span>,</span><br><span class="line">  `goods_stock` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;商品库存，-1表示没有限制&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-订单表"><a href="#3-1-2-订单表" class="headerlink" title="3.1.2 订单表"></a>3.1.2 订单表</h3><p>订单表order_info</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `order_info` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `goods_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">  `delivery_addr_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;收获地址ID&#x27;</span>,</span><br><span class="line">  `goods_name` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;冗余过来的商品名称&#x27;</span>,</span><br><span class="line">  `goods_count` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;商品数量&#x27;</span>,</span><br><span class="line">  `goods_price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span> COMMENT <span class="string">&#x27;商品单价&#x27;</span>,</span><br><span class="line">  `order_channel` tinyint <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;1pc，2android，3ios&#x27;</span>,</span><br><span class="line">  `status` tinyint <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;订单状态，0新建未支付，1已支付，2已发货，3已收货，4已退款，5已完成&#x27;</span>,</span><br><span class="line">  `create_date` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单的创建时间&#x27;</span>,</span><br><span class="line">  `pay_date` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1565</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure>
<h3 id="3-1-3-秒杀商品表"><a href="#3-1-3-秒杀商品表" class="headerlink" title="3.1.3 秒杀商品表"></a>3.1.3 秒杀商品表</h3><p>秒杀商品表miaosha_goods，这里不和商品表goods集成的原因是不同的活动秒杀数据不同，如果和goods在一起需要不断的维护goods表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `miaosha_goods` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;秒杀的商品表&#x27;</span>,</span><br><span class="line">  `goods_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品Id&#x27;</span>,</span><br><span class="line">  `miaosha_price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span> COMMENT <span class="string">&#x27;秒杀价&#x27;</span>,</span><br><span class="line">  `stock_count` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;库存数量&#x27;</span>,</span><br><span class="line">  `start_date` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀开始时间&#x27;</span>,</span><br><span class="line">  `end_date` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀结束时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure>
<h3 id="3-1-4-秒杀订单表"><a href="#3-1-4-秒杀订单表" class="headerlink" title="3.1.4 秒杀订单表"></a>3.1.4 秒杀订单表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `miaosha_order` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `order_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">  `goods_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `u_uid_gid` (`user_id`,`goods_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1551</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure>
<h2 id="3-2-商品列表页"><a href="#3-2-商品列表页" class="headerlink" title="3.2 商品列表页"></a>3.2 商品列表页</h2><p>编写Goods实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;</span><br><span class="line">    <span class="comment">//商品表</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String goodsName;</span><br><span class="line">    <span class="keyword">private</span> String goodsTitle;</span><br><span class="line">    <span class="keyword">private</span> String goodsImg;</span><br><span class="line">    <span class="keyword">private</span> String goodsDetail;</span><br><span class="line">    <span class="keyword">private</span> String goodsPrice;</span><br><span class="line">    <span class="keyword">private</span> String goodsStock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getter and setter</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>编写MiaoshaGoods实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiaoshaGoods</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long goodsId;</span><br><span class="line">    <span class="keyword">private</span> Integer stockCount;</span><br><span class="line">    <span class="keyword">private</span> Double miaoshaPrice;</span><br><span class="line">    <span class="keyword">private</span> Date startDate;</span><br><span class="line">    <span class="keyword">private</span> Date endDate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//getter and setter</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在GoodsController中的to_list添加查询商品列表的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping(&quot;/to_list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model,MiaoshaUser user)</span></span>&#123;</span><br><span class="line"><span class="comment">//        if (StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(cookieToken))&#123;</span></span><br><span class="line"><span class="comment">//            return &quot;login&quot;;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        String token = StringUtils.isEmpty(paramToken) ? cookieToken : paramToken;</span></span><br><span class="line"><span class="comment">//        MiaoshaUser user = userService.getByToken(response,token);</span></span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="comment">//查询商品列表</span></span><br><span class="line">        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();</span><br><span class="line">        model.addAttribute(<span class="string">&quot;goodsList&quot;</span>,goodsList);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;goods_list&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>编写GoodsService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    GoodsDao goodsDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GoodsVo&gt; <span class="title">listGoodsVo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> goodsDao.listGoodsVo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写GoodsDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select g.*,mg.stock_count,mg.start_date,mg.end_date,mg.miaosha_price from miaosha_goods mg left join goods g on mg.goods_id = g.id&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GoodsVo&gt; <span class="title">listGoodsVo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-商品详情页"><a href="#3-3-商品详情页" class="headerlink" title="3.3 商品详情页"></a>3.3 商品详情页</h2><p>商品详情页所展示的信息仍然是GoodsVo，在GoodsController中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/to_detail/&#123;goodsId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">detail</span><span class="params">(Model model, MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="meta">@PathVariable(&quot;goodsId&quot;)</span>Long goodsId)</span></span>&#123;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    <span class="comment">//查询商品详情</span></span><br><span class="line">    GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;goods&quot;</span>,goods);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> startAt = goods.getStartDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> endAt = goods.getEndDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (now &lt; startAt)&#123;</span><br><span class="line">        <span class="comment">//秒杀未开始，倒计时</span></span><br><span class="line">        miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">        remainSeconds = (<span class="keyword">int</span>)(startAt - now) / <span class="number">1000</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(now &gt; endAt)&#123;</span><br><span class="line">        <span class="comment">//秒杀已经结束</span></span><br><span class="line">        miaoshaStatus = <span class="number">2</span>;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//秒杀正在进行</span></span><br><span class="line">        miaoshaStatus = <span class="number">1</span>;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;miaoshaStatus&quot;</span>, miaoshaStatus);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;remainSeconds&quot;</span>, remainSeconds);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;goods_detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GoodsService添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> GoodsVo <span class="title">getGoodsVoByGoodsId</span><span class="params">(Long goodsId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> goodsDao.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GoodsDao中添加方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;select g.*,mg.stock_count,mg.start_date,mg.end_date,mg.miaosha_price from miaosha_goods mg left join goods g on mg.goods_id = g.id where g.id = #&#123;goodsId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span>  GoodsVo <span class="title">getGoodsVoByGoodsId</span><span class="params">(<span class="meta">@Param(&quot;goodsId&quot;)</span> Long goodsId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>秒杀功能实现：</p>
<p>点击商品详情页的；立即秒杀按钮会跳转到“/miaosha/do_miaosha”,编写MiaoshaController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/miaosha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiaoshaController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(MiaoshaController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MiaoshaService miaoshaService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/do_miaosha&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model, MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span></span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断库存</span></span><br><span class="line">        GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">        <span class="keyword">int</span> stock = goods.getStockCount();</span><br><span class="line">        <span class="keyword">if</span> (stock &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, CodeMsg.MIAO_SHA_OVER.getMsg());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;miaosha_fail&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否已经秒杀到了</span></span><br><span class="line">        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(user.getId(),goodsId);</span><br><span class="line">        <span class="keyword">if</span> (order != <span class="keyword">null</span>)&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;errmsg&quot;</span>,CodeMsg.REPEATE_MIAOSHA.getMsg());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;miaosha_fail&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//减库存 下订单 写入秒杀订单</span></span><br><span class="line">        OrderInfo orderInfo = miaoshaService.miaosha(user,goods);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;orderInfo&quot;</span>,orderInfo);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;goods&quot;</span>,goods);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;order_detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面涉及到三个service，分别是 GoodsService，OrderService，MiaoshaService</p>
<ol>
<li><p>GoodsService中已经有getGoodsVoByGoodsId()方法</p>
</li>
<li><p>OrderService中添加getMiaoshaOrderByUserIdAndGoodsId()方法</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MiaoshaOrder <span class="title">getMiaoshaOrderByUserIdAndGoodsId</span><span class="params">(<span class="keyword">long</span> userId, <span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> orderDao.getMiaoshaOrderByUserIdAndGoodsId(userId, goodsId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在OrderService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;select * from miaosha_order where user_id = #&#123;userId&#125; and goods_id = #&#123;goodsId&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MiaoshaOrder <span class="title">getMiaoshaOrderByUserIdAndGoodsId</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span><span class="keyword">long</span> userId, <span class="meta">@Param(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span></span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>上面步骤说明满足秒杀条件，MiaoshaService中编写miaosha()方法，该方法应该声明为事务,值得注意的是Service方法中一般引入自己同名相应的Dao，如果引用别的Dao方法应该直接引入对应的Service方法，比如这里引入的GoodsService而不是GoodsDao</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiaoshaService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderInfo <span class="title">miaosha</span><span class="params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//减库存</span></span><br><span class="line">        goodsService.reduceStock(goods);</span><br><span class="line">        <span class="comment">//生成订单</span></span><br><span class="line">        <span class="keyword">return</span> orderService.createOrder(user,goods);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>miaosha()里面有两个方法，在goodsService方法中添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceStock</span><span class="params">(GoodsVo goods)</span> </span>&#123;</span><br><span class="line">    MiaoshaGoods g = <span class="keyword">new</span> MiaoshaGoods();</span><br><span class="line">    g.setGoodsId(goods.getId());</span><br><span class="line">    goodsDao.reduceStock(g);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> MiaoshaGoods:</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiaoshaGoods</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long goodsId;</span><br><span class="line">    <span class="keyword">private</span> Integer stockCount;</span><br><span class="line">    <span class="keyword">private</span> Double miaoshaPrice;</span><br><span class="line">    <span class="keyword">private</span> Date startDate;</span><br><span class="line">    <span class="keyword">private</span> Date endDate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>goodsDao中的reduceStock()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Update(&quot;update miaosha_goods set stock_count = stock_count - 1 where goods_id = #&#123;goodsId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reduceStock</span><span class="params">(MiaoshaGoods g)</span></span>;</span><br></pre></td></tr></table></figure>
<p>orderService中添加createOrder：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> OrderInfo <span class="title">createOrder</span><span class="params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;</span><br><span class="line">       OrderInfo orderInfo = <span class="keyword">new</span> OrderInfo();</span><br><span class="line">       orderInfo.setCreateDate(<span class="keyword">new</span> Date());</span><br><span class="line">       orderInfo.setDeliveryAddrId(<span class="number">0L</span>);</span><br><span class="line">       orderInfo.setGoodsCount(<span class="number">1</span>);</span><br><span class="line">       orderInfo.setGoodsId(goods.getId());</span><br><span class="line">       orderInfo.setGoodsName(goods.getGoodsName());</span><br><span class="line">       orderInfo.setGoodsPrice(goods.getMiaoshaPrice());</span><br><span class="line">       orderInfo.setOrderChannel(<span class="number">1</span>);</span><br><span class="line">       orderInfo.setStatus(<span class="number">0</span>);</span><br><span class="line">       orderInfo.setUserId(user.getId());</span><br><span class="line">       <span class="keyword">long</span> orderId = orderDao.insert(orderInfo);</span><br><span class="line">       MiaoshaOrder miaoshaOrder = <span class="keyword">new</span> MiaoshaOrder();</span><br><span class="line">       miaoshaOrder.setGoodsId(goods.getId());</span><br><span class="line">       miaoshaOrder.setOrderId(orderId);</span><br><span class="line">       miaoshaOrder.setUserId(user.getId());</span><br><span class="line"></span><br><span class="line">       orderDao.insertMiaoshaOrder(miaoshaOrder);</span><br><span class="line">       <span class="keyword">return</span>  orderInfo;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>orderDao中的insertMiaoshaOrder()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert(&quot;insert into miaosha_order (user_id, goods_id, order_id)values(#&#123;userId&#125;, #&#123;goodsId&#125;, #&#123;orderId&#125;)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">insertMiaoshaOrder</span><span class="params">(MiaoshaOrder miaoshaOrder)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这里为什么只修改秒杀商品表库存而不修改商品表库存呢？</p>
<h2 id="3-4-订单详情页"><a href="#3-4-订单详情页" class="headerlink" title="3.4 订单详情页"></a>3.4 订单详情页</h2><p>编写相应的thymeleaf模板</p>
<h1 id="4-JMeter压测"><a href="#4-JMeter压测" class="headerlink" title="4. JMeter压测"></a>4. JMeter压测</h1><h2 id="4-1-JMeter入门"><a href="#4-1-JMeter入门" class="headerlink" title="4.1 JMeter入门"></a>4.1 JMeter入门</h2><p>启动JMeter后添加线程组，设置线程属性：</p>
<ul>
<li>线程数：1000(太少吞吐量达不到性能瓶颈)</li>
<li>Ramp-Up时间：0（线程同时启动，设置为10则是线程组在10秒内启动）</li>
<li>循环次数：1（线程组测试多少次）</li>
</ul>
<p>在线程组下设置：</p>
<ul>
<li>HTTP请求默认值<ul>
<li>协议：http</li>
<li>服务器名称或IP：localhost</li>
<li>端口号：8080</li>
</ul>
</li>
<li>HTTP请求<ul>
<li>名称：商品列表</li>
<li>请求方式：GET</li>
<li>路径：goods/to_list</li>
</ul>
</li>
<li>聚合报告</li>
</ul>
<p>聚合报告显示吞吐量468/s</p>
<p>测试时若mysql在linux上使用top命令观察各进程情况，在windows上使用任务管理器，发现mysql占用资源最多，应该为当前的性能瓶颈。</p>
<h2 id="4-2-自定义变量模拟多用户"><a href="#4-2-自定义变量模拟多用户" class="headerlink" title="4.2 自定义变量模拟多用户"></a>4.2 自定义变量模拟多用户</h2><p>在线程组下添加一个HTTP请求：</p>
<p>HTTP请求</p>
<ul>
<li>名称：获取用户信息</li>
<li>请求方式：GET</li>
<li>路径：/user/info</li>
<li>参数：<ul>
<li>名称：token，值：a2a8a05fa0eb4b2f8f028e704de2f577</li>
</ul>
</li>
</ul>
<p>禁用原来的商品列表请求，现在的获取用户信息吞吐量667.1/s，因为现在只需要查redis不需要查mysql</p>
<p>现在只使用了一个token，也就是单用户，下面创建多用户，添加配置元件CSVDataSetConfig：</p>
<ul>
<li>文件名：F:/QQPCmgr/Desktop/config.txt</li>
<li>变量名称：userId,userToken</li>
<li>编写config.txt：<ul>
<li>userid1,a2a8a05fa0eb4b2f8f028e704de2f577</li>
</ul>
</li>
</ul>
<h2 id="4-3-JMeter命令行使用"><a href="#4-3-JMeter命令行使用" class="headerlink" title="4.3 JMeter命令行使用"></a>4.3 JMeter命令行使用</h2><ol>
<li><p>在windows上录好jmx</p>
<p>把windows上的jmx保存上传到linux</p>
</li>
<li><p>命令行：sh jmeter.sh -n -t XXX.jmx -l result.jtl</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apache-jmeter-5.4/bin/jmeter.sh -n -t goods_list.jmx -l result.jtl</span><br></pre></td></tr></table></figure>
<ol>
<li>使用top命令观察压测情况</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">top</span> <span class="selector-tag">-</span> <span class="selector-tag">06</span><span class="selector-pseudo">:40</span><span class="selector-pseudo">:42</span> <span class="selector-tag">up</span>  <span class="selector-tag">3</span><span class="selector-pseudo">:31</span>,  <span class="selector-tag">2</span> <span class="selector-tag">users</span>,  <span class="selector-tag">load</span> <span class="selector-tag">average</span>: <span class="selector-tag">11</span><span class="selector-class">.09</span>, <span class="selector-tag">4</span><span class="selector-class">.46</span>, <span class="selector-tag">2</span><span class="selector-class">.57</span></span><br><span class="line">占用最多的进程是两个<span class="selector-tag">java</span>(项目和jemeter)和<span class="selector-tag">mysql</span></span><br></pre></td></tr></table></figure>
<ol>
<li>把result.jtl导入到jmeter</li>
</ol>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">qps</span>为<span class="number">897</span>.<span class="number">9</span>/s</span><br></pre></td></tr></table></figure>
<h2 id="4-4-Redis压测工具redis-benchmark"><a href="#4-4-Redis压测工具redis-benchmark" class="headerlink" title="4.4 Redis压测工具redis-benchmark"></a>4.4 Redis压测工具redis-benchmark</h2><p>redis做压测可以使用自带的redis-benchmark工具</p>
<p>在linux使用终端命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">100个并发，100000个请求</span></span><br><span class="line">redis-benchmark -h 127.0.0.1 -p 6379 -c 100 -n 100000</span><br></pre></td></tr></table></figure>
<p>得到结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">====== GET ======</span><br><span class="line">  100000 requests completed in 1.79 seconds</span><br><span class="line">  100 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br></pre></td></tr></table></figure>
<p>使用终端命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">存取大小为100字节的数据包</span></span><br><span class="line">redis-benchmark -h 127.0.0.1 -p 6379 -q -d 100</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PING_INLINE: 54141.85 requests per second</span><br><span class="line">PING_BULK: 68212.83 requests per second</span><br><span class="line">SET: 78247.26 requests per second</span><br><span class="line">GET: 79302.14 requests per second</span><br><span class="line">INCR: 69348.12 requests per second</span><br><span class="line">LPUSH: 78926.60 requests per second</span><br><span class="line">RPUSH: 78369.91 requests per second</span><br><span class="line">LPOP: 79239.30 requests per second</span><br><span class="line">RPOP: 80128.20 requests per second</span><br><span class="line">SADD: 79744.82 requests per second</span><br><span class="line">HSET: 78554.59 requests per second</span><br><span class="line">SPOP: 78740.16 requests per second</span><br><span class="line">LPUSH (needed to benchmark LRANGE): 78369.91 requests per second</span><br><span class="line">LRANGE_100 (first 100 elements): 78308.54 requests per second</span><br><span class="line">LRANGE_300 (first 300 elements): 78186.08 requests per second</span><br><span class="line">LRANGE_500 (first 450 elements): 79365.08 requests per second</span><br><span class="line">LRANGE_600 (first 600 elements): 78492.93 reque</span><br></pre></td></tr></table></figure>
<p>使用终端命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">测试单个语句性能</span></span><br><span class="line">redis-benchmark -n 100000 -q script load &quot;redis.call(&#x27;set&#x27;,&#x27;foo&#x27;,&#x27;bar&#x27;)&quot;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script load redis.call(&#x27;set&#x27;,&#x27;foo&#x27;,&#x27;bar&#x27;): 66093.85 requests per second</span><br></pre></td></tr></table></figure>
<h2 id="4-5-SpringBoot打war包"><a href="#4-5-SpringBoot打war包" class="headerlink" title="4.5 SpringBoot打war包"></a>4.5 SpringBoot打war包</h2><ol>
<li>添加spring-boot-starter-tomcat的provided依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>添加maven-war-plugin插件</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">failOnMissingWebXml</span>&gt;</span>false<span class="tag">&lt;/<span class="name">failOnMissingWebXml</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>修改启动类MainApplication</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(MainApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>在终端 E:\ideawork\miaosha_4打包命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\ideawork\miaosha_4&gt;mvn clean package</span><br></pre></td></tr></table></figure>
<ol>
<li>打包后将miaosha_4.war移动到tomcat的websapp下面并启动tomcat</li>
</ol>
<h1 id="5-页面优化技术"><a href="#5-页面优化技术" class="headerlink" title="5. 页面优化技术"></a>5. 页面优化技术</h1><h2 id="5-1-页面缓存-URL缓存-对象缓存"><a href="#5-1-页面缓存-URL缓存-对象缓存" class="headerlink" title="5.1 页面缓存+URL缓存+对象缓存"></a>5.1 页面缓存+URL缓存+对象缓存</h2><h3 id="5-1-1页面缓存"><a href="#5-1-1页面缓存" class="headerlink" title="5.1.1页面缓存"></a>5.1.1页面缓存</h3><p>页面缓存，这里使用的是浏览器缓存技术（第二次访问有效）</p>
<p>首先修改访问原来的list逻辑，增加了注解@ResponseBody，先尝试在redis取缓存，没有的话就生成缓存并存到redis中，以前是直接返回goods_list交给thymeleaf渲染解析，这里先使用thymeleafViewResolver解析为成品代码返回，再将成品代码存到redis中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@RequestMapping(value = &quot;/to_list&quot;,produces = &quot;text/html&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(HttpServletRequest request,HttpServletResponse response, Model model, MiaoshaUser user)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="comment">//查询商品列表</span></span><br><span class="line">        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();</span><br><span class="line">        model.addAttribute(<span class="string">&quot;goodsList&quot;</span>,goodsList);</span><br><span class="line"><span class="comment">//        return &quot;goods_list&quot;;</span></span><br><span class="line">        <span class="comment">//取缓存</span></span><br><span class="line">        String html = redisService.get(GoodsKey.getGoodsList,<span class="string">&quot;&quot;</span>,String.class);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(html))&#123;</span><br><span class="line">            <span class="keyword">return</span> html;</span><br><span class="line">        &#125;</span><br><span class="line">        IWebContext ctx =<span class="keyword">new</span> WebContext(request,response,</span><br><span class="line">                request.getServletContext(),request.getLocale(),model.asMap());</span><br><span class="line">        <span class="comment">//没有缓存手动渲染</span></span><br><span class="line">        html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">&quot;goods_list&quot;</span>, ctx);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(html))&#123;</span><br><span class="line">            redisService.set(GoodsKey.getGoodsList,<span class="string">&quot;&quot;</span>,html);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>编写GoodsKey，设置过期时间为60s，设置过大的数字会降低数据时效性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsKey</span> <span class="keyword">extends</span> <span class="title">BasePrefix</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GoodsKey</span><span class="params">(<span class="keyword">int</span> expireSeconds,String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GoodsKey getGoodsList = <span class="keyword">new</span> GoodsKey(<span class="number">60</span>,<span class="string">&quot;gl&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-2-URL缓存"><a href="#5-1-2-URL缓存" class="headerlink" title="5.1.2 URL缓存"></a>5.1.2 URL缓存</h3><p>URL缓存用于修改goods_detail，URL缓存和页面缓存基本一致，区别在于不同的详情页（URL）会显示不同缓存页面+渲染，实质一样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/to_detail/&#123;goodsId&#125;&quot;,produces = &quot;text/html&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">detail</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Model model,MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@PathVariable(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span></span>&#123;</span><br><span class="line">       model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//取缓存</span></span><br><span class="line">       String html = redisService.get(GoodsKey.getGoodsDetail, <span class="string">&quot;&quot;</span>+goodsId, String.class);</span><br><span class="line">       <span class="keyword">if</span>(!StringUtils.isEmpty(html)) &#123;</span><br><span class="line">           <span class="keyword">return</span> html;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//没有缓存手动渲染</span></span><br><span class="line">       <span class="comment">//查询商品详情</span></span><br><span class="line">       GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">       model.addAttribute(<span class="string">&quot;goods&quot;</span>,goods);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">long</span> startAt = goods.getStartDate().getTime();</span><br><span class="line">       <span class="keyword">long</span> endAt = goods.getEndDate().getTime();</span><br><span class="line">       <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (now &lt; startAt)&#123;</span><br><span class="line">           <span class="comment">//秒杀未开始，倒计时</span></span><br><span class="line">           miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">           remainSeconds = (<span class="keyword">int</span>)(startAt - now) / <span class="number">1000</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(now &gt; endAt)&#123;</span><br><span class="line">           <span class="comment">//秒杀已经结束</span></span><br><span class="line">           miaoshaStatus = <span class="number">2</span>;</span><br><span class="line">           remainSeconds = -<span class="number">1</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//秒杀正在进行</span></span><br><span class="line">           miaoshaStatus = <span class="number">1</span>;</span><br><span class="line">           remainSeconds = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       model.addAttribute(<span class="string">&quot;miaoshaStatus&quot;</span>, miaoshaStatus);</span><br><span class="line">       model.addAttribute(<span class="string">&quot;remainSeconds&quot;</span>, remainSeconds);</span><br><span class="line"></span><br><span class="line">       IWebContext ctx =<span class="keyword">new</span> WebContext(request,response,</span><br><span class="line">               request.getServletContext(),request.getLocale(),model.asMap());</span><br><span class="line">       html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">&quot;goods_detail&quot;</span>, ctx);</span><br><span class="line">       <span class="keyword">if</span>(!StringUtils.isEmpty(html)) &#123;</span><br><span class="line">           redisService.set(GoodsKey.getGoodsDetail, <span class="string">&quot;&quot;</span>+goodsId, html);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> html;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-3-对象缓存"><a href="#5-1-3-对象缓存" class="headerlink" title="5.1.3 对象缓存"></a>5.1.3 对象缓存</h3><p>对象缓存是相比页面缓存是更细粒度的缓存，对象缓存就是当用到用户数据的时候，可以从缓存中取出。比如：更新用户密码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原来的逻辑是直接到mysql数据库中取用户数据，现在修改为先查redis再查mysql</span></span><br><span class="line"><span class="comment">//同时添加了updatePassword方法，注意当有update方法是应该保证redis和mysql数据的一致性</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MiaoshaUser <span class="title">getById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        <span class="comment">//取缓存</span></span><br><span class="line">        MiaoshaUser user = redisService.get(MiaoshaUserKey.getById, <span class="string">&quot;&quot;</span> + id, MiaoshaUser.class);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//缓存没有取数据库</span></span><br><span class="line">        user = miaoshaUserDao.getById(id);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>)&#123;</span><br><span class="line">            redisService.set(MiaoshaUserKey.getById,<span class="string">&quot;&quot;</span>+id,user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updatePassword</span><span class="params">(String token,<span class="keyword">long</span> id,String formPass)</span></span>&#123;</span><br><span class="line">        <span class="comment">//取user</span></span><br><span class="line">        MiaoshaUser user = getById(id);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GlobleException(CodeMsg.MOBILE_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//更新数据库</span></span><br><span class="line">        MiaoshaUser toBeUpdate = <span class="keyword">new</span> MiaoshaUser();</span><br><span class="line">        toBeUpdate.setId(id);</span><br><span class="line">        toBeUpdate.setPassword(MD5Util.formPassToDBPass(formPass,user.getSalt()));</span><br><span class="line">        miaoshaUserDao.update(toBeUpdate);</span><br><span class="line">        <span class="comment">//处理缓存时应该更新两处，1.查询用户时的getById 2.cookie验证中的用户数据</span></span><br><span class="line">        <span class="comment">//1.查询用户的缓存直接删除即可，因为查询用户时查不到会去mysql中查询</span></span><br><span class="line">        <span class="comment">//2.cookie中的用户数据需要得到更新</span></span><br><span class="line">        redisService.delete(MiaoshaUserKey.getById,<span class="string">&quot;&quot;</span>+id);</span><br><span class="line">        user.setPassword(toBeUpdate.getPassword());</span><br><span class="line">        redisService.set(MiaoshaUserKey.token,token,user);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>miaoshaUserDao.update()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Update(&quot;update miaosha_user set password = #&#123;password&#125; where id = #&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(MiaoshaUser toBeUpdate)</span></span>;</span><br></pre></td></tr></table></figure>
<p>redisService.delete()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(KeyPrefix prefix,String key)</span> </span>&#123;</span><br><span class="line">    Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jedis = jedisPool.getResource();</span><br><span class="line">        <span class="comment">//生成真正的key</span></span><br><span class="line">        String realkey = prefix.getPrefix() + key;</span><br><span class="line">        <span class="keyword">long</span> ret = jedis.del(realkey);</span><br><span class="line">        <span class="keyword">return</span> ret &gt; <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        returnToPool(jedis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做完以上操作以后再次启动项目验证QPS</p>
<p>还有一处可以更新的地方是OrderService中判断当前用户是否已经有订单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MiaoshaOrder <span class="title">getMiaoshaOrderByUserIdAndGoodsId</span><span class="params">(<span class="keyword">long</span> userId, <span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  return orderDao.getMiaoshaOrderByUserIdAndGoodsId(userId, goodsId);</span></span><br><span class="line">        <span class="keyword">return</span> redisService.get(OrderKey.getMiaoshaOrderByuidGid,<span class="string">&quot;&quot;</span>+userId+<span class="string">&quot;_&quot;</span>+goodsId,MiaoshaOrder.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这样生成订单的时候也要向redis插入数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderInfo <span class="title">createOrder</span><span class="params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;</span><br><span class="line">        OrderInfo orderInfo = <span class="keyword">new</span> OrderInfo();</span><br><span class="line">        orderInfo.setCreateDate(<span class="keyword">new</span> Date());</span><br><span class="line">        orderInfo.setDeliveryAddrId(<span class="number">0L</span>);</span><br><span class="line">        orderInfo.setGoodsCount(<span class="number">1</span>);</span><br><span class="line">        orderInfo.setGoodsId(goods.getId());</span><br><span class="line">        orderInfo.setGoodsName(goods.getGoodsName());</span><br><span class="line">        orderInfo.setGoodsPrice(goods.getMiaoshaPrice());</span><br><span class="line">        orderInfo.setOrderChannel(<span class="number">1</span>);</span><br><span class="line">        orderInfo.setStatus(<span class="number">0</span>);</span><br><span class="line">        orderInfo.setUserId(user.getId());</span><br><span class="line">        <span class="keyword">long</span> orderId = orderDao.insert(orderInfo);</span><br><span class="line">        MiaoshaOrder miaoshaOrder = <span class="keyword">new</span> MiaoshaOrder();</span><br><span class="line">        miaoshaOrder.setGoodsId(goods.getId());</span><br><span class="line">        miaoshaOrder.setOrderId(orderId);</span><br><span class="line">        miaoshaOrder.setUserId(user.getId());</span><br><span class="line"></span><br><span class="line">        orderDao.insertMiaoshaOrder(miaoshaOrder);</span><br><span class="line"></span><br><span class="line">        redisService.set(OrderKey.getMiaoshaOrderByuidGid,<span class="string">&quot;&quot;</span>+user.getId()+<span class="string">&quot;_&quot;</span>+goods.getId(),miaoshaOrder);</span><br><span class="line">        <span class="keyword">return</span> orderInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-页面静态化，前后端分离"><a href="#5-2-页面静态化，前后端分离" class="headerlink" title="5.2 页面静态化，前后端分离"></a>5.2 页面静态化，前后端分离</h2><h3 id="5-2-1-商品详情页"><a href="#5-2-1-商品详情页" class="headerlink" title="5.2.1 商品详情页"></a>5.2.1 商品详情页</h3><p>当前访问商品详情页是通过redis缓存页面静态代码完成的，现在进一步改进的方式是把每一个页面直接生成静态的html保存在服务器，而不必进行数据库缓存。</p>
<p>首先修改后端detail代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value=&quot;/detail/&#123;goodsId&#125;&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Result&lt;GoodsDetailVo&gt; <span class="title">detail</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Model model,MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="meta">@PathVariable(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">       GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">       <span class="keyword">long</span> startAt = goods.getStartDate().getTime();</span><br><span class="line">       <span class="keyword">long</span> endAt = goods.getEndDate().getTime();</span><br><span class="line">       <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">       <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(now &lt; startAt ) &#123;<span class="comment">//秒杀还没开始，倒计时</span></span><br><span class="line">           miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">           remainSeconds = (<span class="keyword">int</span>)((startAt - now )/<span class="number">1000</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span>  <span class="keyword">if</span>(now &gt; endAt)&#123;<span class="comment">//秒杀已经结束</span></span><br><span class="line">           miaoshaStatus = <span class="number">2</span>;</span><br><span class="line">           remainSeconds = -<span class="number">1</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;<span class="comment">//秒杀进行中</span></span><br><span class="line">           miaoshaStatus = <span class="number">1</span>;</span><br><span class="line">           remainSeconds = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       GoodsDetailVo vo = <span class="keyword">new</span> GoodsDetailVo();</span><br><span class="line">       vo.setGoods(goods);</span><br><span class="line">       vo.setUser(user);</span><br><span class="line">       vo.setRemainSeconds(remainSeconds);</span><br><span class="line">       vo.setMiaoshaStatus(miaoshaStatus);</span><br><span class="line">       <span class="keyword">return</span> Result.success(vo);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>GoodsDetailVo中存放页面详情相关的数据，现在我们不需要返回页面，只需要返回需要静态页面渲染详情页需要的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsDetailVo</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">private</span> GoodsVo goods ;</span><br><span class="line">	<span class="keyword">private</span> MiaoshaUser user;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以前goods_list中的请求是先发送到后端逻辑处理：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;&#x27;/goods/to_detail/&#x27;+$&#123;goods.id&#125;&quot;</span>&gt;</span>详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>修改为直接访问html页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;&#x27;/goods_detail.htm?goodsId=&#x27;+$&#123;goods.id&#125;&quot;</span>&gt;</span>详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>该页面不再借助thymeleaf模板渲染，goods_detail.htm：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel panel-default&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel-heading&quot;</span>&gt;</span>秒杀商品详情<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel-body&quot;</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;userTip&quot;</span>&gt;</span> 您还没有登录，请登陆后再操作<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">span</span>&gt;</span>没有收货地址的提示。。。<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table&quot;</span> <span class="attr">id</span>=<span class="string">&quot;goodslist&quot;</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>商品名称<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;goodsName&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>商品图片<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;3&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span>  <span class="attr">id</span>=<span class="string">&quot;goodsImg&quot;</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>秒杀开始时间<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;startTime&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> &gt;</span>	</span><br><span class="line">        	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">id</span>=<span class="string">&quot;remainSeconds&quot;</span> /&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;miaoshaTip&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  </span></span><br><span class="line"><span class="comment">        	&lt;form id=&quot;miaoshaForm&quot; method=&quot;post&quot; action=&quot;/miaosha/do_miaosha&quot;&gt;</span></span><br><span class="line"><span class="comment">        		&lt;button class=&quot;btn btn-primary btn-block&quot; type=&quot;submit&quot; id=&quot;buyButton&quot;&gt;立即秒杀&lt;/button&gt;</span></span><br><span class="line"><span class="comment">        		&lt;input type=&quot;hidden&quot; name=&quot;goodsId&quot;  id=&quot;goodsId&quot; /&gt;</span></span><br><span class="line"><span class="comment">        	&lt;/form&gt;--&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary btn-block&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;buyButton&quot;</span><span class="attr">onclick</span>=<span class="string">&quot;doMiaosha()&quot;</span>&gt;</span>立即秒杀<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;goodsId&quot;</span>  <span class="attr">id</span>=<span class="string">&quot;goodsId&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>商品原价<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;goodsPrice&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>秒杀价<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;3&quot;</span>  <span class="attr">id</span>=<span class="string">&quot;miaoshaPrice&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>库存数量<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;3&quot;</span>  <span class="attr">id</span>=<span class="string">&quot;stockCount&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">doMiaosha</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">	$.ajax(&#123;</span></span><br><span class="line"><span class="javascript">		url:<span class="string">&quot;/miaosha/do_miaosha&quot;</span>,</span></span><br><span class="line"><span class="javascript">		type:<span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line">		data:&#123;</span><br><span class="line"><span class="javascript">			goodsId:$(<span class="string">&quot;#goodsId&quot;</span>).val(),</span></span><br><span class="line">		&#125;,</span><br><span class="line"><span class="javascript">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">window</span>.location.href=<span class="string">&quot;/order_detail.htm?orderId=&quot;</span>+data.data.id;</span></span><br><span class="line"><span class="javascript">			&#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line"><span class="javascript">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			layer.msg(<span class="string">&quot;客户端请求有误&quot;</span>);</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">detail</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> miaoshaStatus = detail.miaoshaStatus;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span>  remainSeconds = detail.remainSeconds;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> goods = detail.goods;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> user = detail.user;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">if</span>(user)&#123;</span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;#userTip&quot;</span>).hide();</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#goodsName&quot;</span>).text(goods.goodsName);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#goodsImg&quot;</span>).attr(<span class="string">&quot;src&quot;</span>, goods.goodsImg);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#startTime&quot;</span>).text(<span class="keyword">new</span> <span class="built_in">Date</span>(goods.startDate).format(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#remainSeconds&quot;</span>).val(remainSeconds);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#goodsId&quot;</span>).val(goods.id);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#goodsPrice&quot;</span>).text(goods.goodsPrice);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#miaoshaPrice&quot;</span>).text(goods.miaoshaPrice);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#stockCount&quot;</span>).text(goods.stockCount);</span></span><br><span class="line">	countDown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="comment">//countDown();</span></span></span><br><span class="line">	getDetail();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">getDetail</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> goodsId = g_getQueryString(<span class="string">&quot;goodsId&quot;</span>);</span></span><br><span class="line"><span class="javascript">	$.ajax(&#123;</span></span><br><span class="line"><span class="javascript">		url:<span class="string">&quot;/goods/detail/&quot;</span>+goodsId,</span></span><br><span class="line"><span class="javascript">		type:<span class="string">&quot;GET&quot;</span>,</span></span><br><span class="line"><span class="javascript">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span></span><br><span class="line">				render(data.data);</span><br><span class="line"><span class="javascript">			&#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line"><span class="javascript">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			layer.msg(<span class="string">&quot;客户端请求有误&quot;</span>);</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">countDown</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> remainSeconds = $(<span class="string">&quot;#remainSeconds&quot;</span>).val();</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> timeout;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">if</span>(remainSeconds &gt; <span class="number">0</span>)&#123;<span class="comment">//秒杀还没开始，倒计时</span></span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;#buyButton&quot;</span>).attr(<span class="string">&quot;disabled&quot;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">	   $(<span class="string">&quot;#miaoshaTip&quot;</span>).html(<span class="string">&quot;秒杀倒计时：&quot;</span>+remainSeconds+<span class="string">&quot;秒&quot;</span>);</span></span><br><span class="line"><span class="javascript">		timeout = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			$(<span class="string">&quot;#countDown&quot;</span>).text(remainSeconds - <span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">			$(<span class="string">&quot;#remainSeconds&quot;</span>).val(remainSeconds - <span class="number">1</span>);</span></span><br><span class="line">			countDown();</span><br><span class="line">		&#125;,1000);</span><br><span class="line"><span class="javascript">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(remainSeconds == <span class="number">0</span>)&#123;<span class="comment">//秒杀进行中</span></span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;#buyButton&quot;</span>).attr(<span class="string">&quot;disabled&quot;</span>, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">		<span class="keyword">if</span>(timeout)&#123;</span></span><br><span class="line"><span class="javascript">			<span class="built_in">clearTimeout</span>(timeout);</span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;#miaoshaTip&quot;</span>).html(<span class="string">&quot;秒杀进行中&quot;</span>);</span></span><br><span class="line"><span class="javascript">	&#125;<span class="keyword">else</span>&#123;<span class="comment">//秒杀已经结束</span></span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;#buyButton&quot;</span>).attr(<span class="string">&quot;disabled&quot;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;#miaoshaTip&quot;</span>).html(<span class="string">&quot;秒杀已经结束&quot;</span>);</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中使用了获得url路径中参数的方法g_getQueryString()，该方法在commons.js中定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取url参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g_getQueryString</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;(^|&amp;)&quot;</span> + name + <span class="string">&quot;=([^&amp;]*)(&amp;|$)&quot;</span>);</span><br><span class="line">	<span class="keyword">var</span> r = <span class="built_in">window</span>.location.search.substr(<span class="number">1</span>).match(reg);</span><br><span class="line">	<span class="keyword">if</span>(r != <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//设定时间格式化函数，使用new Date().format(&quot;yyyyMMddhhmmss&quot;);</span></span><br><span class="line"><span class="built_in">Date</span>.prototype.format = <span class="function"><span class="keyword">function</span> (<span class="params">format</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> args = &#123;</span><br><span class="line">		<span class="string">&quot;M+&quot;</span>: <span class="built_in">this</span>.getMonth() + <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;d+&quot;</span>: <span class="built_in">this</span>.getDate(),</span><br><span class="line">		<span class="string">&quot;h+&quot;</span>: <span class="built_in">this</span>.getHours(),</span><br><span class="line">		<span class="string">&quot;m+&quot;</span>: <span class="built_in">this</span>.getMinutes(),</span><br><span class="line">		<span class="string">&quot;s+&quot;</span>: <span class="built_in">this</span>.getSeconds(),</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.test(format))</span><br><span class="line">		format = format.replace(<span class="built_in">RegExp</span>.$1, (<span class="built_in">this</span>.getFullYear() + <span class="string">&quot;&quot;</span>).substr(<span class="number">4</span> - <span class="built_in">RegExp</span>.$1.length));</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> args) &#123;</span><br><span class="line">		<span class="keyword">var</span> n = args[i];</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;(&quot;</span> + i + <span class="string">&quot;)&quot;</span>).test(format))</span><br><span class="line">			format = format.replace(<span class="built_in">RegExp</span>.$1, <span class="built_in">RegExp</span>.$1.length == <span class="number">1</span> ? n : (<span class="string">&quot;00&quot;</span> + n).substr((<span class="string">&quot;&quot;</span> + n).length));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> format;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里出现了一个问题，更新common.js文件后浏览器缓存仍然使用的原来的common.js文件，网上的解决办法是清除缓存或者在引入js文件时加入版本号，尝试都不行，最后手动更新了项目生成的target文件中的common.js文件。</p>
<h3 id="5-2-2-订单详情页"><a href="#5-2-2-订单详情页" class="headerlink" title="5.2.2 订单详情页"></a>5.2.2 订单详情页</h3><p>订单详情页的html:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel panel-default&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel-heading&quot;</span>&gt;</span>秒杀订单详情<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table&quot;</span> <span class="attr">id</span>=<span class="string">&quot;goodslist&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>商品名称<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;goodsName&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>商品图片<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;2&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span>  <span class="attr">id</span>=<span class="string">&quot;goodsImg&quot;</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>订单价格<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;2&quot;</span>  <span class="attr">id</span>=<span class="string">&quot;orderPrice&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">     		<span class="tag">&lt;<span class="name">td</span>&gt;</span>下单时间<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        	<span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;createDate&quot;</span> <span class="attr">colspan</span>=<span class="string">&quot;2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">     	<span class="tag">&lt;<span class="name">td</span>&gt;</span>订单状态<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;orderStatus&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary btn-block&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">id</span>=<span class="string">&quot;payButton&quot;</span>&gt;</span>立即支付<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">     		<span class="tag">&lt;<span class="name">td</span>&gt;</span>收货人<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        	<span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;2&quot;</span>&gt;</span>XXX  18812341234<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">     		<span class="tag">&lt;<span class="name">td</span>&gt;</span>收货地址<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">        	<span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;2&quot;</span>&gt;</span>北京市昌平区回龙观龙博一区<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">detail</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> goods = detail.goods;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> order = detail.order;</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#goodsName&quot;</span>).text(goods.goodsName);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#goodsImg&quot;</span>).attr(<span class="string">&quot;src&quot;</span>, goods.goodsImg);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#orderPrice&quot;</span>).text(order.goodsPrice);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#createDate&quot;</span>).text(<span class="keyword">new</span> <span class="built_in">Date</span>(order.createDate).format(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> status = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">if</span>(order.status == <span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="javascript">		status = <span class="string">&quot;未支付&quot;</span></span></span><br><span class="line"><span class="javascript">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(order.status == <span class="number">1</span>)&#123;</span></span><br><span class="line"><span class="javascript">		status = <span class="string">&quot;待发货&quot;</span>;</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;#orderStatus&quot;</span>).text(status);</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">	getOrderDetail();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">getOrderDetail</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> orderId = g_getQueryString(<span class="string">&quot;orderId&quot;</span>);</span></span><br><span class="line"><span class="javascript">	$.ajax(&#123;</span></span><br><span class="line"><span class="javascript">		url:<span class="string">&quot;/order/detail&quot;</span>,</span></span><br><span class="line"><span class="javascript">		type:<span class="string">&quot;GET&quot;</span>,</span></span><br><span class="line">		data:&#123;</span><br><span class="line">			orderId:orderId</span><br><span class="line">		&#125;,</span><br><span class="line"><span class="javascript">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span></span><br><span class="line">				render(data.data);</span><br><span class="line"><span class="javascript">			&#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line"><span class="javascript">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			layer.msg(<span class="string">&quot;客户端请求有误&quot;</span>);</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们已经做了静态化，在开发者窗口发现get请求返回状态码的304，说明当前请求获得内容与上次相同，可以直接读取浏览器中的缓存，但这样还是与后端发生了交互，springboot中关于静态资源处理的配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#static</span></span><br><span class="line"><span class="meta">spring.resources.add-mappings</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.resources.cache.period</span>= <span class="string">3600</span></span><br><span class="line"><span class="meta">spring.resources.chain.cache</span>=<span class="string">true </span></span><br><span class="line"><span class="meta">spring.resources.chain.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.resources.chain.gzipped</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.resources.chain.html-application-cache</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.resources.static-locations</span>=<span class="string">classpath:/static/</span></span><br></pre></td></tr></table></figure>
<p>这样get请求直接返回状态码200,不会发生交互。</p>
<p>解决超卖问题：</p>
<p>现在秒杀系统中存在超卖的问题。</p>
<ol>
<li>reduceStock</li>
</ol>
<p>GoodsService减库存reduceStock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceStock</span><span class="params">(GoodsVo goods)</span> </span>&#123;</span><br><span class="line">    MiaoshaGoods g = <span class="keyword">new</span> MiaoshaGoods();</span><br><span class="line">    g.setGoodsId(goods.getId());</span><br><span class="line">    goodsDao.reduceStock(g);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GoodsDao减库存reduceStock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Update(&quot;update miaosha_goods set stock_count = stock_count-1 where goods_id = #&#123;goodsId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reduceStock</span><span class="params">(MiaoshaGoods g)</span></span>;</span><br></pre></td></tr></table></figure>
<p>虽然在MiaoshaController减去库存之前判断了库存&gt;0，这里如果两个用户都走到了reduceStock，我们发现库存会从1减到-1，处理方法是在sql中加上判断防止数据为负数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Update(&quot;update miaosha_goods set stock_count = stock_count-1 where goods_id = #&#123;goodsId&#125; and stock_count &gt; 0&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reduceStock</span><span class="params">(MiaoshaGoods g)</span></span>;</span><br></pre></td></tr></table></figure>
<p>第二个用户秒杀失败减库存失败但是仍然执行了下订单操作，会不会显示成功，因为执行reduceStock虽然库存为0，但语句本身不执行不代表异常，不会抛出异常，所以需要对减库存失败进一步判断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> OrderInfo <span class="title">miaosha</span><span class="params">(MiaoshaUser user, GoodsVo goods)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//减库存</span></span><br><span class="line">       <span class="keyword">boolean</span> success = goodsService.reduceStock(goods);</span><br><span class="line">       <span class="comment">//生成订单</span></span><br><span class="line">       <span class="keyword">if</span> (success)&#123;</span><br><span class="line">           <span class="keyword">return</span> orderService.createOrder(user,goods);</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           setGoodsOver(goods.getId());</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>秒杀一个用户只能买一个商品，但是如果同一用户发出了两个请求，两个请求同时到达减库存，会导致同一用户重复购买，解决办法是在miaosha_order表上建立唯一索引u_uid_gid，字段为user_id，goods_id，也就是说不允许出现具有索引值相同的行，也就避免同一用户-商品的重复出现。</li>
</ol>
<h2 id="5-3-静态资源优化"><a href="#5-3-静态资源优化" class="headerlink" title="5.3 静态资源优化"></a>5.3 静态资源优化</h2><ol>
<li>JS/CSS压缩，减少流量，比如使用jquery.min.js</li>
<li>多个JS/CSS组合，减少连接数</li>
<li>CDN就近访问</li>
</ol>
<h1 id="6-接口优化"><a href="#6-接口优化" class="headerlink" title="6. 接口优化"></a>6. 接口优化</h1><h2 id="6-1-Redis预减库存减少数据库访问"><a href="#6-1-Redis预减库存减少数据库访问" class="headerlink" title="6.1 Redis预减库存减少数据库访问"></a>6.1 Redis预减库存减少数据库访问</h2><p>由于Mysql数据库抗并发能力是瓶颈，进一步优化的方案是减少数据库访问：</p>
<ol>
<li>系统初始化，把商品库存数量加载到Redis</li>
</ol>
<p>使MiaoshaController实现InitializingBean接口，该接口需要实现afterPropertiesSet()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 系统初始化</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();</span><br><span class="line">        <span class="keyword">if</span> (goodsList == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (GoodsVo goods : goodsList) &#123;</span><br><span class="line">            redisService.set(GoodsKey.getMiaoshaGoodsStock,<span class="string">&quot;&quot;</span>+goods.getId(),goods.getStockCount());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>收到请求，Redis预减库存，库存不足，直接返回，否则进入3（不符合条件的请求止步于redis，不会再访问mysql）</li>
<li>请求入队，立即返回排队中</li>
</ol>
<p>改写原来的miaosha()逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/do_miaosha&quot;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title">miaosha</span><span class="params">(Model model, MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span></span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//预减库存（先从redis减去库存）</span></span><br><span class="line">        <span class="keyword">long</span> stock = redisService.decr(GoodsKey.getMiaoshaGoodsStock,<span class="string">&quot;&quot;</span>+goodsId);</span><br><span class="line">        <span class="keyword">if</span> (stock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否已经秒杀到了</span></span><br><span class="line">        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(user.getId(),goodsId);</span><br><span class="line">        <span class="keyword">if</span> (order != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.REPEATE_MIAOSHA);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//入队</span></span><br><span class="line">        MiaoshaMessage mm = <span class="keyword">new</span> MiaoshaMessage();</span><br><span class="line">        mm.setGoodsId(goodsId);</span><br><span class="line">        mm.setUser(user);</span><br><span class="line">        mqSender.sendMiaoshaMessage(mm);</span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="number">0</span>);<span class="comment">//排队中</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>编写发送信息MQ.sender.sendMiaoshaMessage()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(MQSender.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AmqpTemplate amqpTemplate ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMiaoshaMessage</span><span class="params">(MiaoshaMessage mm)</span> </span>&#123;</span><br><span class="line">        String msg = RedisService.beanToString(mm);</span><br><span class="line">        log.info(<span class="string">&quot;send message:&quot;</span>+msg);</span><br><span class="line">        amqpTemplate.convertAndSend(MQConfig.MIAOSHA_QUEUE, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>请求出队，生成订单，减少库存</li>
</ol>
<p>编写消息监听MQReceiver:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQReceiver</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(MQReceiver.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisService redisService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MiaoshaService miaoshaService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues=MQConfig.MIAOSHA_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;receive message:&quot;</span>+message);</span><br><span class="line">        MiaoshaMessage mm  = RedisService.stringToBean(message, MiaoshaMessage.class);</span><br><span class="line">        MiaoshaUser user = mm.getUser();</span><br><span class="line">        <span class="keyword">long</span> goodsId = mm.getGoodsId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断库存</span></span><br><span class="line">        GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">        <span class="keyword">int</span> stock = goods.getStockCount();</span><br><span class="line">        <span class="keyword">if</span>(stock &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否已经秒杀到了</span></span><br><span class="line">        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(user.getId(), goodsId);</span><br><span class="line">        <span class="keyword">if</span>(order != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//减库存 下订单 写入秒杀订单</span></span><br><span class="line">        miaoshaService.miaosha(user, goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>客户端轮询，是否秒杀成功</li>
</ol>
<p>在MiaoshaController编写miaoshaResult用于客户端轮询返回秒杀结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * orderId:成功</span></span><br><span class="line"><span class="comment">     * -1：秒杀失败</span></span><br><span class="line"><span class="comment">     * 0：排队中</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/result&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title">miaoshaResult</span><span class="params">(Model model, MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> result = miaoshaService.getMiaoshaResult(user.getId(),goodsId);</span><br><span class="line">        <span class="keyword">return</span> Result.success(result);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>MiaoshaService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回秒杀结果</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getMiaoshaResult</span><span class="params">(Long userId, <span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">        MiaoshaOrder order = orderService.getMiaoshaOrderByUserIdAndGoodsId(userId, goodsId);</span><br><span class="line">        <span class="comment">//秒杀成功</span></span><br><span class="line">        <span class="keyword">if</span> (order != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> order.getOrderId();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> isOver = getGoodsOver(goodsId);</span><br><span class="line">            <span class="keyword">if</span> (isOver)&#123;</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存入库存状态信息</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setGoodsOver</span><span class="params">(Long goodsId)</span> </span>&#123;</span><br><span class="line">        redisService.set(MiaoshaKey.isGoodsOver,<span class="string">&quot;&quot;</span>+goodsId,<span class="keyword">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回库存状态信息</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">getGoodsOver</span><span class="params">(<span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisService.exists(MiaoshaKey.isGoodsOver,<span class="string">&quot;&quot;</span>+goodsId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-内存标记减少Redis访问"><a href="#6-2-内存标记减少Redis访问" class="headerlink" title="6.2 内存标记减少Redis访问"></a>6.2 内存标记减少Redis访问</h2><p>在MiaoshaController中预减库存需要访问redis。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//预减库存</span></span><br><span class="line"><span class="keyword">long</span> stock = redisService.decr(GoodsKey.getMiaoshaGoodsStock,<span class="string">&quot;&quot;</span>+goodsId);</span><br></pre></td></tr></table></figure>
<p>每个请求都要访问redis，虽然redis相比mysql快很多，但仍然有可以优化的空间。</p>
<p>建立</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;Long,Boolean&gt; localOverMap = <span class="keyword">new</span> HashMap&lt;Long,Boolean&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 系统初始化</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();</span><br><span class="line">        <span class="keyword">if</span> (goodsList == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (GoodsVo goods : goodsList) &#123;</span><br><span class="line">            redisService.set(GoodsKey.getMiaoshaGoodsStock,<span class="string">&quot;&quot;</span>+goods.getId(),goods.getStockCount());</span><br><span class="line">            <span class="comment">//初始化库存时标记置为false</span></span><br><span class="line">            localOverMap.put(goods.getId(),<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@RequestMapping(value = &quot;/do_miaosha&quot;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title">miaosha</span><span class="params">(Model model, MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span></span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//内存标记，减少redis访问</span></span><br><span class="line">        <span class="keyword">boolean</span> over = localOverMap.get(goodsId);</span><br><span class="line">        <span class="keyword">if</span> (over)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//预减库存</span></span><br><span class="line">        <span class="keyword">long</span> stock = redisService.decr(GoodsKey.getMiaoshaGoodsStock,<span class="string">&quot;&quot;</span>+goodsId);</span><br><span class="line">        <span class="keyword">if</span> (stock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//库存&lt;0标记置为true</span></span><br><span class="line">            localOverMap.put(goodsId,<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-3-Nginx水平扩展"><a href="#6-3-Nginx水平扩展" class="headerlink" title="6.3 Nginx水平扩展"></a>6.3 Nginx水平扩展</h2><p>​    nginx水平扩展是利用nginx的反向代理，一个域名配置多个解析ip，每次DNS解析请求来访问dns-server，会轮询返回这些ip。当nginx成为瓶颈的时候，只要增加服务器数量，新增nginx服务的部署，增加一个外网ip，就能扩展反向代理层的性能，做到理论上的无限高并发。</p>
<h1 id="7-安全优化"><a href="#7-安全优化" class="headerlink" title="7. 安全优化"></a>7. 安全优化</h1><h2 id="7-1-隐藏秒杀地址"><a href="#7-1-隐藏秒杀地址" class="headerlink" title="7.1 隐藏秒杀地址"></a>7.1 隐藏秒杀地址</h2><p>​        在秒杀开始之前，秒杀接口地址不要写到客户端，而是在秒杀开始之后，将秒杀地址动态地在客户端和服务器间进行交互完成拼接。这样一来，秒杀开始之前，秒杀地址对客户端不可见。</p>
<p><strong>实现思路：</strong></p>
<ul>
<li>秒杀开始之前，先去请求接口获取秒杀地址；</li>
<li>接口改造，带上<code>@pathVariable</code>参数；（MD5（UUID））</li>
<li>添加生成地址的接口；</li>
<li>秒杀收到请求，先验证<code>@pathVariable</code>参数。</li>
</ul>
<p><strong>注意：但是获取秒杀地址这个接口也有可能被恶意刷，可以使用验证码防刷。</strong></p>
<p>用户在提交获取秒杀地址的请求之前，需要将goodsId和verifyCode一同提交到服务端，服务器通过<code>@RequestParam</code>参数获取goodsId和verifyCode，然后检验验证码是否正确，如果正确，则返回秒杀地址给客户端，客户端得到秒杀地址后，拼接秒杀地址然后异步地向这个地址发出请求获取秒杀结果，这样就完成了秒杀接口地址的隐藏。</p>
<p>需要注意的是，这里需要将goodsId和verifyCode一同提交到服务端做校验，如果只提交goodsId，那么客户端仍然可以使用明文的方式获取随机生成的接口秒杀地址，但是，引入了verifyCode后，客户端需要将验证码也一起发送到服务端做验证，验证成功才返回随机生成的秒杀地址，不成功则返回非法请求，通过这样一种<strong>双重验证</strong>的方式，就可以方式用户使用不合理的手段参与秒杀，引入验证码有效地防止了这一点，因为验证码的输入需要用户真正参与进来。</p>
<ol>
<li><p>goods_detail.htm 商品详情页</p>
<p>​        修改“立即秒杀”按钮事件（秒杀时间到，才会显示立即秒杀按钮），先获取秒杀地址，再发起秒杀，后面还会加入校验图形验证码。</p>
<p>原来点击立即秒杀会执行miaosha()方法，现在修改为getMiaoshaPath():</p>
</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary btn-block&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;buyButton&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;getMiaoshaPath()&quot;</span>&gt;</span>立即秒杀<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMiaoshaPath</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> goodsId = $(<span class="string">&quot;#goodsId&quot;</span>).val();</span><br><span class="line">        g_showLoading();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">&quot;/miaosha/path&quot;</span>,</span><br><span class="line">            type: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            data: &#123;</span><br><span class="line">                goodsId: $(<span class="string">&quot;#goodsId&quot;</span>).val(),</span><br><span class="line">                verifyCode: $(<span class="string">&quot;#verifyCode&quot;</span>).val()</span><br><span class="line">            &#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (data.code == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = data.data;</span><br><span class="line">                    <span class="comment">//获取路径成功执行doMiaosha()</span></span><br><span class="line">                    doMiaosha(path);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    layer.msg(data.msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                layer.msg(<span class="string">&quot;客户端请求有误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>获取到秒杀地址后，才往下执行真正的秒杀操作，并把path 拼接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doMiaosha</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">&quot;/miaosha/&quot;</span>+path+<span class="string">&quot;/do_miaosha&quot;</span>,</span><br><span class="line">            type: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            data: &#123;</span><br><span class="line">                goodsId: $(<span class="string">&quot;#goodsId&quot;</span>).val(),</span><br><span class="line">            &#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (data.code == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// window.location.href=&quot;/order_detail.htm?orderId=&quot;+data.data.id;</span></span><br><span class="line">                    getMiaoshaResult($(<span class="string">&quot;#goodsId&quot;</span>).val());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    layer.msg(data.msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                layer.msg(<span class="string">&quot;客户端请求有误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>在后端新增获取秒杀接口地址</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取秒杀接口地址</span></span><br><span class="line"><span class="comment">   * */</span></span><br><span class="line">   <span class="meta">@RequestMapping()</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">getMiaoshaPath</span><span class="params">(HttpServletRequest request,MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="keyword">int</span> verifyCode</span></span></span><br><span class="line"><span class="function"><span class="params">           )</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">boolean</span> check = miaoshaService.checkVerifyCode(user,goodsId,verifyCode);</span><br><span class="line">       <span class="keyword">if</span> (!check)&#123;</span><br><span class="line">           <span class="keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);</span><br><span class="line">       &#125;</span><br><span class="line">       String path = miaoshaService.createMiaoshaPath(user,goodsId);</span><br><span class="line">       <span class="keyword">return</span> Result.success(path);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>createMiaoshaPath():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">createMiaoshaPath</span><span class="params">(MiaoshaUser user, <span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span> || goodsId &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//通过uuid生成并MD5加密，123456为固定盐值</span></span><br><span class="line">        String str = MD5Util.md5(UUIDUtil.uuid()+<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//key根据用户id和商品id 生成，所以每个用户获取到的秒杀地址不一样</span></span><br><span class="line">        redisService.set(MiaoshaKey.getMiaoshaPath,<span class="string">&quot;&quot;</span>+user.getId()+<span class="string">&quot;_&quot;</span>+goodsId,str);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>得到秒杀地址进行请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/&#123;path&#125;/do_miaosha&quot;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title">miaosha</span><span class="params">(Model model, MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="meta">@PathVariable(&quot;path&quot;)</span>String path)</span></span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证path</span></span><br><span class="line">        <span class="keyword">boolean</span> check = miaoshaService.checkPath(user,goodsId,path);</span><br><span class="line">        <span class="keyword">if</span> (!check)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>checkPath():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPath</span><span class="params">(MiaoshaUser user, <span class="keyword">long</span> goodsId, String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span> || path == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String pathOld = redisService.get(MiaoshaKey.getMiaoshaPath,<span class="string">&quot;&quot;</span>+user.getId()+<span class="string">&quot;_&quot;</span>+goodsId,String.class);</span><br><span class="line">        <span class="keyword">return</span> path.equals(pathOld);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-2-数学公式验证码"><a href="#7-2-数学公式验证码" class="headerlink" title="7.2 数学公式验证码"></a>7.2 数学公式验证码</h2><p><strong>验证码的作用：</strong></p>
<ul>
<li>防止利用机器人等手段防止非目标用户参与秒杀；</li>
<li>减少单位时间内的请求数量。对于一个秒杀商品，在开始秒杀后肯定会有许多用户参与秒杀，那么在开始秒杀的时候，用户请求数量是巨大，从而对服务器产生较大的压力，而通过验证码的方式就可以有效地将集中式的请求分散，从而达到<strong>削减请求峰值</strong>的目的。</li>
</ul>
<p><strong>实现思路：</strong></p>
<p>在服务端计算出验证码的表达式的值，存储在服务端，客户端输入验证码的表达式值，传入服务端进行验证。</p>
<ul>
<li>点击秒杀之前，向让用户输入验证码，分散用户的请求；</li>
<li>添加生成验证码的接口；</li>
<li>在获取秒杀路径的时候，验证验证码；</li>
<li>ScriptEngine的使用（用于计算验证码上的表达式）。</li>
</ul>
<p>当秒杀未开始时，商品详情页异步地向服务端发出获取商品详细信息的请求，同时，获取验证码。服务端收到获取验证码的请求后，生成验证码返回给客户端，同时，将验证码的结果存储再redis中，以便客户端发起秒杀请求时做验证码的校验。</p>
<p>比如：1秒钟进来10万个请求，与10秒钟进来10万个请求，差别很大。</p>
<ol>
<li>goods_detail.htm 商品详情</li>
</ol>
<p>添加图形验证码和输入框元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;row&quot;</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;form-inline&quot;</span>&gt;</span><br><span class="line">        &lt;img id=<span class="string">&quot;verifyCodeImg&quot;</span> width=<span class="string">&quot;80&quot;</span> height=<span class="string">&quot;32&quot;</span> style=<span class="string">&quot;display: none&quot;</span> onclick=<span class="string">&quot;refreshVerifyCode()&quot;</span>/&gt;</span><br><span class="line">        &lt;input id=<span class="string">&quot;verifyCode&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;form-control&quot;</span> style=<span class="string">&quot;display: none&quot;</span>/&gt;</span><br><span class="line">        &lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;btn btn-primary btn-block&quot;</span> type=<span class="string">&quot;button&quot;</span> id=<span class="string">&quot;buyButton&quot;</span></span><br><span class="line">        onclick=<span class="string">&quot;getMiaoshaPath()&quot;</span>&gt;立即秒杀</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//点击图片会刷新验证码，为防止浏览器缓存，需要在url添加一个时间戳</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">refreshVerifyCode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&quot;#verifyCodeImg&quot;</span>).attr(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;/miaosha/verifyCode?	goodsId=&quot;</span>+$(<span class="string">&quot;#goodsId&quot;</span>).val()+<span class="string">&quot;&amp;timestamp=&quot;</span>+<span class="keyword">new</span> <span class="built_in">Date</span>().getTime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>获取验证码js</p>
<p>获取商品详情的ajax ，渲染页面时，有个倒计时判断，在秒杀进行中增加显示验证码，在秒杀结束时隐藏验证码。</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">countDown</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> remainSeconds = $(<span class="string">&quot;#remainSeconds&quot;</span>).val();</span><br><span class="line">        <span class="keyword">var</span> timeout;</span><br><span class="line">        <span class="keyword">if</span> (remainSeconds &gt; <span class="number">0</span>) &#123;<span class="comment">//秒杀还没开始，倒计时</span></span><br><span class="line">            $(<span class="string">&quot;#buyButton&quot;</span>).attr(<span class="string">&quot;disabled&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            $(<span class="string">&quot;#miaoshaTip&quot;</span>).html(<span class="string">&quot;秒杀倒计时：&quot;</span> + remainSeconds + <span class="string">&quot;秒&quot;</span>);</span><br><span class="line">            timeout = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                $(<span class="string">&quot;#countDown&quot;</span>).text(remainSeconds - <span class="number">1</span>);</span><br><span class="line">                $(<span class="string">&quot;#remainSeconds&quot;</span>).val(remainSeconds - <span class="number">1</span>);</span><br><span class="line">                countDown();</span><br><span class="line">            &#125;, <span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (remainSeconds == <span class="number">0</span>) &#123;<span class="comment">//秒杀进行中</span></span><br><span class="line">            $(<span class="string">&quot;#buyButton&quot;</span>).attr(<span class="string">&quot;disabled&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">            &#125;</span><br><span class="line">            $(<span class="string">&quot;#miaoshaTip&quot;</span>).html(<span class="string">&quot;秒杀进行中&quot;</span>);</span><br><span class="line">            <span class="comment">//显示图片</span></span><br><span class="line">            $(<span class="string">&quot;#verifyCodeImg&quot;</span>).attr(<span class="string">&quot;src&quot;</span>, <span class="string">&quot;/miaosha/verifyCode?goodsId=&quot;</span>+$(<span class="string">&quot;#goodsId&quot;</span>).val());</span><br><span class="line">            $(<span class="string">&quot;#verifyCodeImg&quot;</span>).show();</span><br><span class="line">            <span class="comment">//显示验证码图片和输入框</span></span><br><span class="line">            $(<span class="string">&quot;#verifyCode&quot;</span>).show();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//秒杀已经结束</span></span><br><span class="line">            $(<span class="string">&quot;#buyButton&quot;</span>).attr(<span class="string">&quot;disabled&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            $(<span class="string">&quot;#miaoshaTip&quot;</span>).html(<span class="string">&quot;秒杀已经结束&quot;</span>);</span><br><span class="line">             <span class="comment">//隐藏验证码图片和输入框</span></span><br><span class="line">            $(<span class="string">&quot;#verifyCodeImg&quot;</span>).hide();</span><br><span class="line">            $(<span class="string">&quot;#verifyCode&quot;</span>).hide();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>新增获取图形验证码接口</li>
</ol>
<p>使用 jdk 自带的一个 BufferedImage，使用OutputStream 输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取图形验证码</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/verifyCode&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">getMiaoshaVerifyCode</span><span class="params">(HttpServletResponse response, MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedImage image = miaoshaService.createVerifyCode(user,goodsId);</span><br><span class="line">            <span class="comment">//通过response返回</span></span><br><span class="line">            OutputStream out = response.getOutputStream();</span><br><span class="line">            ImageIO.write(image,<span class="string">&quot;JPEG&quot;</span>,out);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.MIAOSHA_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>创建图形验证码逻辑</li>
</ol>
<p>先构建一个图（长、宽、格式），再分别设置颜色、背景等；</p>
<p>再生成一个加减乘除的表达式，并设置到图形中，最后计算表达式的值并设置到redis缓存中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成验证码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BufferedImage <span class="title">createVerifyCode</span><span class="params">(MiaoshaUser user, <span class="keyword">long</span> goodsId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span> || goodsId &lt;=<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> width = <span class="number">80</span>;</span><br><span class="line">        <span class="keyword">int</span> height = <span class="number">32</span>;</span><br><span class="line">        <span class="comment">//create the image</span></span><br><span class="line">        BufferedImage image = <span class="keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        Graphics g = image.getGraphics();</span><br><span class="line">        <span class="comment">// set the background color</span></span><br><span class="line">        g.setColor(<span class="keyword">new</span> Color(<span class="number">0xDCDCDC</span>));</span><br><span class="line">        g.fillRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">        <span class="comment">// draw the border</span></span><br><span class="line">        g.setColor(Color.black);</span><br><span class="line">        g.drawRect(<span class="number">0</span>, <span class="number">0</span>, width - <span class="number">1</span>, height - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// create a random instance to generate the codes</span></span><br><span class="line">        Random rdm = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="comment">// make some confusion</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> x = rdm.nextInt(width);</span><br><span class="line">            <span class="keyword">int</span> y = rdm.nextInt(height);</span><br><span class="line">            g.drawOval(x, y, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// generate a random code</span></span><br><span class="line">        String verifyCode = generateVerifyCode(rdm);</span><br><span class="line">        g.setColor(<span class="keyword">new</span> Color(<span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>));</span><br><span class="line">        g.setFont(<span class="keyword">new</span> Font(<span class="string">&quot;Candara&quot;</span>, Font.BOLD, <span class="number">24</span>));</span><br><span class="line">        g.drawString(verifyCode, <span class="number">8</span>, <span class="number">24</span>);</span><br><span class="line">        g.dispose();</span><br><span class="line">        <span class="comment">//把验证码存到redis中</span></span><br><span class="line">        <span class="keyword">int</span> rnd = calc(verifyCode);</span><br><span class="line">        redisService.set(MiaoshaKey.getMiaoshaVerifyCode, user.getId()+<span class="string">&quot;,&quot;</span>+goodsId, rnd);</span><br><span class="line">        <span class="comment">//输出图片</span></span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//js计算验证码</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calc</span><span class="params">(String exp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ScriptEngineManager manager = <span class="keyword">new</span> ScriptEngineManager();</span><br><span class="line">            ScriptEngine engine = manager.getEngineByName(<span class="string">&quot;JavaScript&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (Integer)engine.eval(exp);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">char</span>[] ops = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123;<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;*&#x27;</span>&#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加减乘的公式</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">generateVerifyCode</span><span class="params">(Random rdm)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> num1 = rdm.nextInt(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">int</span> num2 = rdm.nextInt(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">int</span> num3 = rdm.nextInt(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">char</span> op1 = ops[rdm.nextInt(<span class="number">3</span>)];</span><br><span class="line">        <span class="keyword">char</span> op2 = ops[rdm.nextInt(<span class="number">3</span>)];</span><br><span class="line">        String exp = <span class="string">&quot;&quot;</span>+ num1 + op1 + num2 + op2 + num3;</span><br><span class="line">        <span class="keyword">return</span> exp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>校验</p>
<p>a. 获取秒杀地址ajax,增加用户输入的计算好的验证码参数，因为用户点击“立即秒杀”，需要先去获取秒杀地址，才会往下执行真正的秒杀操作。顺序：验证码 —&gt; 秒杀地址  —&gt; 秒杀  （在获取秒杀地址接口中，校验验证码）</p>
<p>b.     获取秒杀地址，校验验证码的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取秒杀接口地址</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/path&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">getMiaoshaPath</span><span class="params">(HttpServletRequest request,MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="keyword">int</span> verifyCode</span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检验校验码</span></span><br><span class="line">        <span class="keyword">boolean</span> check = miaoshaService.checkVerifyCode(user,goodsId,verifyCode);</span><br><span class="line">        <span class="keyword">if</span> (!check)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);</span><br><span class="line">        &#125;</span><br><span class="line">        String path = miaoshaService.createMiaoshaPath(user,goodsId);</span><br><span class="line">        <span class="keyword">return</span> Result.success(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 校验方法</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkVerifyCode</span><span class="params">(MiaoshaUser user, <span class="keyword">long</span> goodsId, <span class="keyword">int</span> verifyCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span> || goodsId &lt;=<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Integer codeOld = redisService.get(MiaoshaKey.getMiaoshaVerifyCode, user.getId()+<span class="string">&quot;,&quot;</span>+goodsId, Integer.class);</span><br><span class="line">        <span class="keyword">if</span>(codeOld == <span class="keyword">null</span> || codeOld - verifyCode != <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        redisService.delete(MiaoshaKey.getMiaoshaVerifyCode, user.getId()+<span class="string">&quot;,&quot;</span>+goodsId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="7-3-接口限流防刷"><a href="#7-3-接口限流防刷" class="headerlink" title="7.3 接口限流防刷"></a>7.3 接口限流防刷</h2><p><strong>接口限流作用</strong></p>
<ul>
<li>对用户的访问进行一定的限制，就可以减轻服务器压力。例如通过访问次数的限制就是一种限流防刷的手段。即限制用户下一定的时间间隔内对接口的访问次数。</li>
</ul>
<p><strong>实现思路</strong></p>
<ul>
<li><p>如果使用计时器来做这个功能，实现起来比较复杂。可以充分利用<strong>redis</strong>中的key-value过期机制来完成。</p>
</li>
<li><p>在redis中存储一个用于记录访问次数的变量，在过期时间内被继续访问，则次数变量加1，如果在过期时间内访问次数超出限制，则返回“频繁提交提示用户”。过期时间到了之后，将该变量删除。</p>
</li>
<li><p>因为可能需要对很多接口对限流防刷操作，如果对每一个接口都实现一遍限流防刷，则会导致代码过度冗余，因此，可以定义一个方法拦截器<code>@AccessInterceptor</code>拦截用户对接口的请求，统一对拦截限流逻辑处理，这样可以有效地减少代码的冗余。针对需要拦截请求的接口，添加注解<code>@AccessLimit</code>即可。</p>
</li>
</ul>
<p>在获取秒杀地址接口中增加限制，位于校验验证码之前每次访问加1，超过5次返回“操作台频繁”</p>
<p>设置到redis,key : 当前获取秒杀地址请求的url + 用户id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取秒杀接口地址</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/path&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">getMiaoshaPath</span><span class="params">(HttpServletRequest request,MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="keyword">int</span> verifyCode</span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查询访问次数</span></span><br><span class="line">        String uri = request.getRequestURI();</span><br><span class="line">        String key = uri + <span class="string">&quot;_&quot;</span> +user.getId();</span><br><span class="line">        Interget count = redisService.get(AccressKey.access,key,Integer.class);</span><br><span class="line">        <span class="keyword">if</span>(count == <span class="keyword">null</span>)&#123;</span><br><span class="line">        	redisService.set(AccressKey.access,key,<span class="number">1</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(count &lt; <span class="number">5</span>)&#123;</span><br><span class="line">        	redisService.incrAccressKey.access,key);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        	Result.error(CodeMsg.ACCESS_LIMIT_REACHED);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span> check = miaoshaService.checkVerifyCode(user,goodsId,verifyCode);</span><br><span class="line">        <span class="keyword">if</span> (!check)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(CodeMsg.REQUEST_ILLEGAL);</span><br><span class="line">        &#125;</span><br><span class="line">        String path = miaoshaService.createMiaoshaPath(user,goodsId);</span><br><span class="line">        <span class="keyword">return</span> Result.success(path);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>​        如果秒杀接口、获取秒杀结果接口等也要限制，每个方法都要写这样的逻辑，所以需要写一个通用的方法，比如注解+拦截器。</p>
<ol>
<li>直接在controller方法上加注解即可：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取秒杀接口地址</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="meta">@AccessLimit(seconds = 5,maxCount = 5,needLogin = true)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/path&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">getMiaoshaPath</span><span class="params">(HttpServletRequest request,MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="meta">@RequestParam(&quot;goodsId&quot;)</span><span class="keyword">long</span> goodsId,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="meta">@RequestParam(value = &quot;verifyCode&quot;,defaultValue = &quot;0&quot;)</span><span class="keyword">int</span> verifyCode</span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>新建AccessLimit 限流注解</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AccessLimit &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">seconds</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxCount</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">needLogin</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>新增拦截器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessInterceptor</span>  <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	MiaoshaUserService userService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	RedisService redisService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(handler <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">			MiaoshaUser user = getUser(request, response);</span><br><span class="line">			UserContext.setUser(user);</span><br><span class="line">			HandlerMethod hm = (HandlerMethod)handler;</span><br><span class="line">			AccessLimit accessLimit = hm.getMethodAnnotation(AccessLimit.class);</span><br><span class="line">			<span class="keyword">if</span>(accessLimit == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">int</span> seconds = accessLimit.seconds();</span><br><span class="line">			<span class="keyword">int</span> maxCount = accessLimit.maxCount();</span><br><span class="line">			<span class="keyword">boolean</span> needLogin = accessLimit.needLogin();</span><br><span class="line">			String key = request.getRequestURI();</span><br><span class="line">			<span class="keyword">if</span>(needLogin) &#123;</span><br><span class="line">				<span class="keyword">if</span>(user == <span class="keyword">null</span>) &#123;</span><br><span class="line">					render(response, CodeMsg.SESSION_ERROR);</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				key += <span class="string">&quot;_&quot;</span> + user.getId();</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//do nothing</span></span><br><span class="line">			&#125;</span><br><span class="line">			AccessKey ak = AccessKey.withExpire(seconds);</span><br><span class="line">			Integer count = redisService.get(ak, key, Integer.class);</span><br><span class="line">	    	<span class="keyword">if</span>(count  == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    		 redisService.set(ak, key, <span class="number">1</span>);</span><br><span class="line">	    	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(count &lt; maxCount) &#123;</span><br><span class="line">	    		 redisService.incr(ak, key);</span><br><span class="line">	    	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">	    		render(response, CodeMsg.ACCESS_LIMIT_REACHED);</span><br><span class="line">	    		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	    	&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//限流提醒</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(HttpServletResponse response, CodeMsg cm)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">		OutputStream out = response.getOutputStream();</span><br><span class="line">		String str  = JSON.toJSONString(Result.error(cm));</span><br><span class="line">		out.write(str.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">		out.flush();</span><br><span class="line">		out.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getUser()和getCookieValue()从之前的拦截器拷贝得来</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> MiaoshaUser <span class="title">getUser</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">		String paramToken = request.getParameter(MiaoshaUserService.COOKIE_NAME_TOKEN);</span><br><span class="line">		String cookieToken = getCookieValue(request, MiaoshaUserService.COOKIE_NAME_TOKEN);</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isEmpty(cookieToken) &amp;&amp; StringUtils.isEmpty(paramToken)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		String token = StringUtils.isEmpty(paramToken)?cookieToken:paramToken;</span><br><span class="line">		<span class="keyword">return</span> userService.getByToken(response, token);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getCookieValue</span><span class="params">(HttpServletRequest request, String cookiName)</span> </span>&#123;</span><br><span class="line">		Cookie[]  cookies = request.getCookies();</span><br><span class="line">		<span class="keyword">if</span>(cookies == <span class="keyword">null</span> || cookies.length &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(Cookie cookie : cookies) &#123;</span><br><span class="line">			<span class="keyword">if</span>(cookie.getName().equals(cookiName)) &#123;</span><br><span class="line">				<span class="keyword">return</span> cookie.getValue();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拦截器中使用了之前的拦截器UserArgumentResolver中的getUser()和getCookieValue()方法。但是这样就会有重复的代码，所以再次优化：</p>
<p>上面获取到MiaoshaUser对象之后，再设置到一个ThreadLocal 本地变量中（多线程）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;MiaoshaUser&gt; userHolder = <span class="keyword">new</span> ThreadLocal&lt;MiaoshaUser&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(MiaoshaUser user)</span></span>&#123;</span><br><span class="line">        userHolder.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MiaoshaUser <span class="title">getUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前的UserArgumentResolver 则直接调用UserContext.getUser即可</p>
<ol>
<li>注册拦截器</li>
</ol>
<p>在WebConfig中注册拦截器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">	registry.addInterceptor(accessInterceptor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">醉心</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lishuaiyun.cn/2021/01/28/Java%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/">http://lishuaiyun.cn/2021/01/28/Java%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lishuaiyun.cn" target="_blank">FreeThinking's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a><a class="post-meta__tags" href="/tags/%E7%A7%92%E6%9D%80/">秒杀</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2021/02/02/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">二叉树遍历方法总结</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">醉心</div><div class="author-info__description">追求所有的未知并永远保持探索的热情</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/FreeThinking01"><i class="fab fa-github"></i><span>github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/FreeThinking01" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:besokuse8@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">随缘更新，技术&读书感悟&生活感悟&日常</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">1. 项目框架搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E9%85%8D%E7%BD%AESpringBoot"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 配置SpringBoot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E9%85%8D%E7%BD%AEMybatis"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 配置Mybatis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E9%85%8D%E7%BD%AERedis"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 配置Redis</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-number">2.</span> <span class="toc-text">2. 实现登录功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 数据库设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%AF%86%E7%A0%81%E4%B8%A4%E6%AC%A1MD5%E5%A4%84%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 密码两次MD5处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-JSR303%E5%8F%82%E6%95%B0%E6%A3%80%E9%AA%8C-%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 JSR303参数检验+全局异常处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-JSR303%E5%8F%82%E6%95%B0%E6%A3%80%E9%AA%8C"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 JSR303参数检验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 全局异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%88%86%E5%B8%83%E5%BC%8FSession"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 分布式Session</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E5%8A%9F%E8%83%BD"><span class="toc-number">3.</span> <span class="toc-text">3. 实现秒杀功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 数据库设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-%E5%95%86%E5%93%81%E8%A1%A8"><span class="toc-number">3.1.1.</span> <span class="toc-text">3.1.1 商品表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E8%AE%A2%E5%8D%95%E8%A1%A8"><span class="toc-number">3.1.2.</span> <span class="toc-text">3.1.2 订单表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E8%A1%A8"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.1.3 秒杀商品表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-4-%E7%A7%92%E6%9D%80%E8%AE%A2%E5%8D%95%E8%A1%A8"><span class="toc-number">3.1.4.</span> <span class="toc-text">3.1.4 秒杀订单表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8%E9%A1%B5"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 商品列表页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 商品详情页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 订单详情页</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-JMeter%E5%8E%8B%E6%B5%8B"><span class="toc-number">4.</span> <span class="toc-text">4. JMeter压测</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-JMeter%E5%85%A5%E9%97%A8"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 JMeter入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F%E6%A8%A1%E6%8B%9F%E5%A4%9A%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 自定义变量模拟多用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-JMeter%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 JMeter命令行使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Redis%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7redis-benchmark"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 Redis压测工具redis-benchmark</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-SpringBoot%E6%89%93war%E5%8C%85"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 SpringBoot打war包</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E9%A1%B5%E9%9D%A2%E4%BC%98%E5%8C%96%E6%8A%80%E6%9C%AF"><span class="toc-number">5.</span> <span class="toc-text">5. 页面优化技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98-URL%E7%BC%93%E5%AD%98-%E5%AF%B9%E8%B1%A1%E7%BC%93%E5%AD%98"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 页面缓存+URL缓存+对象缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98"><span class="toc-number">5.1.1.</span> <span class="toc-text">5.1.1页面缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-URL%E7%BC%93%E5%AD%98"><span class="toc-number">5.1.2.</span> <span class="toc-text">5.1.2 URL缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-%E5%AF%B9%E8%B1%A1%E7%BC%93%E5%AD%98"><span class="toc-number">5.1.3.</span> <span class="toc-text">5.1.3 对象缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96%EF%BC%8C%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 页面静态化，前后端分离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 商品详情页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 订单详情页</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 静态资源优化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%8E%A5%E5%8F%A3%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">6. 接口优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-Redis%E9%A2%84%E5%87%8F%E5%BA%93%E5%AD%98%E5%87%8F%E5%B0%91%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 Redis预减库存减少数据库访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%86%85%E5%AD%98%E6%A0%87%E8%AE%B0%E5%87%8F%E5%B0%91Redis%E8%AE%BF%E9%97%AE"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 内存标记减少Redis访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-Nginx%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 Nginx水平扩展</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%AE%89%E5%85%A8%E4%BC%98%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">7. 安全优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E9%9A%90%E8%97%8F%E7%A7%92%E6%9D%80%E5%9C%B0%E5%9D%80"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 隐藏秒杀地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 数学公式验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81%E9%98%B2%E5%88%B7"><span class="toc-number">7.3.</span> <span class="toc-text">7.3 接口限流防刷</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/01/13/%E6%96%B0%E6%91%84%E5%BD%B1%E7%AC%94%E8%AE%B0/" title="新摄影笔记"><img src="/img/%E6%96%B0%E6%91%84%E5%BD%B1%E7%AC%94%E8%AE%B0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="新摄影笔记"/></a><div class="content"><a class="title" href="/2024/01/13/%E6%96%B0%E6%91%84%E5%BD%B1%E7%AC%94%E8%AE%B0/" title="新摄影笔记">新摄影笔记</a><time datetime="2024-01-13T13:05:21.000Z" title="发表于 2024-01-13 21:05:21">2024-01-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/07/%E4%B8%BB%E5%8A%A8%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97/" title="主动基金投资指南"><img src="/img/%E4%B8%BB%E5%8A%A8%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="主动基金投资指南"/></a><div class="content"><a class="title" href="/2023/08/07/%E4%B8%BB%E5%8A%A8%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97/" title="主动基金投资指南">主动基金投资指南</a><time datetime="2023-08-07T09:39:51.000Z" title="发表于 2023-08-07 17:39:51">2023-08-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/05/%E4%B9%A1%E5%9C%9F%E4%B8%AD%E5%9B%BD/" title="乡土中国"><img src="/img/%E4%B9%A1%E5%9C%9F%E4%B8%AD%E5%9B%BD.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="乡土中国"/></a><div class="content"><a class="title" href="/2023/08/05/%E4%B9%A1%E5%9C%9F%E4%B8%AD%E5%9B%BD/" title="乡土中国">乡土中国</a><time datetime="2023-08-05T14:28:45.000Z" title="发表于 2023-08-05 22:28:45">2023-08-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/03/%E7%BB%8F%E6%B5%8E%E6%9C%BA%E5%99%A8%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84/" title="经济机器是怎样运行的"><img src="/img/%E7%BB%8F%E6%B5%8E%E6%9C%BA%E5%99%A8%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="经济机器是怎样运行的"/></a><div class="content"><a class="title" href="/2023/05/03/%E7%BB%8F%E6%B5%8E%E6%9C%BA%E5%99%A8%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84/" title="经济机器是怎样运行的">经济机器是怎样运行的</a><time datetime="2023-05-03T13:24:02.000Z" title="发表于 2023-05-03 21:24:02">2023-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/30/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" title="2022年终总结"><img src="/img/2022.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2022年终总结"/></a><div class="content"><a class="title" href="/2023/04/30/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" title="2022年终总结">2022年终总结</a><time datetime="2023-04-30T12:24:49.000Z" title="发表于 2023-04-30 20:24:49">2023-04-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 醉心</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '938337943808aebf8bed',
      clientSecret: '3f0e2cef6932e0c22ba3b40fe9f9b316fa330557',
      repo: 'FreeThinking01.github.io',
      owner: 'FreeThinking01',
      admin: ['FreeThinking01'],
      id: '7f55b37931c29f4ae8b9a0ffe9e98de6',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>